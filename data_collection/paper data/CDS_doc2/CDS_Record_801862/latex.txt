# The ATLAS Local Trigger Processor (LTP)

P. Borrego Amaral\({}^{\text{a}}\), N. Ellis\({}^{\text{a}}\), P. Farthouat\({}^{\text{a}}\), P. Gallno\({}^{\text{a}}\), H. Pessoa Lima Junior\({}^{\text{b}}\), T. Maeno\({}^{\text{a}}\),

I. Resurreccion Arcas\({}^{\text{a}}\), J. M. de Seixas\({}^{\text{b}}\), G. Schuler\({}^{\text{a}}\), R. Spiwoks\({}^{\text{a}}\), R. Torga Teixeira\({}^{\text{a}}\), T. Wengler\({}^{\text{a}}\)

\({}^{\text{a}}\)) CERN, b) University Rio de Janeiro

Manuscript received October 18, 2004.

###### Abstract

The Local Trigger Processor (LTP) receives timing and trigger signals from the Central Trigger Processor (CTP) and injects them into the Timing, Trigger and Control (TTC) system of a sub-detector front-end TTC partition. The LTP allows stand-alone running by using local timing and trigger signals or by generating them from memory. In addition, several LTPs of the same sub-detector can be daisy-chained. The LTP can thus be regarded as a switching element for timing and trigger signals with input from the CTP or the daisy-chain, from local input, or from the internal data generator, and with output to the daisy-chain, to the TTC partition, or to local output. Finally, in combined mode several LTPs can be connected together using their local outputs and local inputs to allow stand-alone running of combinations of different sub-detectors.

## I Introduction

ATLAS is divided in about 40 partitions, each of them having its own TTC [3] network, controlled by its own TTCvi [4]. Each partition can run in two modes:

\({}^{\text{\tiny{$\bullet$}}}\) Global mode, where the TTC signals come from the CTP [1][2] and where the data are part of the main ATLAS run and read out through the main ATLAS central DAQ system;

\({}^{\text{\tiny{$\bullet$}}}\) Local mode, where the partition is run stand-alone with "private" TTC signals and where the data are kept separate from the main ATLAS run.

In both cases, the TTCvi must receive all the TTC signals and a way of handling the dead-time has to be foreseen. In addition, some mechanisms allowing special calibration sequences must be allowed.

### TTC partition root

An ATLAS TTC partition is driven by a set of 4 modules as shown in Fig. 1:

* the LTP;
* the TTCvi [4];
* the TTCxx (ex,vx or tx) [3];
* the ROD-Busy module [5].

The LTP interfaces the partition to the CTP when running in Global mode (i.e. under control of the CTP) and to the local trigger logic when running in Local mode.

The interface to the CTP is done through a differential link (CTP Link). As the number of TTC partitions in ATLAS is high (a bit less than 40), it is not affordable to have as many CTP Links. Only 20 links will be available, one link per sub-detector. Each CTP Link connects the CTP to all the LTPs of a given sub-detector (and only to these LTPs) using the daisy chain.

The TTCvi provides the A- and B-Channel signals to the TTCxx module which contains the encoder and the electrical-to-optical converter.

The ROD-Busy module gathers the Busy signals from the RODs attached to a partition to form an overall BUSY signal which will throttle the trigger source (either the CTP or some local trigger logic).

### Partition in a Global run

In normal running an ATLAS partition receives the TTC signals from the CTP through a set of interfaces as shown in Fig. 2 and detailed in Table 1.

Figure 1: A TTC partition rootThe CTP receives the BC and the ORBIT signals from the LHC machine. For each partition included in the main ATLAS run (global mode) the CTP delivers to the LTP the BC, ORBIT, L1A, Trigger-Type, ECR and pre-Pulse signals. It receives from each sub-detector a BUSY signal and a 3-bit calibration trigger request. Note that if a sub-detector contains more than one partition, the BUSY signal that is transmitted to the CTP on the CTP Link is the logical "OR" of the BUSY signals of these sub-detector partitions (see Fig. 3).

Two mechanisms are implemented for generating calibration triggers during physics runs: the Pre-Pulse signal provided by the CTP; and a 3-bit calibration request sent by a sub-detector to the CTP. During a physics run all L1A must be centrally issued by the CTP to avoid synchronisation problems. This is why even the calibration triggers have to be handled by the CTP.

In the first mechanism, the CTP issues the trigger at a known BCID during the LHC turn. In order for a sub-detector to make efficient use of such a trigger the CTP issues a Pre-Pulse signal a fixed number of BCs before the trigger will be issued. When receiving this signal a sub-detector can decide to perform a calibration sequence (e.g. firing a pulse generator) with a timing such that the L1A associated to this Pre-Pulse will be in phase with the calibration data.

In the second mechanism, the long gap at the end of the LHC turn can be used by sub-detectors to perform calibration sequences on request. In order to avoid problems (e.g. a calibration trigger for one sub-detector being masked by the dead-time introduced by a calibration trigger from another sub-detector), the long gaps are numbered modulo 16 and uniquely assigned to sub-detectors. The calibration requests from a given sub-detector will be taken into account by the CTP only if the gap is allocated to this sub-detector.

The timing (i.e. the BCID at which the L1A will be issued) can be done in two ways. Either the L1A is issued at a given BCID (programmable) as soon as the 3-bit calibration request word transmitted on the CTP Link is equal to one of a number of predefined values (the value of the calibration request word is used as an input in the CTP and hence enters in the trigger menu), or the L1A is issued when a transition on the calibration request word occurs. The value of the calibration word is used by the CTP to form the Trigger-Type word.

The LTP keeps track of the turn number and is capable of providing a signal when the turn number is equal to a programmable value; this allows a sub-detector to know when its calibration request will be taken into account.

### _Partition in local mode_

In the ATLAS pit, the BC and ORBIT signals are always available. Nevertheless, an internal crystal oscillator (40.08 MHz) can provide the BC clock for debug purpose. Similarly, the ORBIT signal can be generated internally.

In local mode, all other signals are generated and handled locally. Test trigger inputs are made available and output towards the test trigger inputs of the TTCvi after having been vetoed by the BUSY signal which is now locally handled (i.e.

\begin{table}
\begin{tabular}{|p{113.8pt}|p{113.8pt}|} \hline Name & Function \\ \hline BC & LHC clock \\ \hline ORBIT & LHC ORBIT signal used for instance to issue the BCR signal \\ \hline L1A & L1 Accept signal \\ \hline Trigger-Type & 8-bit trigger-type word issued by the CTP with each L1A \\ \hline ECR & Event Counter Reset signal. Signal used to reset the 24 low-order bits and to increment the 8 high-order bits of the L1ID \\ \hline Pre-Pulse & A signal issued by the CTP indicating that in N BC a L1A will be issued. This signal can be used, for instance, to fire a calibration or test pulse at the right time during data taking \\ \hline BUSY & The BUSY signal generated by the RODs of the sub-detector when their buffers are almost full. Used by the CTP to introduce dead-time \\ \hline Calibration & 3-bit word issued by the sub-detector and used by the CTP to generate calibration triggers \\ \hline \end{tabular}
\end{table}
Table 1: Signals exchanged between the CTP and a TTC partition when the partition is in the central data acquisition system (global mode)

Figure 3: Daisy chain of the Busy signals of the different partitions of a sub-detector

Figure 2: Interface between the CTP and a partition

it is not transmitted to the CTP). Similarly, the Trigger-Type has to be generated locally.

The test triggers and the local commands can be issued either externally (with a generator for instance) or internally.

Fig. 4 shows a view of the TTC root modules as used in local mode.

It is possible to run several partitions in local mode with the same timing and trigger signals (e.g. a run involving all the partitions of a given sub-detector). In this case, one of the LTPs acts as a master. It will transmit on its output CTP Link all the trigger and timing signals used locally and will receive the BUSY from the other LTPs.

## II LTP Module Description

The LTP essentially consists of a programmable switch allowing one to interconnect any Input to any Output and a pattern generator, as shown in Fig. 5.

A few blocks will be presented here. Full details can be found in Refs. [6] and [7].

#### Ii-1 Internal Pattern Generator

The pattern generator allows one to generate internal signals at a given time with respect to the LHC cycle. It is implemented using a 1 MWord RAM which can be written through VME and which is then read-out at the BC frequency. The content of the RAM (data-out bits) is then used internally to generate signals.

The size of the RAM allows one to cover a time window of 26.2 ms. The sequencer can either continuously loops or stops after a first read path depending on the mode selected. The sequence can be started when the ORBIT signal occurs, or when the Pre-Pulse signal occurs, or upon a VME access. A block diagram of the pattern generator is given in Fig. 6.

#### Ii-2 L1a path

Fig. 7 shows a diagram of the L1A block. This block includes the dead-time handling when L1A is generated locally. A fixed dead-time (a programmable number of BC from 0 to 8) can be introduced after a L1A has been issued.

When using the pattern generator as the L1A source, a complex dead-time algorithm can be implemented by programming the pattern generator accordingly.

The L1A source is either the CTP Link input, or a local NIM input or the pattern generator. The local NIM input, can either be passed without resynchronisation with the local BC, or resynchronised and reshaped with a 1- or 2-BC length.

#### Ii-3

Figure 4: View of the TTC root modules when in local mode

Figure 5: Simplified block diagram of the LTP

Figure 6: Block diagram of the pattern generator

Figure 7: Block diagram of the L1A path

When in local mode, the L1A can be masked locally by the internal BUSY signals, and/or an internal Inhib signal and/or one signal of the pattern generator.

#### Ii-B3 Busy path

Fig. 8 shows the block diagram of the BUSY block. Several sources of BUSY signal can be selected. When in global mode, the BUSY signal is sent to the CTP. When in local mode it is used to generate local dead-time.

When in global mode, the LTP directly connected to the CTP makes the OR of its local BUSY input with the BUSY signal coming from the other LTPs connected to this link via the daisy chain.

When in local mode the BUSY signal is not sent to the CTP.

It is possible to have some of the LTPs of a particular CTP Link in local mode, with others in global mode, since there is full control of what is transmitted on the CTP Link.

## III Implementation and Status

The implementation has been made with several CPLDs (ISP) from ALTERA. Special care has been taken in minimising the propagation delay in the module of signals entering in the level-1 trigger latency or requiring good timing characteristics; this has lead to using PECL technology for the BC, ORBIT and L1A signals.

NIM and ECL are used for external connections to the TTCvi and local equipment.

LVDS is used on the CTP Link. The cable is a screened 25-way twisted-pair cable whose length can be up to 30 m. Cable skew tests have been done [8] and, although the characteristics of the cable meet the requirements, the final choice will be made after evaluation in the ATLAS test beam environment.

Six prototype LTP modules have been produced, assembled and successfully tested in the laboratory. The final validation will be made in the test beam system this October (2004).

## References

* [1] The ATLAS Level-1 Trigger TDR, CERN/LHCC/98-14
* [2] N. Ellis et al., The ATLAS Level-1 Central Trigger Processor (CTP), 9th Workshop on Electronics for LHC Experiments, CERN-2003-006.
* [3][http://www.cern.ch/TTC/](http://www.cern.ch/TTC/).
* Technical Description and User Manual, [http://www.cern.ch/TTC/TTCviSpec.pdf](http://www.cern.ch/TTC/TTCviSpec.pdf).
* Technical Description and User Manual, [https://cdms.cern.ch/file/319209/1/rod_busy_manual_2.pdf](https://cdms.cern.ch/file/319209/1/rod_busy_manual_2.pdf), August 2001.
* [6] The Local Trigger Processor Specification, EDMS Reference: ATL-DA-ES-0033
* [7] The LTP description, EDMS Reference: EDA-00508 v.0
* [8] EDMS document: ATL-DA-TN-0001

Figure 8: Block diagram of the BUSY path

Figure 9: Picture of the LTP module