[MISSING_PAGE_FAIL:1]

###### Contents

* 1 Field characteristics and measurement requirements
* 2 Apparatus and data taking
	* 2.1 Scan data
	* 2.2 Hall card calibration and stability
	* 2.3 Mapping machine geometry and surveys
* 3 NMR measurements, saturation and hysteresis
* 4 Data fitting
	* 4.1 The geometrical fit
	* 4.2 The general Maxwell fit
	* 4.3 Fit quality measures
* 5 Corrections derived from the data
	* 5.1 Mapper dipole corrections
	* 5.2 Probe normalisation and alignment corrections
	* 5.3 Carriage tilt corrections
* 6 Results
	* 6.1 Results of the geometrical fit
	* 6.2 Results of the final fit
	* 6.3 Further corrections
	* 6.4 Error estimates
* 7 Conclusion

## 1 Field characteristics and measurement requirements

The ATLAS inner tracking detector (ID) uses an axial magnetic field of around 2 Tesla for measurement of charged track momentum. This field is provided by a superconducting solenoid [1] of radius 1.247 m, length 5.283 m, having 1154 turns which generates the required field when supplied with 7730 A. We work in a right-handed coordinate system where x points towards the centre of the LHC, y is vertically upwards and z is along the beam direction. In addition we often use a cylindrical version of the same system, which is related to it in the conventional way by \(\tan(\varphi)=y/x\) and \(r^{2}=x^{2}+y^{2}\). A small enhancement of the field is provided by the iron of the Tile Calorimeter, which has a laminar structure between r = 2.28 and r = 3.85 m followed by girders that carry most of the return flux and extend out to r = 4.23 m. The end-cap calorimeters are non-magnetic, so the field lines at the ends of the solenoid are pulled radially out towards the Tile Calorimeter. Compared with most other collider experiments theATLAS field is rather non-uniform. At r = 0 it drops near the end of the tracking volume from 1.8 T at z = 1.7 m to 1.0 T at z = 2.7 m. Almost 96% of the field is directly due to the current in the solenoid with the remainder being due to the magnetised iron.

We have taken the measurement of the W boson mass as the criterion to set our accuracy requirements. Muons and electrons from W decay have a typical transverse momentum of 40 GeV, which gives them a sagitta of 1.1 mm in a radial path of 0.8 m in a 2 T field. The momentum scale of these tracks is limited by our understanding of the ID alignment and magnetic field. Of these two, alignment is by far the more difficult and we suspect that there will be irreducible alignment errors at the 1 micron level, or 0.1% of the sagitta. In order to give ourselves the best possible chance of understanding alignment down to this level, we would like the magnetic field to be known to somewhat better accuracy, so we set a target of 0.05% for the uncertainty on track sagitta due to the field. Of course 0.1% momentum scale accuracy is not sufficient for an interesting measurement of m\({}_{w}\), but we believe that if we reach 0.1% accuracy from first principles then the final calibration step which makes use of the well known value of m\({}_{z}\) will be more reliable.

## 2 Apparatus and data taking

A mapping machine was designed to scan an array of Hall probes over a volume slightly larger than that which would later be occupied by the Inner Detector. The machine had four arms mounted on a common axle in a windmill configuration. The axle was supported by a carriage that rode on the ID rails. The axle could be rotated, and the carriage moved along the rails by means of pneumatic motors. Optical encoders allowed control of the machine movements and readout of its stop positions with an accuracy of \(\sim\)0.1 mm. This system [2] was built mostly with standard components but some parts had to be replaced by copies made from other materials in order to reduce perturbation of the field and prevent eddy currents in fast-moving parts. In the pneumatic motors1 the cylinder and bearings were replaced with stainless steel and the rotor replaced with PEEK. In the motion controller2 a DC-DC converter that used a transformer and relays was replaced by a charge pump and voltage stabilizer. However, the Piezo-actuated direction valves and proportional pressure control valves3 were used without modification.

Footnote 1: Atlas Copco LZB 22R from www.atlascopco.com

Footnote 2: Baldor NextMove ESB from www.baldor.com

Footnote 3: Hoerbiger S9 from www.hoerbiger.com

Each arm held 12 Hall cards at radii ranging from 0.118 to 1.058 m. Each Hall card contained three sensors to measure the field components B\({}_{z}\), B\({}_{r}\) and B\({}_{o}\). We number the Hall cards on each side of each arm from 1 to 12 in order of increasing radius. The four measurement planes are labelled A (C) for the +z (-z) end of the machine and E (I) for the external (internal) side of the arm. In addition to the mapping machine there are four NMR probes [3] permanently installed on the wall of the ID volume at z=0.

### Scan data

The ATLAS solenoid was commissioned [4] in the last two weeks of July 2006 and its field was mapped in the first week of August. The ID barrel was installed immediately afterwards, so there was no opportunity to investigate puzzling features in the data by repeating any maps or surveys. Maps were taken with the solenoid current set at 7730, 7850, 7000, 5000 and 0 A, followed by a final map back at the nominal operating current of 7730 A. The maps are labelled by their current values and the first (second) map at 7730 A is distinguished by appending an a(b). Each map took about 4 hours to record and the solenoid current was stable to much better than 0.1 A during this time. Each map data set contains points distributed over 16 equally spaced steps in \(\varphi\) and around 200 roughly equal steps in z between -3 m and +3 m. An exception is map 7730b which used 24 \(\varphi\) steps. The total number of points in a map is at least 20 000, which is sufficient to fit the field with negligible statistical error. In addition to the standard maps some special scans were made; fine z steps of 5 mm around z = 0, fine \(\varphi\) steps of 2\(\pi\)/64 at the middle and ends of the coil, and a scan that took each of the four measuring planes in turn to z = 0.

### Hall card calibration and stability

The primary Hall card calibration [5] involved placing each card in a highly uniform field whose strength was monitored by an NMR probe. The card was turned to many different

Figure 1: The mapping machine installed in the Inner Detector cavity.

Figure 2: A small selection of the data from map 7730a after all the corrections that will be described below. We have selected three radial positions and one \(\varphi\) position (20\(\pi\)/16) to illustrate the shape of the field and the density at which it was mapped.

orientations with angles \(\theta\) and \(\varphi\) that were measured precisely by pickup coils. The measurements were repeated at several field strengths and temperatures. The Hall voltage (\(V\)) is decomposed into orthogonal functions. Spherical harmonics are used for \(\theta\) and \(\varphi\) and Chebyshev polynomials for the modulus of the field \(\left|B\right|\) and temperature, \(t\);

\[V(\mid B\mid,t,\theta,\varphi)=\sum_{k}\sum_{n}\sum_{l}\sum_{m=0}^{l}c_{\,{}_{ klm}}T_{k}\left(\mid B\mid\right)d_{\,{}_{nlm}}T_{n}\left(t\right)Y_{\,{}_{lm}} \left(\theta,\varphi\right) \tag{1}\]

Using this series about 200 parameters were used to calibrate each probe. A separate angular calibration was used to find the orientation of the calibrated coordinate system relative to the three feet that support the Hall card on the mapping machine.

All Hall cards were calibrated up to 1.4 T in a magnet at CERN and up to 2.5 T in the M5 magnet at Grenoble. Compared with CERN, the Grenoble magnet had less temperature stability and a smaller region of uniform field, which was not large enough to operate the calibration jig simultaneously with an NMR probe. Consequently the expected accuracy is 0.01% for the low field calibration and 0.05% for the high field calibration. The lowest current map, 5000 A, was chosen so that the field was everywhere below 1.4 T and could be entirely analysed with the low field calibration. The alignment accuracy is expected to be \(\pm\) 2 mrad for both calibrations.

Finally, we are able to make a comparison between the solenoid field measured by the Hall probes and the same field measured by the four NMR probes. This comparison makes use of corrections and fits described below, so there is some circular dependence which was solved by a manual iteration which rapidly converged. We know that NMR is highly accurate so we can derive from this a correction that applies to the Hall probes as a whole. The difficulty with this comparison is that the NMR probes are just outside the volume scanned by the Hall probes, so some extrapolation must be done. Two extrapolation methods have been used and the difference between them gives a measure of the uncertainty. The first method is to use the field model which is fitted to the entire Hall probe data set to predict the field at the NMR positions. The second method is to use only the data recorded by a windmill arm that is at z = 0 and pointing towards an NMR probe. A linear fit to the difference between this Hall data and the field model is extrapolated outwards to the radius of the NMR. The first method makes best statistical use of the Hall data while the second takes into account any small discrepancy between the measurements and the fit in the vicinity of the NMR probes. Whatever method is used, the correction is only measurable at the four mapped field strengths. We can also look at the difference between the 5000 A map data when it is passed through either the high or low field calibration. All these differences are plotted in figure 3.

This data is consistent with the hypothesis that the low field Hall calibration is very accurate, as expected, while the high-field Hall calibration has a systematic bias that varies linearly with the field strength. So in all subsequent analysis we make a correction to the high-field Hall data using the linear fit coefficients labelled HC1 in figure 3. The possible systematic error in our final maps resulting from this correction is evaluated by using the alternative values labelled HC2. No such corrections are applied to the low-field Hall data.

Figure 4 shows the difference between pairs of measurements made by the same Hall probe at the same position in space, separated in time by the five days between the first and second maps at 7730 A. The measurements are on the z = 0 plane, and only the B\({}_{z}\) component of the field is used, so any tilts or imperfections of the machine movements have little effect. The mean is -0.01 mT and the r.m.s. is 0.06 mT, showing that the stability is good.

[FIGURE

### Mapping machine geometry and surveys

We work in a coordinate system that is linked by surveys to the inner warm vessel which the magnet cryostat shares with the liquid argon calorimeter. This approximately coincides with the standard ATLAS coordinate system as described in section 1. The positions of the Hall and NMR sensors in this system are calculated by combining information from four theodolite surveys: a survey of the ID rails, a survey of the mapping machine in the surface hall where it was built, a survey of the machine at z = 2.5 m in the ID cavity just after the mapping campaign and a survey of the positions of individual sensors within the Hall cards. Each survey individually had an accuracy of 0.1 to 0.2 mm. When all this information is combined [6] to calculate the position of a map point we estimate that the resulting r.m.s. accuracy is around 0.3 mm.

## 3 NMR measurements, saturation and hysteresis

The Inner Detector is equipped with four NMR probes which are fixed to the wall of the inner warm vessel at z = 0, r = 1.13 m, and equally spaced in \(\varphi\). They measure the field strength with repeatability of 1 \(\mu\)T and accuracy of 10 \(\mu\)T. The NMR probes were operational throughout the commissioning of the solenoid and the mapping of the field, and remain in place to monitor the field strength during ATLAS data taking.

Figure 4: Stability of Hall probe measurements over a five day interval.

Figure 3: Differences of field measured by the NMR system and high and low field calibrations of the Hall probes. The error bars indicate the r.m.s. spread of the data behind each plotted point; for points comparing the fit to the NMR it is the r.m.s. of four numbers and for points comparing two calibrations of the Hall probes it is the r.m.s. of 48 numbers.

We can derive information from this data about the saturation of the calorimeter iron magnetisation. Saturation will produce a non-linearity in the relation between current and field. This is illustrated in Table 1 by subtracting from field the part that scales linearly with current. The predicted distortion of the coil by magnetic forces [1], also causes a small non-linearity; between 5000 A and 7730 A we expect the coil length to decrease by 1.3 mm and its radius to increase by 0.5 mm, causing an effect of +0.22 mT. After correcting for the coil distortion, the non-linearity of the iron saturation alone is around -0.75 mT.

During commissioning and mapping the solenoid current was taken nine times to 7730 A and on eight of those occasions the current was approached from below. The NMR reading was recorded each time and the greatest difference between any pair of readings was 0.017 mT. Once, between cycles 3 and 4, the 7730 A point was approached from above and that time the average NMR reading was 0.33 mT higher than normal, showing that the direction of approach is significant. This shows that provided that we always approach the operating current from below hysteresis will not be a concern.

## 4 Data fitting

We only fit the map data to models of the field that obey Maxwell's equation in the absence of current and magnetic materials. If we find that our field model does not fit the data it either means that our model is not detailed enough to represent the true field, or that there is a systematic error in the map data that makes it non-physical. Much effort has been spent on tracing residuals back to one or other of these causes and thus finding a correction to the data or improving the model. Another possible reason for fitting would be to smooth out any random errors in the data; however the level of truly random errors is around 0.06 mT so the benefit of smoothing this away is very small. Even if we had absolute confidence in the map data we would still need to make use of a field model because the map data points are not dense enough to allow us to calculate the field at all points in the ID volume by interpolation with the accuracy we need. At various points in the data analysis we make use of the two fits described below, and finally we combine them to get the closest possible fit to our data.

### The geometrical fit

For this fit we use a detailed model of the conductor geometry and integrate the Biot-Savart law using the measured conductor current to produce a field model that we expect to account for most of the measured field. Within our conductor geometry model there are several parameters taken from surveys of the solenoid coil as built [7]. For example the coil was built from four sections, each with slightly different average pitch, and joined together by welds that can be represented electrically by turns having just under twice the average pitch. There are also welds at the ends of the coil and a return conductor that runs axially along the outside of the support

\begin{table}
\begin{tabular}{|l|c|c|} \hline Map & Average of four & Average minus \\  & probes (T) & current \(\times\) 0.262554 (mT) \\ \hline
7730a & 2.029012 & -0.530 \\ \hline
5000 & 1.312766 & 0.000 \\ \hline
7850 & 2.060479 & -0.567 \\ \hline
7000 & 1.837577 & -0.297 \\ \hline
7730b & 2.029016 & -0.527 \\ \hline \end{tabular}
\end{table}
Table 1: The average NMR values for each map.

cylinder. We include the expected distortion of the solenoid from its surveyed dimensions due to shrinkage on cooling and the distortion due to magnetic forces. We assume that the coil has a perfectly circular cross section.

Two free parameters exist in our conductor model: an overall scale factor of all dimensions in the axial direction and an independent scale factor in the radial direction. Technically this is achieved in the software by mixing two field models with slightly different aspect ratios (coil length/diameter) that bracket the true aspect ratio, then by scaling the resulting mixture equally in both the radial and axial directions. Both mixing and scaling are simple transformations that can be done in a second of CPU time, whereas creating a field model with a new aspect ratio requires the Biot-Savart integral to be evaluated at every point in the map which takes about 2 hours. We have a further five free parameters representing three offsets and two rotations of the conductor model relative to the map coordinate system. Finally we include four z-symmetric terms of a Fourier-Bessel series, which are intended to represent the field due to the magnetised iron;

\[B_{z}=\sum_{n=1}^{4}C_{n}\cos(\frac{nz}{s})I_{0}\left(\frac{nr}{s}\right) \hskip 14.226378ptBr=\sum_{n=1}^{4}C_{n}\sin(\frac{nz}{s})I_{1}\left(\frac{nr}{ s}\right) \tag{1}\]

Where I\({}_{0}\) and I\({}_{1}\) are modified Bessel functions and the length scale, s, was chosen to be 2.5 m because this value allows a good fit to the iron field predicted by the finite element model of the ATLAS field [8]. So the fit has a total of 11 free parameters, which are found by minimising a \(\chi^{2}\) function that includes the B\({}_{z}\) and B\({}_{r}\) components of the field at all mapped points.

### The general Maxwell fit

Any magnetic field in the absence of sources can be represented by the function described below. Furthermore, the field anywhere inside a volume is fully determined by the field values on the surface that encloses the volume. The general Maxwell fit [9] uses these features to find a function that closely matches the measured data on the surface of the mapped volume and then predict the field at any point inside the volume. The closeness of the match is limited by the truncation point of each series and in principle the total number of coefficients we could evaluate is limited by the number of data points on the cylinder surface. In fact we work with a much smaller number of terms because we have chosen an expansion that matches the nearly-cylindrical character of our field so that it converges quite rapidly. The errors due to truncation are maximal on the surface of the mapped volume [10]. In our case the truncation errors drop almost exponentially versus the distance from the outer surface, due to the form of the higher order Bessel functions.

In our situation the majority of the B\({}_{z}\) field is represented by a sum of Fourier-Bessel terms of the form

\[A_{n0}r^{n}\cos(n\phi+\alpha_{n0})\]

and

\[A_{nl}I_{n}\left(\frac{l\pi}{L}r\right)\!\!\cos(n\phi+\alpha_{nl})\cos(\frac{ l\pi}{L}z)+B_{nl}I_{n}\left(\frac{l\pi}{L}r\right)\!\!\cos(n\phi+\beta_{nl}) \sin(\frac{l\pi}{L}z)\]

where \(I_{n}\) are modified Bessel functions. The period of the Fourier expansion, \(2L\), is extended by about 20% beyond the mapped region of the solenoid in order to prevent the discontinuity at the ends of the period from causing large oscillations in the mapped region. The mapped region is smoothly extrapolated into the extension region using a prescription that guarantees continuity of the field and its gradient. The coefficients \(A\), \(B\) and phases \(a\), \(\beta\) of these terms are evaluated solely from the B\({}_{z}\) measurements on the curved surface of the mapped cylinder. Aftersubtraction of the Fourier-Bessel terms from the measured data one is left with non-zero B\({}_{z}\) values on the cylinder ends. These can be represented by hyperbolic terms of the form

\[C_{nm}J_{n}\!\left(\frac{\xi_{nm}}{R}\,r\right)\!\cos(n\phi+\gamma_{nm})\cosh \!\left(\frac{\xi_{nm}}{R}\,z\right)\!+D_{nm}J_{n}\!\left(\frac{\xi_{nm}}{R}\,z \right)\!\cos(n\phi+\delta_{nm})\sinh\!\left(\frac{\xi_{nm}}{R}\,z\right)\]

where \(\zeta_{nm}\) are the zeros of the Bessel functions \(J_{n}\). These terms are chosen so that they have a zero at the mapper radius \(R\) in order to avoid changing B\({}_{z}\) on the outer curved surface. The corresponding B\({}_{z}\) and B\({}_{\circ}\) components of the field are given by rather similar terms with the same coefficients.

After subtraction of both Fourier-Bessel and hyperbolic terms from the data one is only left with components of the field which are independent of z and make no contribution to B\({}_{z}\). B\({}_{r}\) is represented by multipole terms of the form

\[E_{n}nr^{n-1}\cos(n\phi+\varepsilon_{n})\]

where the coefficients are evaluated from the B\({}_{r}\) measurements on the curved surface of the cylinder.

We make use of the general Maxwell fit in calculating the probe normalisation corrections below. We also apply it to the residuals of the geometrical fit, where it allows us to improve our representation of the data while preserving a field that satisfies Maxwell's equations.

### Fit quality measures

The quantity minimised in our fit is

\[\chi^{2}=\sum_{i,c}\left(B_{c,i}^{measured}-B_{c,i}^{fit}\,\right)^{2}\]

where the index \(i\) runs over all the measured points and the component index \(c\) can be one or more of z, r and \(\varphi\). For our final results we use the z and r components but for systematic studies we also use z alone or all three. Another systematic test, designed to be insensitive to probe alignment is to minimise

\[\chi^{2}=\sum_{i}\left(\mid B_{i}^{measured}\mid-\mid B_{i}^{fit}\mid\right)^{2}\]

The standard measures of fit quality that we use are the mean, r.m.s. and extreme values of the residuals \(B_{i}^{meas}-B_{i}^{fit}\). We report these for each of the three field components separately in the results tables. However these do not capture our essential aim, which is to know the sagitta and hence the momentum of a track. So we make the following simplifying assumptions about tracks:

* A track follows an almost straight trajectory from the origin to the point where it leaves the ID volume either at r = 1.08 m or z = \(\pm\)2.713 m. The radius at which it leaves the ID is called r\({}_{\rm max}\).
* The track is measured by the ID at several uniformly spaced points along its path with equal accuracy.
* Only measurements in the \(\varphi\) direction contribute to the momentum measurement because the detector resolution in the other direction is relatively poor.

Given these assumptions the sagitta of a track is proportional to \(S\):

\[S=\int\limits_{0}^{r_{\rm max}}r\!\left(r_{\rm max}-r\right)\!\left(c_{r}B_{z }-c_{z}B_{r}\,\right)\!\,d\ell\]where \(c_{z}\) and \(c_{r}\) are the direction cosines of the track in z and r. The integral is evaluated numerically along straight lines at fixed values of \(\theta\) and \(\varphi\). The effect on the sagitta of a difference between the fitted and the measured field is \(\delta\)S, given by the same integral but with the field components replaced by the fit residuals. We use \(\delta\)S/S as our measure of the fit quality for one particular trajectory and we use a set of trajectories, uniformly spaced in \(\varphi\) and pseudo-rapidity, to measure the quality of the whole fit.

## 5 Corrections derived from the data

This section describes three corrections that we have extracted from the scan data itself and then applied back onto the data. Despite the apparent circularity, this procedure can greatly improve the accuracy of the results because it makes use of the strong physical constraints on the possible form of a magnetic field.

### Mapper dipole corrections

Early investigations of the data showed variations of the field versus \(\varphi\) that were unlike anything predicted by our field model. We discuss here only the B\({}_{z}\) field because it is not influenced by probe misalignments of a few milliradians, but these variations also exist in the B\({}_{r}\) and B\({}_{\varphi}\) components where they are mixed with probe alignment effects and the field due to the return conductor. Figure 5 shows a typical example of B\({}_{z}\) measured by arm CI in a fine \(\varphi\) scan of 64 steps. We plot B\({}_{z}\) measured minus B\({}_{z}\) of our model but in fact the \(\varphi\) dependence of B\({}_{z}\) in the model is well below 0.1 mT so all the variation seen in this plot is coming from the measurements.

We now understand the features in figure 5 as being due to two independent effects. First is a low-spatial-frequency effect in \(\varphi\) that is seen in probes at all radii and has amplitude that is approximately proportional to radius. This effect changes, also with low spatial frequency, as a function of z. We suspect that it is due to local variations in the density of the windings in different regions of the coil. Variations of order 0.3% are known to exist [7].

The second effect is spikes or bumps that are only seen by one or two neighbouring probes in a narrow \(\varphi\) range. For most probes they appear near 0 and 180 deg but for the two innermost probes the bump is broader and is centred at 90 deg. These features are independent of z and are most pronounced on the inner sides of the arms, especially on arm CI. These clues all point to the source as magnetisable components of the mapping machine itself. From the positions of the spikes we have tracked down nine components of the mapping machine which are probably the culprits: three sets of pneumatic motor bearings, three encoders, two pneumatic valves and a

Figure 5: B\({}_{z}\) residuals in a fine \(\varphi\) scan at Z = -0.195 m measured by arm CI.

plug. The positions of these components are known but their magnetisability has to be got from the map data itself. We represent each of the magnetic components by a dipole field located at the known position on the machine and with a strength that is adjusted to make the residuals plot as smooth as possible after subtraction of the dipoles. The dipole direction is aligned with the local direction of the field, so it changes as the machine moves along the rails. The dipole strength is constant, independent of the local field strength, because we found that this gives the lowest residuals, which indicates that the magnetic components are fully saturated.

The final result for arm CI is shown in figure 6. There is a significant improvement but clearly our model of the perturbation due to the machine is not quite perfect as some small spikes remain. The reason for making this effort to correct for localised perturbations of less than 1 mT is that many parts of our analysis rely on having a field that accurately obeys Maxwell.

### Probe normalisation and alignment corrections

The strong physical constraints on the possible field allow us to determine the three alignment angles of each probe and to normalise the B\({}_{\mathrm{z}}\) measurement of all probes to a common scale. Our techniques rely on having a field which has approximate cylindrical symmetry and accurately obeys Maxwell's equations. So before starting we subtract from our measurements the expected field of the return conductor which would otherwise spoil the symmetry, and we correct for the mapper dipoles. The calibration is applied separately to the low (5000 A) and high (all other currents) field maps because the underlying Hall calibrations are different in these two cases.

The B\({}_{\mathrm{z}}\) normalisation factor is found by applying the general Maxwell fit to the cylinder scanned by a single probe. A small amount of data from lower radius probes is necessary to cover the cylinder ends, but we find that the predicted field at the origin is very highly correlated with the normalisation of the probe used for the curved part of the surface. Thus each probe individually can predict the field at the origin and we set their B\({}_{\mathrm{z}}\) normalisations so that they exactly agree. Figure 7 shows the resulting normalisation for the high field maps. There is no significant structure versus probe number. The mean is zero by construction and the r.m.s. is 0.034%, which is slightly better than the 0.05% expected from section 2.2. In the case of the low field map the r.m.s. is 0.008%, also slightly better than expected.

We know from the Hall card calibration that the misalignment angles will be small, so we use the small angle approximation and label them by the field components that they mix; A\({}_{\mathrm{\alpha}\mathrm{\alpha}}\), A\({}_{\mathrm{\alpha}\mathrm{z}}\) and A\({}_{\mathrm{\alpha}\mathrm{r}}\). To find the first two angles we use curl B=0, which implies that the integral of B\({}_{\mathrm{\circ}}\) round a full circle should be zero. The integral is well approximated by the sum of B\({}_{\mathrm{\circ}}\) over the

Figure 6: B\({}_{\mathrm{z}}\) residuals after the mapper dipoles correction.

16 equally spaced \(\varphi\) steps in one turn of the machine in a standard map. Combined with the relation between the measured \(\varphi\) component and the true field components this gives;

\[\sum_{nm}B_{\varphi}^{meas}=A_{\varphi_{c}}\sum_{nm}B_{z}-A_{r\varphi}\sum_{nm}B_ {r}\]

These sums are evaluated at all z positions so they cover a range of axial and radial field strengths and the angles are found by a least squares fit to the variation with z.

The alignment angle A\({}_{\mathrm{z}r}\) and the B\({}_{\mathrm{r}}\) normalisation factor N\({}_{\mathrm{r}}\) of each probe are found by applying Gauss's theorem to a series of cylinders centred on the z axis, with each cylinder having the same radius as the probe under calibration and having thickness corresponding to the z spacing between measurements.

\[\int_{surface}\overline{B}\overline{dS}=-\int_{end1}B_{z}dS+\int_{cyl}B_{r}dS+ \int_{end2}B_{z}dS=0\]

This is combined with the relations between the measured and true fields \(B_{r}^{meas}=B_{r}\ /\ N_{r}+A_{zr}B_{z}\) and \(B_{z}^{meas}=B_{z}\ /\ N_{z}-A_{zr}B_{r}\)(the normalisation factor \(N_{z}\) has already been found as described above). Applying this to the series of cylinders gives a system of equation that can be solved with a least squares fit. For each arm, the probes are calibrated in order of increasing radius so that the integrals over the end faces may make use of the calibration of lower radius probes. For our final maps we use N\({}_{\mathrm{r}}\)=1 rather than the values found by this procedure because doing so gives lower \(\chi^{2}\) in the geometrical fit. This may be because the real calibration errors of B\({}_{\mathrm{r}}\) are functions of the field strength, although a simple scale factor works well for B\({}_{\mathrm{z}}\) since nearly all B\({}_{\mathrm{z}}\) values are close to 2 T.

Figure 8 shows the probe alignment corrections derived in this way for the high field maps. All three alignment angles are used, but A\({}_{\mathrm{z}r}\) is by far the most important because it mixes the two large field components which are used in the fit \(\chi^{2}\). The mean angle is slightly negative and there is an r.m.s. of 3.1 mrad, somewhat worse than the \(\pm\) 2 mrad expected from the Hall probe angular calibration procedure. There is no significant structure except that probe number 6 stands out; on dismantling the mapping machine this probe was found to be poorly attached to the arm. The angle A\({}_{\mathrm{r}\mathrm{0}}\) is poorly determined on the lowest radius probes (numbers 1, 13, 25 and 37) because both B\({}_{\mathrm{r}}\) and B\({}_{\mathrm{v}}\) are always very small for these probes; conversely this angle has little influence on the final map. The remainder of the A\({}_{\mathrm{r}\mathrm{0}}\) and A\({}_{\mathrm{v}\mathrm{z}}\) angles show a scatter of around 3 mrad, with possibly some systematic effects, but again they have little influence on the fit.

Figure 7: Probe normalisation corrections for the high field maps.

### Carriage tilt corrections

The B\({}_{y}\) component of the field on the axis of the mapping machine can be evaluated by using one of the probes at low radius and taking the average over the 16 equally spaced \(\varphi\) steps. If B\({}_{y}\) is plotted against z we see in figure 9 that different arms give inconsistent values of the transverse field as a function of z. However, if B\({}_{y}\) is plotted against the z position of the mapping machine carriage, z\({}_{\rm car}\), then we see in figure 10 that better agreement is found. These features are explained if the carriage tilts slightly as it moves along the rails, this imparting a common error to all measurements as a function of z\({}_{\rm car}\). The offset between the transverse fields measured by arms A and C can be explained by small errors in the surveyed values of the arm tilts, so we apply a correction to the tilts of arms A and C to bring them into agreement with each other without changing their average value.

In order to correct for the carriage tilt versus z\({}_{\rm car}\) we need a way to separate its effects from the true transverse components of the field which are a function of z. The z component of the field is not significantly influenced by the carriage tilts and its gradient in the transverse directions can be measured at each z plane in the map, so we make use of the relations below to get the z gradient of the transverse field

\[\frac{\partial B_{z}}{\partial z}=\frac{\partial B_{z}}{\partial x}=g_{x} \frac{\partial B_{y}}{\partial z}=\frac{\partial B_{z}}{\partial y}=g_{y}\]

Figure 8: Probe alignment corrections for the high field maps.

Figure 9: The measured transverse field plotted against the z position of the probe.

In practice the carriage tilts affect both the measurement of the field and its gradients. For the x-components:

\[B_{x}^{\,meas}=B_{x}^{\,true}+\left(B_{z}+f\,\frac{\partial B_{r}}{\partial z} \right)\theta_{x}\qquad\quad g_{x}^{\,meas}=g_{x}^{\,true}+\left(\frac{ \partial B_{z}}{\partial z}-\frac{B_{r}}{r}\right)\theta_{x}\]

where \(\theta_{x}\) is the carriage tilt angle and the factor \(f\) is zero if \(\mathrm{B_{x}}\) is derived from the \(\mathrm{B_{o}}\) sensor or \(r\) if it is derived from the \(\mathrm{B_{r}}\) sensor. We can now integrate these relations to get the carriage tilt at any z position. Note that the true fields are assumed to be well behaved but the tilts are only defined at the measured planes. The integral needs a starting point at some z value at which the carriage tilt or the true transverse field is known. One option is to trust the survey data, which amounts to setting the tilt to be zero at \(\mathrm{z_{car}}=2.5\) because this is where the carriage was surveyed and the data have already been corrected for the surveyed axle tilt; this gives a correction set which we call CT1.

However we are not sure that the final survey is highly accurate because the axle direction measured in an earlier survey differs from it by 1 mrad. Rather than accept a systematic error of 1 mrad we can get an independent estimate from the map data itself. The true transverse field must be a unique function of z, but we can evaluate it independently with each of the four windmill arms. We find the best agreement between the four arms if we change the surveyed axle directions by 0.24 and -0.11 mrad in the horizontal and vertical directions, thus giving an alternative correction set which we call CT2.

Figure 11 shows a compilation of the tilt values CT1 from all maps. We see that the rotations around the horizontal axis, \(0_{y}\), are quite jagged, possibly due fluctuations of order 0.1 mm in the rail height, which is below the resolution of the survey measurements. Any rotations around the vertical axis caused by the rails should have been picked up and already corrected by the separate encoders on the two rails, so we assume that the non-zero values of \(0_{x}\) are due to imperfections of the encoders themselves.

## 6 Results

The Geometrical fit, alone and in combination with the Maxwell fit, was applied to all of the available maps. The map at 5000 A was analysed with both the low-field and the high-field Hall calibrations. We give summaries of each fit and extra detail about the map 7730a because this is the one that we will use for our final results at nominal 2 T field.

Figure 10: The measured transverse field plotted against the z position of the carriage

### Results of the geometrical fit

The results of the geometrical fit alone are shown in table 2 and table 3. In a survey done after solenoid installation the offsets of the solenoid centre were -0.1 \(\pm\) 2.3 mm axial, -0.3 \(\pm\) 0.4 mm horizontal, -2.2 \(\pm\) 0.4 mm vertical [11]. Our fitted offsets are consistent with these expectations in the axial and vertical directions. The fitted horizontal offset is in the opposite direction to that expected but the discrepancy is only 1.5 \(\sigma\). At first sight the fitted scale Z and R scale factors appear very close to 1, however the Z scale of 1.0012 amounts to a change of 6 mm in the total length of the coil, which is difficult to reconcile with the coil survey accuracy. The radial scale factor that comes from our fit is compatible with survey information.

The conductor model used in all these fits had the expected dimensions of the coil at 7730 A, so the slight changes of the Z and R scale factors with current are expected due to the real distortion of the coil by magnetic forces. Also, since the coil is fixed at end A and free at end C, one expects the slight movement of the coil centre in the +z direction as it gets shorter.

\begin{table}
\begin{tabular}{|l|l|l|l|l|l|l|l|} \hline Map & \multicolumn{2}{|c|}{B\({}_{z}\) (mT)} & \multicolumn{2}{|c|}{B\({}_{z}\) (mT)} & \multicolumn{2}{|c|}{B\({}_{\circ}\) (mT)} & \multicolumn{2}{|c|}{\(\delta\)S/S (\(\times 10^{-4}\))} \\ \hline  & r.m.s. & extreme & r.m.s. & extreme & r.m.s. & extreme & r.m.s. & extreme \\ \hline
5000 & 0.296 & -3.51 & 0.291 & -3.68 & 0.222 & -1.27 & 3.56 & -13.7 \\ \hline
5000h & 0.414 & -4.25 & 0.388 & -3.89 & 0.297 & -1.52 & 4.16 & +14.8 \\ \hline
7000 & 0.576 & -4.59 & 0.518 & -4.37 & 0.372 & -1.97 & 4.41 & -17.3 \\ \hline
**7730a** & **0.531** & **-5.42** & **0.506** & **-4.41** & **0.368** & **+2.17** & **3.76** & **-14.1** \\ \hline
7730b & 0.452 & +5.19 & 0.480 & -3.94 & 0.384 & -2.50 & 2.99 & +9.0 \\ \hline
7850 & 0.453 & +5.10 & 0.456 & -4.37 & 0.377 & -2.22 & 2.91 & +10.4 \\ \hline \end{tabular}
\end{table}
Table 2: Quality indicators of the geometrical fit residuals.

Figure 11: A compilation of carriage tilt corrections CT1 from all maps.

\begin{table}
\begin{tabular}{|l|l|l|l|l|l|l|l|l|l|} \hline Map & \multicolumn{4}{|c|}{Offsets (mm)} & \multicolumn{2}{|c|}{Angl (mrad)} & \multicolumn{2}{|c|}{Scale factors} & \multicolumn{2}{|c|}{Field at centre} \\ \hline  & x & y & z & A\({}_{\rm x}\) & A\({}_{\rm y}\) & z & R & (T) & \% iron \\ \hline
5000 & 0.44 & -2.52 & 0.36 & -0.11 & 0.20 & 1.00159 & 0.99900 & 1.29262 & 4.108 \\ \hline
5000h & 0.42 & -2.54 & 0.35 & -0.11 & 0.18 & 1.00154 & 0.99913 & 1.29252 & 4.099 \\ \hline
7000 & 0.33 & -2.41 & 0.48 & -0.06 & 0.16 & 1.00137 & 0.99919 & 1.80926 & 4.074 \\ \hline
**7730a** & **0.26** & **-2.42** & **0.51** & **-0.08** & **0.19** & **1.00121** & **0.99926** & **1.99775** & **4.052** \\ \hline
7730b & 0.17 & -2.63 & 0.55 & -0.13 & 0.23 & 1.00122 & 0.99927 & 1.99777 & 4.054 \\ \hline
7850 & 0.35 & -2.50 & 0.60 & -0.12 & 0.23 & 1.00126 & 0.99954 & 2.02873 & 4.060 \\ \hline \end{tabular}
\end{table}
Table 3: Parameter values of the geometrical fit.

We suspect that the ripples seen in the residual plots (figure 12) at \(|\mathrm{z}|<2\) m are due to variations in the coil winding density. The winding density was measured at intervals of 50 turns and 45\({}^{\circ}\), with accuracy 0.5 mm. This data was used to set the average pitch of each 288-turn section of the coil in our conductor model. The data also shows that there are smaller scale variations in the winding density but it is not accurate enough for us to put them into our conductor model with confidence. So it is not surprising that we see these residual ripples at the 0.5 mT level.

The larger features in the residuals plots at \(|\mathrm{z}|>2\) m could also be due to winding density variations but we believe it is more likely that they are a result of the coil not having a perfectly circular cross section. Four points on each end of the coil were surveyed. The deviation of the measured points from fitted circles were up to 2.7 mm, indicating that it is not circular but not giving us enough information to know its real shape. The magnetic pressure will improve but not eliminate the non-circularity of the coil.

The 0 A map shows a field of 0.42 mT at the centre and fits well to a single Fourier-Bessel term with length scale 2.52 metres. The r.m.s. fit residuals are around 0.12 mT in all three field components.

### Results of the final fit

If either of the explanations above is correct then the residuals that we see after the geometrical fit are due to real magnetic fields rather than measurement errors. In this case we can fit them with the general Maxwell function. So we apply the general Maxwell fit to the residuals of the geometrical fit. The effect is to reduce significantly the residuals of all probes. The fact that the function, which was evaluated using only the outermost probes, matches the inner probes too is strong evidence that the observed difference between the data and the geometrical model is a real field, not a measurement error. The inclusion of the Maxwell fit also improves the quality as measured by 8S/S for high rapidity tracks.

Figure 12: B\({}_{x}\) residuals from the geometrical fit to map7730a.

### Further corrections

At the time of mapping, the magnetic environment of the solenoid was in its final configuration for ATLAS running except for two features. Firstly there will be a pair of 8 cm thick iron shielding discs at z = \(\pm\)6.85 m covering the radial range 0.54 m to 4.4 m. These discs were not present when the field was mapped. A preliminary calculation [8] of their effect is that they will change the field by 0.3 mT at the ends of the ID and much less in the centre. When the final calculation of their effect is available the map will be corrected. Secondly, the barrel toroid was off when the solenoid was mapped, but normally it will be on. The direct effect of the toroid field leaking into the ID volume is expected to be negligible. However, the toroid will magnetise the Tile Calorimeter girders in the azimuthal direction and this will reduce their effectiveness as return yokes for the solenoid flux. The result is expected to be a drop of about 1 mT in the solenoid field. We will directly measure it with the NMR probes and any spatial variation of the effect in the ID volume will be taken from the FEA calculation.

\begin{table}
\begin{tabular}{|l|l|l|l|l|l|l|l|} \hline Map & \multicolumn{2}{|c|}{B\({}_{x}\) (mT)} & \multicolumn{2}{|c|}{B\({}_{x}\) (mT)} & \multicolumn{2}{|c|}{B\({}_{0}\) (mT)} & \multicolumn{2}{|c|}{\(\delta\)S/S (\(\times 10^{-4}\))} \\ \hline  & r.m.s. & extreme & r.m.s. & extreme & r.m.s. & extreme & r.m.s. & extreme \\ \hline
5000 & 0.227 & -2.51 & 0.184 & -2.98 & 0.189 & +1.13 & 1.75 & +6.8 \\ \hline
5000h & 0.369 & -2.85 & 0.330 & -2.94 & 0.272 & +1.25 & 2.05 & +8.0 \\ \hline
7000 & 0.501 & -3.34 & 0.436 & -3.47 & 0.319 & +1.59 & 1.62 & +7.7 \\ \hline
**7730a** & **0.435** & **-3.71** & **0.352** & **-3.36** & **0.296** & **+1.49** & **1.40** & **+7.3** \\ \hline
7730b & 0.332 & -3.24 & 0.343 & -5.41 & 0.326 & +1.49 & 1.36 & +6.8 \\ \hline
7850 & 0.355 & -3.26 & 0.347 & -4.86 & 0.312 & +1.60 & 1.66 & +10.1 \\ \hline \end{tabular}
\end{table}
Table 4: Quality indicators of the final fit residuals.

Figure 13: B\({}_{x}\) residuals from the final fit to map7730a.

Figure 14: B\({}_{r}\) residuals from the final fit to map7730a.

Figure 15: B\({}_{\circ}\) residuals from the final fit to map7730a.

### Error estimates

We divide the error into two parts; one uncertainty about the shape of the field and another uncertainty about its scale. We estimate the shape uncertainty of our final fit by making'reasonable' changes to our analysis and seeing what effect they have on the results. One is to change the way that we evaluate a correction, or to ignore completely a small correction. Another is to use a different choice of field components in the \(\chi^{2}\) that is minimised in the fit. A final possibility is to fit to the 5000 A data and scale up the result. Below are keys for these alternative fits:

\begin{tabular}{l l}
**None** & - & no change, the standard Geometrical \(+\) Maxwell fit to the data set 7730a. \\
**HC2** & - & use the alternative high field correction described in section2.2. \\
**CT2** & - & use the alternative carriage tilt correction described in section 5.3. \\
**noMD** & - & remove the mapper dipoles correction. \\
**Zonly** & - & fit to the B\({}_{\rm z}\) component of the field only \\
**ZRF** & - & fit to all three field components \\
**Bmod** & - & fit to the modulus of the field \\
**5000sc** & - & compare with the standard fit to data set 5000, scaled up by the ratio of the NMR values. \\ \end{tabular}

We quantify the effect of these changes by showing the fitted parameter values in table 5. There are two interesting measures of the sagitta quality \(\delta\)S/S; the difference between the modified fit and the data on the left of table 6 and the difference between the modified fit and the standard fit in the right of table 6.

\begin{table}
\begin{tabular}{|l|c|c|c|c|c|c|c|c|} \hline Map & \multicolumn{3}{c|}{Offsets (mm)} & \multicolumn{2}{c|}{Angl (mrad)} & \multicolumn{2}{c|}{Scale factors} & \multicolumn{2}{c|}{Field at centre} \\ \hline  & x & y & z & A\({}_{\rm x}\) & A\({}_{\rm y}\) & z & r & (Tesla) & \% iron \\ \hline None & 0.26 & -2.42 & 0.51 & -0.09 & 0.19 & 1.00121 & 0.99926 & 1.99779 & 4.052 \\ \hline HC2 & 0.26 & -2.42 & 0.51 & -0.09 & 0.19 & 1.00120 & 0.99925 & 1.99784 & 4.053 \\ \hline CT2 & 0.27 & -2.39 & 0.51 & +0.13 & 0.09 & 1.00121 & 0.99926 & 1.99779 & 4.052 \\ \hline noMD & 0.26 & -2.42 & 0.51 & -0.09 & 0.19 & 1.00121 & 0.99926 & 1.99779 & 4.053 \\ \hline Zonly & 0.18 & -2.04 & 0.52 & -0.01 & 0.08 & 1.00124 & 0.99930 & 1.99779 & 4.055 \\ \hline ZRF & 0.29 & -2.49 & 0.51 & -0.05 & 0.20 & 1.00121 & 0.99926 & 1.99779 & 4.052 \\ \hline Bmod & 0.11 & -2.08 & 0.48 & +0.03 & 0.05 & 1.00119 & 0.99916 & 1.99779 & 4.049 \\ \hline
5000s & 0.44 & -2.52 & 0.36 & -0.11 & 0.20 & 1.00159 & 0.99900 & 1.99834 & 4.108 \\ \hline \end{tabular}
\end{table}
Table 5: Parameter values found by reasonable alternative fits.

\begin{table}
\begin{tabular}{|l|c|c|c|} \hline Map & \multicolumn{2}{c|}{Modified fit - Data} & \multicolumn{2}{c|}{Modified fit – Standard fit} \\  & \(\delta\)S/S (\(\times 10^{4}\)) & \multicolumn{2}{c|}{\(\delta\)S/S (\(\times 10^{4}\))} \\ \hline  & r.m.s. & extreme & mean & r.m.s. \\ \hline None & **1.40** & +7.3 & 0.00 & 0.00 \\ \hline HC2 & 1.60 & +7.9 & -0.02 & **0.28** \\ \hline CT2 & 1.29 & +6.5 & +0.01 & **6.44** \\ \hline noMD & 1.50 & +7.1 & +0.01 & **0.09** \\ \hline Zonly & 1.41 & +7.4 & -0.14 & 0.20 \\ \hline ZRF & 1.40 & +7.3 & 0.00 & 0.02 \\ \hline Bmod & 1.41 & +7.4 & +0.25 & **0.36** \\ \hline
5000sc & 1.75 & +6.8 & -2.54 & 3.50 \\ \hline \end{tabular}
\end{table}
Table 6: Quality indicators of the difference between alternative fits and the standard fit.

For our final shape error estimate we combine in quadrature the numbers shown in bold in table 6. We select HC2, CT2 and noMD as being real uncertainties. Among the choices of field components to fit we select Bmod because this causes the biggest change. We do not use 5000sc but we include it in the table as a somewhat independent estimate of several systematic errors combined. We include the shape error due to the difference between the data and the standard fit. The resulting total shape error on \(\delta\)S/S is 6.6 \(\times 10^{-4}\).

The overall scale uncertainty applies to all of our fits and comes from the limited accuracy with which we can match up the Hall and the NMR scales. There are two parts to this. One part comes from the spread of the NMR-Hall difference over the 4 NMR probes. We take the r.m.s. of the difference evaluated by the extrapolation method; 0.25 mT giving \(\delta\)S/S = 1.25 \(\times 10^{-4}\). We do not feel that it is safe to divide the r.m.s. by \(\surd\)n in this case because it is not really a random error. The other part comes from the way that any NMR-Hall comparison is influenced by the weld thickness used in our conductor model. Figure 16 shows the field magnitude measured by the four outermost Hall probes in a fine z scan compared with field models from the geometrical fit. All parameters have their best fit values except that the weld thickness in the conductor model has been varied from 1.8 to 1.9 times the average pitch. A model in which the weld has the same pitch as other turns is also shown for comparison. Each model has been normalised to match the data at the \(\pm 0.5\) m points. By inspection of this plot we estimate that our multiplier for the weld pitch should be 1.85 with uncertainty \(\pm\) 0.03. This uncertainty in the weld pitch changes the ratio of the field at the NMR probe position to the field in the bulk of the mapped volume by \(\pm\)\(1.7\times 10^{-4}\), therefore it changes the result of the Hall to NMR normalisation by the same amount and this feeds directly into the scale error. We combine the two scale errors together in quadrature to get an overall \(\delta\)S/S scale error of \(2.1\times 10^{-4}\).

The total of scale and shape errors amounts to 6.9 \(\times 10^{-4}\). Since the shape errors depend strongly on rapidity we plot them as a function of rapidity in figure 17. This shows that the total sagitta error is dominated by the scale at low rapidity and by the shape at high rapidity. The shape error at high rapidity is dominated by our uncertainty about the orientation of the mapping machine rotation axis, which appears as the 0.2 mrad change in angle A\({}_{\rm x}\) between rows 1 and 3 in table 5.

Figure 16: Field magnitude measured by the four Hall probes at 1.058 m, plotted versus z and compared with field models having various pitches for the centre weld. The asymmetry is dues to a slight difference in pitch between the windings on the two sides of the weld, which is included in the field model.

## 7 Conclusion

We have mapped the ATLAS solenoid field and found a function which obeys Maxwell and matches each component of the data to 0.5 mT r.m.s. There are a few residuals of up to 5 mT on the edges of the Inner Detector volume but they do not extend far enough inside to have a significant bending effect on tracks. The relative error on track sagitta due to the field uncertainty, \(\delta\)S/S, varies from 0.023% at low rapidity to 0.12% at high rapidity, including a scale uncertainty of 0.021% which is independent of rapidity. There is an uncertainty of 0.2 milliradians in the direction of the field axis relative to the IWV coordinate system and this is the dominant source of uncertainty on \(\delta\)S/S at high rapidity.

## Acknowledgements

We would like to acknowledge the support of the ATLAS collaboration as a whole, and in particular the teams who have built and run the solenoid. We thank the Grenoble High Magnetic Field Laboratory for the generous offer of their facilities, which made the high field calibration of our probes possible.

## References

* [1] A. Yamamoto et al., _The ATLAS Central Solenoid technical design report_, CERN-LHCC-97-21, ATLAS TDR-9 (1997).
* [2] F. Bergsma et al., _The ATLAS pneumatic solenoid mapper_, Proceedings of the 15\({}^{\mathrm{th}}\) International Magnetic Measurement Workshop, FNAL (2007).
* [3] S.W. Snow, _Specification of the NMR system_, ATLAS Note ATL-IC-ES-0021 (2005).
* [4] H.H.J. ten Kate, _ATLAS superconducting magnet system status_, _IEEE Trans. Appl. Superconductivity_**17** (2007) 1191.
* [5] F. Bergsma, _Calibration of Hall sensors in three dimensions_, Proceedings of the13\({}^{\mathrm{th}}\) International Magnetic Measurement Workshop, SLAC (2003).
* [6] M. Aleksa et al., _Measurement of the solenoid magnetic field_, ATLAS Note ATL-MAGNET-PUB-2007-001 (2007).
* [7] R.J.M.Y. Ruber, _Solenoid main parameters,_ ATLAS Note ATL-S-EN-0002 (2006).

Figure 17: Sagitta error versus rapidity.