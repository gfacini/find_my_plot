ATLAS Internal Note

MUON-No-092

**RASNIK Image Processing with a Steepest Ascent Algorithm**

Kevan S. Hashemi and James R. Bensinger

Brandeis University

August 1995

Introduction

The RASNIK alignment instrument was developed at NIKHEF [1]. A light-emitting diode (LED) illuminates a chessboard mask while a lens focuses an image of the mask onto a light-sensitive charge-coupled device (CCD). Most often, the lens is midway between the mask and the CCD, so that the length of the instrument is four times the focal length of the lens. Should the lens move in the plane perpendicular to its axis, the mask image on the CCD will move also, and in the same direction. Thus one can measure movement of the lens by measuring the movement of the mask image across the CCD. To this end, the picture taken by the CCD (the CCD image) is digitized and passed to a computer for analysis. The computer executes a fitting procedure to determine the orientation, magnification, and offset of the mask image upon the CCD.

At NIKHEF, analysis of the CCD image is performed in the following way. The image is smoothed and differentiated. The maxima of the differentiated image are assumed to be the edges of the chessboard squares in the CCD image. A chessboard, specified by five parameters (two periods, two displacements, and one tilt), is fitted by chi-squares so as to minimize the root mean square (rms) distance between the edges of its own squares and the edges of the CCD image squares.

The NIKHEF edge-detecting procedure works well for sharply defined images such as those taken from RASNIK instruments with only a few meters between the mask and CCD. In 5.7 m long instruments,however, experimenters at NIKHEF report [2] that some images cannot be analyzed with the edge-detecting procedure. In 8 m or longer instruments, such as those required by the ATLAS front end muon system, the procedure fails. In such instruments, diffraction at the lens aperture and imperfections in the surface of the lens conspire to blur the mask image. Furthermore, because the mask image intensity reduces with the distance between the mask and the lens, camera noise becomes a more significant part of the CCD image.

An alternative to the NIKHEF procedure, called the _steepest ascent fitting procedure_, has been developed at Brandeis University. It is designed to extract displacement, tilt, and magnification information from the dim and blurred images of 12-m RASNIK instruments.

Figure 1: The steepest ascent fitting procedure screen output during the final stage of normal operation. The grid lines represent the current fit, and are superimposed upon a reproduction of the CCD image for comparison. Note the irregular squares in the image, which are included in the procedureâ€™s calculation of correlation.

The procedure repeatedly adjusts the orientation, displacement, and two-dimensional periodicity of a chessboard-like pattern, which we shall call the _fit_, so as to maximize the correlation between it and the CCD image. When the procedure terminates, the fit is assumed to be an accurate match to whatever chessboard-like pattern may be contained in the image. The fit pattern has intensity

\[\cos(2\pi\frac{x}{T_{x}})\cos(2\pi\frac{y}{T_{y}}),\]

where \(x\) and \(y\) are orthogonal coordinates rotated and displaced with respect to the row and column coordinates of the CCD image. Five parameters define the fit. Two parameters specify the displacement of the \(xy\) coordinate system with respect to the top left corner of the CCD image. One parameter specifies the rotation of the \(xy\) coordinate system with respect to the row and column coordinates of the CCD image. The final two parameters are \(T_{x}\) and \(T_{y}\), which specify the pattern's periodicity in the \(x\) and \(y\) directions.

The procedure calculates the correlation between the fit and the CCD image by summing the products of their two intensities at a sequence of uniformly distributed sampling points. By calculating the change in correlation for small changes in each of the five parameters of the fit, the procedure obtains an estimate of the gradient of correlation in parameter-space. Starting at a random point in this space, the procedure repeatedly moves in the direction of the correlation gradient. After a predetermined number of moves, the process terminates, and the final fit is assumed to match whatever pattern is contained in the CCD image.

In theory, with an infinite CCD image and closely spaced sampling points, the correlation between the fit and the CCD image will be zero except for a perfect match between the two. In practice, however, the correlation is calculated over a finite fitting area within a CCD image. The smaller the fitting area, the more gradually the correlation increases as one approaches a perfect fit, and the wider the range of fits for which the correlation is positive. The steepest ascent fitting procedure starts off with a fitting area of only 36 grid squares to obtain an approximate fit, moves on to an area of 144 squares to improve the fit, and ends by performing its calculations upon the entire CCD image.

The mask of a RASNIK instrument contains irregularities designed to allow the fitting procedure to resolve ambiguity in its calculation of mask image location. These irregularities take the form of reversed (wrong parity) squares in the mask's chessboard pattern. Such squares number fewer than one in every twenty. Normally, the steepest ascent fitting procedure includes irregular squares in its fitting area along with all other features of the CCD image. The procedure can, however, extend its operation to a final stage in which irregular squares are excluded, but this has been found to have little effect upon the final fit. In Figure 1, which is a copy of the procedure's screen output during the final stage of normal operation, the inclusion of irregular squares in the fitting area is clear to see.

Performance of the Steepest Ascent Procedure

We set up RASNIK instruments 7 cm, 4 m, and 8 m long. In 4 m and 8 m instruments we placed lenses of diameter 50 mm. Using the 8-m instrument, we can simulate the optical properties of a 12-m instrument by reducing the lens aperture. Reducing the aperture to 33 mm causes diffraction equivalent to that which would occur with a 50 mm lens in a 12-m instrument. Thus we are able to test the performance of our fitting procedure upon CCD images corresponding to 7-cm, 4-m, 8-m, and 12-m RASNIK instruments. Figure 2 shows examples of such images. The mask we use was supplied by NIKHEF, according to whom its squares have sides 170 \(\upmu\)m. The CCD is part of a Chinon CX-103 camera. It provides an array of 640 by 480 light-sensitive pixels, each 6.7 micrometers square.

Given a RASNIK instrument with lens, mask, and CCD in fixed relation to one another, we might expect successive CCD images to be identical. Air turbulence in the light path, however, causes the mask image to move upon the CCD. Thus the mask pattern moves within the CCD image, erroneously suggesting movement of the lens. Air turbulence in the light path is greatly reduced by enclosing the RASNIK instrument in a tube. This has been done at NIKHEF, but not yet at Brandeis. We shall refer to errors introduced into a RASNIK measurement by erroneous movement of the mask image across the CCD as _image errors_, while errors caused by the inaccuracy of the fitting procedure shall be called _fitting errors_.

One source of fitting errors in the steepest ascent procedure is its non-determinism. The procedure begins with random parameters, and so produces a different answer every time, even when applied to the same image. Table 1 gives the standard deviation of displacement, \(\sigma\)(xy), and tilt, \(\sigma\)(\(\theta\)), for 16 applications of the fitting procedure to each of the images in Figure 1.

\begin{table}
\begin{tabular}{|c|c|c|} \hline \multicolumn{2}{|c|}{Fitting Errors for Various RASNIK Instruments} \\ \hline Image & \(\sigma\)(xy) & \(\sigma\)(\(\theta\)) \\ (RASNIK length) & (\(\mu\)m) & (mrad) \\ \hline
7 cm & 4.6 & 0.8 \\
4 m & 3.3 & 0.8 \\
8 m & 1.1 & 0.3 \\
12 m & 1.4 & 0.5 \\ \hline \end{tabular}
\end{table}
Table 1: Fitting Errors

Figure 2: CCD images taken from RASNIK instruments of four different lengths.

The procedure used to obtain the data given above uses only one in every 100 pixels for its calculations. Consequently, aliasing occurs with the sharply defined edges of the 7-cm and 4-m images. Modifying the procedure so as to sample one in every 21 pixels, \(\sigma\)(xy) for the 7-cm image was reduced from 4.6 \(\upmu\)m to 2.9 \(\upmu\)m. Sampling one in every 7 pixels, \(\sigma\)(xy) was reduced to 1.2 \(\upmu\)m. Nevertheless, when sampling only one in every 100 pixels, the same fitting procedure has been found to analyze, without fail, any image from any RASNIK instrument between 7 cm and 12 m long. In all cases, \(\sigma\)(xy) is less than 5 \(\upmu\)m, which, in a symmetric RASNIK instrument, corresponds to an uncertainty in the calculation of lens position of less than 2.5 \(\upmu\)m rms.

In an attempt to observe image errors in our 8-m instrument, we recorded 16 successive images without moving any part of the instrument, and applied our fitting procedure to each image 16 times. Whereas \(\sigma\)(xy) and \(\sigma\)(\(\theta\)) for any given image were typically 1.1 \(\upmu\)m and 0.3 mrad respectively, the standard deviations for all images taken together were 2.6 \(\upmu\)m and 1.0 mrad respectively. We conclude, therefore, that the image errors in our 8-m instrument are roughly 3 \(\upmu\)m rms for displacement, and 1 mrad rms for tilt.

To test the performance of the fitting routine, we moved the lens in 20\(\upmu\)m steps over a distance of 200\(\upmu\)m perpendicular to its axis. At each step we recorded one CCD image and applied the fitting procedure to the image once only. For a symmetric RASNIK instrument, such as our 8-m instrument, image displacement is expected to be twice lens displacement. In our experiment, the straight line fitted to the graph of calculated image displacement vs. lens micrometer reading had slope 2.0 \(\upmu\)m/\(\upmu\)m. Image displacement residuals from the fit were 10\(\upmu\)m rms (corresponding to 5\(\upmu\)m rms with respect to lens displacement). These residuals were dominated by the setting error of the micrometer stage rather than by errors in the RASNIK instrument.

In another experiment, we tilted the CCD in 2 degree steps through a total of 20 degrees. At each step we recorded one CCD image and applied the fitting procedure to the image once only. A straight line fit to the graph of calculated mask tilt vs. lens mount reading produced a slope of 1.00 rad/rad with residuals 1 mrad rms.

The fitting procedure also measures the magnification of the mask image by determining the sizes of its chessboard squares. At present, fitting errors from a single measurement introduce an uncertainty of 0.1% rms into the calculation of mask image magnification for the 8-m instrument, while image errors introduce an uncertainty of 0.2% rms.

Future Work

We hope to reduce greatly the execution time of the steepest ascent fitting procedure by improving its implementation and by careful study of its convergence. Our current experimental procedure executes in 17 seconds on a Macintosh Power PC 7100/66, while supporting a significant overhead in screen display and diagnostic routines. With proper implementation, perhaps in a frame store equipped with a digital signal processor, we expect the execution time to be reduced to less than 2 seconds. We hope also to improve the fitting procedure's measurement of mask image magnification.

Conclusion

For measuring the displacement and tilt of the mask image, the steepest ascent fitting procedure works adequately. In a symmetric 12-m RASNIK instrument, it introduces errors of only 0.7 \(\upmu\)m rms into the measurement of lens displacement, and 0.5 mrad rms into the measurement of mask rotation. The same procedure, without any modification, has been found to analyze successfully, without fail, any image from any RASNIK instrument of 7 cm to 12 m long.

References

[1] ATLAS Collaboration, _Technical Proposal_, CERN/LHCC/94-43

[2] Astrid van der Horst, Harry van der Graaf, _Measurements on RASNIK_, NIKHEF internal report, February 1995.