**ATLAS Internal Note**

**LARG-NO-80**

**16 September 1997**

**Strenghs and weaknesses of digital filtering**

Y. Jacquier, C. de La Taille, I. Nikolic, L. Serin

Laboratoire de l'Accelerateur Lineaire,

IN2P3-CNRS et Universite Paris-Sud

91405 Orsay Cedex, France.

**Abstract**

The use of digital filtering to achieve the best signal to noise ratio, over a wide range of luminosities, is required for the ATLAS electromagnetic calorimeter. A theoretical frequency analysis of this method, validated by experimental measurements, explains its potential limitations : spectral aliasing exacerbates any 40 MHz or high frequency noise floor. The application of the method to the ATLAS environment with the pile-up noise shows that the use of the chosen shaper time constant (\(\tau=13\) ns) is not the best to cover the full luminosity range : the use of a longer shaper time constant or a system with two shaper time constants are suggested.

Introduction

Recent results [1] have shown that the reduction in electronic noise obtained with digital filtering at very low luminosity was not as high as expected and used in the ATLAS simulation [2]. The goal of this note is to review what can be obtained with digital filtering and to explain the limitations for very low luminosity with the electronic chain designed for the ATLAS electromagnetic calorimeter. The basic principles of the digital filtering method are briefly recalled. A theoretical analysis of the effect of the digital filtering in the frequency domain is described and explains some limitations. To consolidate these computations, experimental measurements have been performed and are presented. Finally the implication for ATLAS are summarized as well as suggestions to improve the electronic noise at very low luminosity.

## 2 Digital filtering method

The ATLAS electronic chain of the electromagnetic calorimeter has been designed to obtain the best performances at high luminosity of \(10^{34}\) cm\({}^{-2}\)s\({}^{-1}\)[3]. An analog filter (CR RC2 shaper) with a time constant \(\tau\), is used to minimize the quadratic sum of the pile-up noise (which increases as \(\sqrt{\tau}\)) and the electronic noise (which varies as \(\tau^{-\frac{1}{2}}\) [1]). In order to have a unique shaper over the full rapidity coverage, the optimal shaper time constant has been chosen \(\tau=13\) ns. At high luminosity, the pile-up contribution is then \(\sqrt{3}\) times the electronic noise [4]. At lower luminosity, the same optimization provides a larger time constant \(\tau_{opt}\) which scales as \({\cal L}^{\frac{1}{4}}\). The use of only one shaper time constant in ATLAS implies to find a software method to artificially slow down (or accelerate) the signal. This is the role devoted to the digital filtering.

Footnote 2: except small time jitter on the clock frequency

The method consists in using the information contained in the \(N\) (5 in ATLAS) samples recorded at a given sampling frequency. Indeed as the noise at the shaper output is correlated in time by the shaping function, one can sum the \(N\) samples keeping the signal constant, with respect to one sample, with appropriate weights which take into account this autocorrelation. This results in an improvement of the signal to noise ratio.

As in our case the phase of the signal with respect to the sampling clock is constant 3, only the optimization of the reconstructed energy will be considered. More details about this derivation and about compensation of time delays can be found in [5]. The signal reconstructed by this method is :

Footnote 3: This is only true for fast shaping when the parallel noise which varies as \(\tau^{-\frac{1}{2}}\) can be omitted

Footnote 3: except small time jitter on the clock frequency

\[S=\sum_{i=1}^{N}a_{i}s_{i}=A\sum_{i=1}^{N}a_{i}g_{i}+\sum_{i=1}^{N}a_{i}n_{i}\]

where \(s_{i}\) is the signal s sampled at time \(t_{i}\), \(n_{i}\) the noise and \(g_{i}\) the normalized signal. A is the maximal amplitude of the signal to be measured with the best accuracy. The coefficients \(a_{i}\) are obtained by minimizing the variance of S with the constraint \(\sum_{i=1}^{N}a_{i}g_{i}=1\). This gives in vector notation :

\[\vec{a}\propto R^{-1}\vec{g}\]

R is the autocorrelation matrix (\(R_{ij}=<n_{i}n_{j}>\)). The proportionality factor is determined by properly normalizing the \(a_{i}\) such that \(\sum_{i=1}^{N}a_{i}g_{i}=1\)Theoretical analysis in the frequency domain

### Transfer function of the digital filtering

The shaping obtained using weighted samples on a waveform is a particular case of the digital filtering theory, usually referred to as Finite Impulse Response filters (FIR). A correspondence with the transfer functions can be calculated using the Z transform : If a signal \(x(t)\) is sampled at a period \(T_{e}\) giving samples values : \(x_{k}=x(kT_{e})\), the Z-transform of \(x(t)\) is \(x(Z)\) defined as :

\[x(Z)=\sum_{k=-\infty}^{k=+\infty}x_{k}Z^{-k}\]

The digital filter output \(y_{k}\) is a weighted sum of 5 preceding samples of \(x\) :

\[y_{k}=a_{0}x_{k-1}+a_{1}x_{k-3}+a_{2}x_{k-2}+a_{3}x_{k-1}+a_{4}x_{k}=\sum_{i=0 }^{i=4}a_{i}x_{k+i-4}\]

Taking the Z-transform of \(y\) yields :

\[y(Z)=\sum_{k=-\infty}^{k=+\infty}\sum_{i=0}^{i=4}a_{i}x_{k+i-4}Z^{-k}\]

inverting the sums and letting \(l=k+i-4\)

\[y(Z)=\sum_{i=0}^{i=4}a_{i}Z^{-4}\sum_{l=-\infty}^{l=+\infty}x_{l}Z^{-l}=\sum_{i =0}^{i=4}a_{i}Z^{i-4}x(Z)\]

from which we deduce the transfer function of the filter :

\[H_{df}(Z)=a_{0}Z^{-4}+a_{1}Z^{-3}+a_{2}Z^{-2}+a_{3}Z^{-1}+a_{4}\]

This function can be expressed in the frequency domain by letting : \(Z=e^{j\omega T_{e}}\) which corresponds to the delay \(T_{e}\) in the frequency domain. Its modulus is plotted in Figure 1 with \(T_{e}\)=25 ns for two sets of coefficients, corresponding to two extreme luminosities : \({\cal L}\to 0\) and \({\cal L}\to 3.10^{34}\) cm\({}^{-2}\)s\({}^{-1}\). For low luminosity, the digital filter can be seen as a low pass filter with a cutoff frequency \(f_{c}\)=4 MHz, resulting in a slower output signal. On the other hand, the digital filter found at high luminosity is a pass-band one, centered around 10 MHz. The bumps which appear every 40 MHz correspond to the aliasing of the spectrum at multiples of the sampling frequency, which is inherent to any sampling process3. It will be shown that they can degrade significantly the noise performance.

Footnote 3: In the time domain, the sampling process corresponds to the multiplication of the signal by a ‘comb’ of deltas spaced by \(T_{e}\). In the frequency domain, this corresponds to the _convolution_ of the spectra by a ‘comb’ of deltas spaced by \(F_{e}\), which results in the replication of the original spectrum every multiple of the sampling frequency.

### Noise spectrum with an ideal preamp

This digital filter follows the CR RC\({}^{2}\) analog filter chosen to optimize the signal to noise ratio at nominal luminosity (\({\cal L}=10^{34}\) cm\({}^{-2}\)s\({}^{-1}\)) [6] whose transfer function is :

\[H_{af}(j\omega)=\frac{j\omega\tau}{(1+j\omega\tau)^{3}}\]in which \(\tau\) (= 13 ns) is the shaper time constant. The overall transfer function of the two cascaded filters is the product of the two transfer functions shown in Figure 1.

Knowing the transfer functions in the frequency domain allows to calculate the noise easily. Assuming an ideal current preamplifier connected directly to a detector capacitance \(C_{d}\), the noise spectral density at the preamplifier output is given by [6] :

\[S_{v}^{pa}(\omega)=R_{f}^{2}(\omega^{2}C_{d}^{2}e_{n}^{2}+i_{n}^{2})\]

in which \(R_{f}\) is the preamp transimpedance and \(e_{n}\) and \(i_{n}\) the series and parallel white noise generators. Multiplying this spectrum by the transfer functions of the two filters

Figure 1: _Typical transfer functions for the signal obtained with multiple sampling. The coefficients are calculated to optimize the quadratic sum of electronic noise and pile-up noise for low or high luminosity. The top curve corresponds to low luminosity, giving : \(a_{i}\) = (0.173, 0.337, 0.404, 0.312, 0.280) and the bottom curve to a high luminosity (\(\mathcal{L}\) = 3.10\({}^{3}\)\({}^{4}\) cm\({}^{-2}\)s\({}^{-1}\)) \(a_{i}\) = (-0.685, 0.458, 0.690, 0.131, -0.160). The electronic noise is given here for a current preamp connected directly to a detector capacitance of \(C_{d}\)=1.5 nF, followed by a CR RC\({}^{2}\) filter with \(\tau\) =15 ns. The transfer function of this analog part is shown dashed._

and integrating over the whole frequency domain yields the _rms_ noise :

\[v_{n}^{2}=\int_{0}^{\infty}S_{v}^{pa}(\omega)\big{|}H_{a\,f}(j\omega)\big{|}^{2} \big{|}H_{df}(e^{j\omega T_{*}})\big{|}^{2}\,\frac{d\omega}{2\pi}\]

The spectra are shown in Figure 2, assuming only series noise. The solid line represents the noise spectrum after the analog filter : the low frequencies are attenuated with a slope of -20dB/decade which reduces pile-up noise, whereas the high frequency noise rolls off with a slope of -20dB/decade 4.

Footnote 4: When \(\omega\to\infty\), \(\sqrt{S_{v}^{sh}(\omega)}\sim 1/\omega\)

It can be seen that the digital filter is effectively cutting down high frequency noise and achieves a lower central frequency. However, the frequencies around 40 MHz are not

Figure 2: _Top : spectral density of electronics noise at shaper output, \(S_{v}^{sh}(f)\) (solid) after multiple sampling (dashed) and at the output of a CR RC\({}^{6}\) shaper giving the same pile-up integral (dots). The preamplifier is an ideal current preamp with no cable and only series noise. Bottom : integrated noise of the three spectral densities described above (= \((\int_{0}^{f}S_{v}^{sh}(f)df)^{\frac{1}{2}}\)). The utmost right point gives the rms noise. This shows the noise improvement obtained with digital filtering as well as the net contribution of the bump at 40 MHz_

reduced5, which adds significantly to the total noise. This is particularly visible in the integrated noise (bottom plot), which shows that the bumps almost double the noise ; only a factor 1.66 on reduction noise is reached. It is interesting to compare the performance achieved with the digital filter to what would be achieved by hardware. Keeping the same analog filter, but changing its central frequency to obtain the same pile-up integral, shows a reduction by a factor around 2.5 of the electronic noise, consistent with the scaling in \(\tau^{-3/2}\). The digital filter would do even better6 were it not the bumps.

Footnote 5: This effect is a classical spectral aliasing due to noise components beyond the Nyquist frequency of 20 MHz. As explained above, the process of sampling replicates the original spectrum at all the multiple of the sampling frequency, which can pile up if the original spectrum extends beyond \(f_{\epsilon}/2\).

Footnote 6: This is because the signal is more symmetrical, and corresponds to a much higher order filter CR RC\({}^{n}\)

The degradation due to the bumps is particularly noticeable with the CR RC\({}^{2}\) filter, as the high frequencies roll off with a slope of only -20 dB/decade for the series noise. The use of a higher order filter7 which attenuates much more strongly the high frequencies, would therefore alleviate the problem, as shown in Figure 3 with a CR-RC\({}^{6}\).

Footnote 7: An antialiasing filter would look very attractive to remove the bumps, but its temporal response is not acceptable as it ”rings” too much (such a filter is optimized to be flat then steep in the frequency domain, using poles with large imaginary part which does not give a smooth temporal response)

Figure 3: _Spectral density of electronics noise with a CR RC\({}^{6}\) shaper (solid) and after multiple sampling (dashed)_

### Noise spectrum with \(\emptyset\)T preamps

The same spectra calculations can be performed using a warm current preamplifier terminating a cable of length \(t_{d}\)[7]. In that case, the noise spectrum at the preamplifier output is slightly more complicated as the line impedance \(Z(\omega)\) seen for the noise generators from the preamp side is a complex function of frequency :

\[Z(\omega)=jR_{0}\frac{\omega R_{0}C_{d}\tan\omega t_{d}-1}{R_{0}+\tan\omega t_{d}}\]

Figure 4: _Top : Noise spectral density at the shaper output (solid) and after multiple sampling (dashed). The preamplifier is a 25 \(\Omega\)\(\emptyset\)T preamp connected to \(C_{d}\) = 1.5 nF through a 3 meter cable. It assumes a series noise \(e_{n}\) = 0.4 nV/\(\surd\)Hz and a parallel noise \(i_{n}\) = 10 pA/\(\surd\)Hz. The ripples on the solid curve are due to the cable. Bottom : integrated noise of the two spectral densities described above, the total rms noise being at the right end. The noise improvement obtained with digital filtering is around 1.8, as the 40 MHz bump is well attenuated._giving a noise spectral density :

\[S_{v}(\omega)=R_{f}^{2}\frac{e_{n}^{2}+|Z(\omega)|^{2}i_{n}^{2}}{|R_{0}+Z(\omega)| ^{2}}\]

in which \(R_{0}\) is the line characteristic impedance, \(t_{d}\) its length, \(C_{d}\) the detector capacitance, \(e_{n}\) and \(i_{n}\) the series and parallel noise generators and \(R_{f}\) the preamp transimpedance. This spectrum is shown in Figure 4; it exhibits high frequency ripples due to eigen modes in the cable. The rest of the calculation after filtering is identical to the previous section and the results are shown in Figure 4 assuming a \(\emptyset\)T preamp with a 3 meter cable and the actual series and parallel noise values. It appears that the 40 MHz bumps are now much smaller as the noise central frequency is lower and the high frequency roll off steeper 8, both effects being due to the input pole \(R_{0}C_{d}\). The integrated noise exhibits no step for the digital filtering and yields a noise improvement of 1.8, which is very close to the actual measurements (see section 4.2)

Footnote 8: Due to the cable and the reflections for the \(\emptyset\)T, the noise is not directly integrated on the detector capacitance and the total noise behaves as a parallel noise with a -40 dB/decade attenuation contrary to the -20 dB/decade attenuation of the series noise of the CR-RC\({}^{2}\).

## 4 Experimental measurements

To evaluate the noise reduction with digital filtering and perform comparison with the theoretical frequency analysis, signal and noise data have been recorded with a sampling interval of 2.5 ns using a Lecroy oscilloscope connected to a PC computer by GPIB. Using a CR RC\({}^{2}\) shaper whose time constant \(\tau\) is adjustable by step over the 5-100 ns range, three sets of data were taken :

* The CR RC\({}^{2}\) alone, considered as a ideal preamp, with a 400 pF capacitance simulating the detector. This will be referred as pure CR RC\({}^{2}\) in the following. With this setup the parallel noise is negligible but not the output stage noise of the shaper seen as a floor noise although the shaper gain is about 100. These data are used to illustrate the bumps effect. Data were also taken with a CR RC\({}^{6}\) filter.
* A \(\emptyset\)T preamplifier (ATLAS design [3]) connected by a 3 meter 25 \(\Omega\) axon cable to a 1500 pF capacitance in order to simulate conditions similar to the middle sampling of the ATLAS electromagnetic calorimeter, and followed by the CR RC\({}^{2}\) variable shaper.
* A 50 \(\Omega\)\(\emptyset\)T preamplifier (RD3 design [8] connected by a lemo cable to a 400 pF capacitance, used to simulated the strips compartment of the calorimeter.

For each \(\tau\) value, the signal consists of the response to the described system to a calibration signal 9 and the noise data of a sample 40000 measurements recorded over 100 \(\mu\)s.

Footnote 9: A rigorous analysis would have required a triangular input signal instead of the calibration signal. Meanwhile the small change in signal shape has very little influence on these results.

### Comparison with theoretical predictions

In order to illustrate the method and compare with the previous theoretical calculations, the experimental results for the \(\emptyset\)T with \(C_{d}=1500\) pF are briefly described. The same procedure has been applied to each set of measurements.

The theoretical and the experimental autocorrelation functions are shown in Figure 5. The experimental function is extracted from noise measurement. Assuming that the series and parallel noise are not correlated, the theoretical autocorrelation function is defined as :

\[\rho_{t}(t)=\alpha\rho_{s}(t)+(1-\alpha)\rho_{\rho}(t)\]

where \(\alpha=\sigma_{s}^{2}/\sigma_{tot}^{2}\) is a relative weight between the series and parallel contribution. This parameter has been adjusted to reproduce the experimental data and has been found equal to 0.7 ; this means that the series noise represents 83% of the total noise. This is only correct for a given cable length as the series and parallel noise autocorrelation function are strongly dependent on the cable length.

Having the calibration signal (an example is shown in Figure 6 with \(\tau=15\) ns and \(C_{d}=1500\) pF) and the autocorrelation function, the optimal coefficients have been determined taking into account the constraint \(\Sigma a_{i}g_{i}=1\). The values of the signal, the autocorrelation matrix, and the optimal coefficients are given in Table 1.

\begin{table}
\begin{tabular}{|c|c|c|c|c|c|} \hline  & 0 ns & 25 ns & 50 ns & 75 ns & 100 ns \\ \hline signal \(g_{i}\) & 0.012 & 0.630 & 1.00 & 0.803 & 0.467 \\ autocorrelation \(R_{ij}\) & 1.00 & 0.107 & -0.309 & -0.232 & -0.030 \\ coefficients \(a_{i}\) & 0.173 & 0.337 & 0.404 & 0.312 & 0.280 \\ \hline \end{tabular}
\end{table}
Table 1: _The values of the autocorrelation matrix, of the signal an d the optimal coefficients at low luminosity for the \(\emptyset\)T with \(C_{d}=1500\) pF and \(d\) for \(\tau=15\) ns._

Figure 5: _The autocorrelation function for the \(\emptyset\)T with \(C_{d}\) =1500 pF and \(\tau=15\) ns. (a) contains the contribution of the series and the parallel noise to the total autocorrelation function. (b) contains the experimental autocorrelation function compared to the theoretical one. The series noise is 83 % of the total noise._

The noise reduction factor due to the use of digital filtering (DF) is defined as :

\[G=\frac{S_{DF}/N_{DF}}{S_{1}/N_{1}}\]

where \(S/N\) is the signal to noise ratio in the case where digital filtering is used (\(DF\)), and in the case where only one sample at signal peak is used (1). As the constraint \(\Sigma a_{i}g_{i}=1\) is applied, for a given value of the shaper time constant \(\tau\), the signal remains unchanged, and thus the reduction factor is simply given by :

\[G=\frac{N_{1}}{N_{DF}}\]

The coefficients \(a_{i}\) are applied to noise events, giving a new distribution of the noise, and the value of \(N_{DF}\). With the previous values of the \(a_{i}\) coefficients, the noise reduction factor is 1.8 in agreement with the expectation 10

Footnote 10: The factor thus obtained is directly comparable to the ratio of the noise obtained with the optimal filtering and the noise obtained using only one sample and can also be easily calculated :

\[\frac{\sigma_{DF}^{2}}{\sigma^{2}}=\sum a_{i}^{2}+2[(\sum a_{i}a_{i+1})R(T)+( \sum a_{i}a_{i+2})R(2T)+...]\]

\(R(T)\) is the autocorrelation between the first and the second sample, \(R(2T)\) the autocorrelation between the first and the third sample... With the numbers in Table 1, it provides a factor 1.77.

Once the coefficients are determined, the original calibration signal can be convoluted with them and the signal after digital filtering is obtained and shown in Figure 6. The theoretical calibration signal is shown as well. The agreement between the theoretical

Figure 6: _The experimental calibration signal (open circles) and the convoluted signal after digital filtering (full circles) for the \(\emptyset\)T with \(\tau=15ns\) and \(C_{d}=1500\) pF. Full lines are the theoretical calibration signal before and after the convolution with the digital filtering coefficients._

and the measured signal is again satisfactory. The convoluted signal is obviously slower than the original one, and does not have the same shape as would have a CR RC\({}^{2}\) shaper with a larger time constant.

### Noise improvement with digital filtering

#### 4.2.1 The pure CR RC\({}^{2}\) case

The CR RC\({}^{2}\) case is described first, as it illustrates well the effect of the bumps at frequencies that are multiple of the sampling frequency when the digital filtering is used. This can be proved either by increasing the sampling frequency or using a higher order filter.

* Increasing the sampling frequency Having the signal centered around the peak, the sampling frequency has been varied from 40 MHz to the largest possible value of 400 MHz. Except for the case where the maximum possible noise reduction factor has been determined, the number of samples is such that the calibration signal and the autocorrelation function are taken over 100 ns. In order to determine the maximum noise reduction, the signal and the autocorrelation function have been taken over 150 ns (60 samples). The noise reduction factors obtained are summarized in Table 2 for \(\tau=10\) and 15 ns. Working at a higher sampling frequencies than 40 MHz suppresses completely the bumps that are present at 40 MHz due to the aliasing process : a 50 % improvement is already achieved with 9 samples at 80 MHz for \(\tau=10\) ns. Moreover the noise improvement is also larger when the shaper time constant is smaller, corresponding to a higher central pass-band frequency of the shaper, thus more deteriorated by the bumps with the 40 MHz sampling frequency. This is even more clear in Table 3 where the noise reduction factors at 40 MHz and the maximal factor have also been computed at \(\tau=5\) and 25 ns.

\begin{table}
\begin{tabular}{||c|r|r|r|} \hline Number of samples & f (MHz) & \(\tau=10\) ns & \(\tau=15\) ns \\ \hline
5 & 40 & 1.5 & 1.8 \\
9 & 80 & 2.2 & 2.1 \\
20 & 200 & 2.3 & 2.2 \\
40 & 400 & 2.4 & 2.2 \\
60 & 400 & 2.5 & 2.2 \\ \hline \end{tabular}
\end{table}
Table 2: _Noise reduction factor with the CR RC\({}^{2}\) for two different time constants, as a function of the sampling frequency and the number of samples. Except for the last line, the signal and the autocorrelation function have been taken over 100 ns._

\begin{table}
\begin{tabular}{||c|r|r|r|r|r||} \hline Number of samples & f (MHz) & \(\tau=5\) ns & \(\tau=10\) ns & \(\tau=15\) ns & \(\tau=25\) ns \\ \hline
5 & 40 & 1.1 & 1.5 & 1.8 & 1.5 \\
60 & 400 & 3.5 & 2.5 & 2.2 & 1.8 \\ \hline \end{tabular}
\end{table}
Table 3: _Noise reduction factor as a function of the number of samples taken around the peak and the sampling frequency for the CR RC\({}^{2}\)._

[MISSING_PAGE_FAIL:12]

The noise reduction factor as a function of the shaper time constant is displayed in Figure 7 for the two detector capacitances corresponding to the strips and middle compartment of the ATLAS electromagnetic calorimeter. Even in the \(\emptyset\)T case, the effect of the bumps is well observable for a small value of \(\tau\). With the ATLAS value of \(\tau=13\) ns, a typical factor of 1.8 on the noise reduction can be expected.

In Table 6 the potential improvement when varying the number of samples at 40 MHz has been investigated for the \(\emptyset\)T with \(\tau=15\) ns and \(C_{d}=1500\) pF. Using 7 samples rather than 5, which is the ATLAS configuration, would result in noise reduction of 15 %. There is no significant improvement coming from the use of 9 samples instead of 7. As the number of samples increases at a given frequency, the autocorrelation function goes to zero, and the new samples do not contain any significant information.

From now on, all the results for the digital filtering are given with 5 samples being taken at the sampling frequency of 40 MHz.

\begin{table}
\begin{tabular}{||c|c||} \hline Number of samples & Noise reduction \\ \hline
3 & 1.5 \\
5 & 1.8 \\
7 & 2.1 \\
9 & 2.1 \\ \hline \end{tabular}
\end{table}
Table 6: _Noise reduction factor as a function of the number of samples used at 40 MHz for the \(\emptyset\)T with \(\tau=15\) ns and \(C_{d}=\)1500 pF._

Figure 7: _The noise reduction factor resulting from the optimal filtering with 5 samples taken at 40 MHz around the peak. This is shown for 2 different values of the cell capacitances : \(C_{d}=\) 1500 pF (a) and \(C_{d}=\) 400 pF (b). The third sample out of five is taken at the peak of the signal._

#### 4.2.3 Influence of the phase

In the previous sections we have only examined the case where the third sample out of 5 is taken at the peak of the signal. The use of digital filtering does not rely on the fact that the third sample is on the peak of the signal.

In this section, the signal has been sampled with a phase (\(\Phi_{1}\)) with respect to the maximum of the signal in order to see if the noise can be further reduced. The value \(\Phi_{1}=0\) of the phase corresponds to the third sample taken at the peak of the signal. For a given phase, a new set of optimal coefficients is determined under the constraint \(\Sigma a_{i}g_{i}=1\). The noise reduction obtained as a function of the phase is shown in Figure 8 as an example for \(\tau=15\) ns and the \(\emptyset\)T with two detector capacitances.

The noise reduction is not maximum at \(\Phi_{1}=0\). For \(C_{d}=400\) pF the improvement is nevertheless negligible when varying the phase. On the other hand, for \(C_{d}=1500\) pF a substantial gain of 5% is reachable with \(\Phi_{1}=25\) ns. These numbers are strongly linked to the signal shape, thus to \(\tau\) and \(C_{d}\). With \(C_{d}=1500\) pF, the signal shape is more asymmetric which explains the improvement. With \(\tau=10\) ns the maximal factor is obtained for \(\Phi_{1}=32.5\) ns but a 4% is always there at \(\Phi_{1}=25\) ns. The advantage of such a value is that one sample is always taken at the peak (the second instead of the third) thus minimizing the sensitivity to jitter.

Once the optimal coefficients (\(a_{i}\)) are determined to for given phase \(\Phi_{1}\), the noise evaluation is then independent of the phase \(\Phi_{2}\) at which the signal is computed. Up to

Figure 8: _Noise reduction factor as a function of the phase with respect to the maximum of the signal is shown here for the \(\emptyset\)T, \(\tau=15\) ns, with \(C_{d}=1500\) pF (a) and for \(C_{d}=400\) pF (b). The open circles show the factor cheived when the signal is estimated for a phase different of the one used for the coefficients computation._now the noise reduction factor was computed assuming that the signal amplitude remains unchanged \(\sum_{i=1}^{N}a_{i}g_{i}=1\), and the same phase is used in the two cases. Nevertheless nothing prevents the maximum amplitude of the convoluted signal to be larger than 1 for some phases, allowing to further increase the signal/noise ratio. The figure 9 shows the signal obtained after digital filtering for three values of \(\Phi_{1}\), showing indeed that the maximum amplitude can be larger than 1. When the chosen phase \(\Phi_{1}\) is the one giving the largest noise reduction as shown previously (\(\Phi_{1}=+25\) ns for \(\tau=15\) ns), the maximum of the convoluted signal is unchanged with respect to the shaper output. On the other hand, when \(\Phi_{1}\) is not the best one, the convoluted signal shows a maximum larger than 1 meaning that the signal/noise ratio could thus be improved by measuring it at its peak, that is to say applying the coefficients using a second phase \(\Phi_{2}\). In figure 8 is also shown the noise reduction factor which can be achieved assuming that the convoluted signal can be measured at its peak. Depending on the phase \(\Phi_{1}\), an improvement of up to 10% can be achieved when the phase is chosen far away from the optimal one, nevertheless it remains always worse than starting with the optimum phase \(\Phi_{1}\).

### Influence of noise floor on digital filtering performance

Any source of white noise after the shaper (or noise floor) will reduce the potential gain of the digital filtering. To study this effect, a white noise, taken as gaussian \(\sigma_{wn}\), has been simulated and added to the noise data recorded. For each value of \(\sigma_{wn}\) the new autocorrelation function and the coefficients are determined and the noise reduction factor estimated. Figure 10 shows an example of distortion of the autocorrelation in presence of noise floor. The degradation of the digital filtering performance is displayed in Figure 11 as a function of the fraction of noise floor with respect to the shaper output noise for the

Figure 9: _Convoluted signals after digital filtering with the \(\emptyset\)T and \(C_{d}=1500\) pF for the phase \(\phi_{1}\) equal to -10 ns (dashed line), +25 ns (solid line) and +40 ns (dotted line). The shaper output amplitude before digital filtering is normalized to 1._

two relevant detector capacitances of the ATLAS calorimeter and with \(\tau=10\) ns. The influence of an additional noise floor is larger for smaller capacitance. It can induce up to a 30 % loss of the digital filtering performance for a noise floor equal to the shaper noise and a detector capacitance around 400 pF. This can be compared to the result obtained with the RD3 prototype and the OSAM pipeline [1]. A noise reduction factor of 1.4 was observed and the noise contribution from the pipeline board was about 80 % of the shaper output noise. This means that in the absence of noise floor from the pipeline, a factor of 1.9 would have been expected in agreement with the test bench measurements 12. In ATLAS the gain of the shaper will be around 100, thus the configuration will be more favourable than in the RD3 environment and the noise reduction factor obtained on test bench should be reachable. Meanwhile it would be better to reduce as much as possible any noise floor after the shaping stage.

Footnote 12: Some data were taken in the same configuration (0T with \(C_{d}=400\) pF) with the PC-oscilloscope system and the OSAM pipeline [9]. The output noise of the 0T was dominant as it is amplified by the shaper (gain=100) and the input preamp of the the pipeline (gain=3.2). The noise reduction factor with digital filtering was found to be 1.92 with the PC and 1.89 with the pipeline, confirming that the test beam limitation was coming only from the small gain in the RD3 shaper.

### Comparing digital filtering with hardware shaping?

The use of digital filtering to optimize the performance at low luminosity results in slowing down the signal, simulating a shaper with a slower time constant, and thus reducing the electronics noise. It is therefore interesting to try to compare the effect of the digital filtering on a given signal to an equivalent hardware shaper with a slower time constant.

Figure 10: _Autocorrelation function for \(C_{d}=\) 400 pF and \(\tau=\) 10 ns with no noise floor added (solid line ) and with a noise floor fraction of 65 %_

In Figure 12 (a) is shown the peaking time before and after having applied digital filtering for the \(\emptyset\)T with \(C_{d}=1500\) pF for several shaper time constants. The peaking time is defined as the time needed for the signal to rise from 5% of its maximal value, to the maximal value. Using 5 samples with optimal coefficients slows down the signal by an approximatively _constant_ amount of 40 ns, regardless of the shaper time constant \(\tau\), as can be seen from the Figure 12 (a).

In Figure 13 is shown the noise normalized to the signal amplitude in arbitrary units (a.u) as a function of the peaking time obtained before digital filtering (full symbols) and after the application of the optimal coefficients (empty symbols).

The effect of digital filtering on the peaking time of the signal and on the noise is shown in Table 7 for a \(\emptyset\)T shaper with \(\tau=10\) ns and \(C_{d}=1500\) pF. For comparison, a \(\emptyset\)T with \(\tau=35\) ns and \(C_{d}=1500\) pF which has a peaking time comparable to the signal _slowed down_ by digital filtering for \(\tau=10\) ns is also presented. Only by hardware, a factor 1.7 (=2.5/1.5) better noise reduction can be achieved for similar peaking times.

As has already been said, a CR RC\({}^{2}\) signal slowed down by digital filtering does not exhibit the same shape as would be obtained with a CR RC\({}^{2}\) shaper with a larger time

\begin{table}
\begin{tabular}{||c|c c|c c||} \hline \(\tau\) & \(t_{p}\) before D.F. & \(t_{p}\) after D.F. & noise before D.F. & noise after D.F. \\ \hline
10 ns & 37 ns & 82 ns & 4.5 & 2.5 \\
35 ns & 87 ns & - & 1.5 & - \\ \hline \end{tabular}
\end{table}
Table 7: _The effect of the digital filtering on the signal peaking time and the noise for a \(\emptyset\)T with \(C_{d}\) = 1500 pF._

Figure 11: _Relative variation of the noise reduction with digital filtering as a function of the fraction of noise floor with respect to the shaper output noise. The solid line is obtained with \(C_{d}\) = 400 pF and the dashed line with \(C_{d}\) = 1500 pF._

constant. Thus comparing the two peaking times may not be the best way to describe the effect of digital filtering. A more relevant parameter is to use the pile-up integral which determines the pile-up noise contribution. This integral is defined as :

\[\text{Ip}=\int_{-\infty}^{+\infty}g^{2}(t)dt\]

where \(g(t)\) is the normalized signal. The value of the pile-up integral scales almost linearly with the shaper time constant at large \(\tau\) as is shown in Figure 12 (b). The variation of the noise with and without digital filtering as a function of the pile-up integral are shown in Figure 14 and 15.

Neglecting the parallel noise, the shaper time constant, \(\tau_{\text{opt}}\), which minimizes the total noise in absence of digital filtering, is related to the luminosity by :

\[\tau_{\text{opt}}^{4}=K\frac{10^{34}}{\mathcal{L}}=K\alpha\left(\mathcal{L}\right)\]

where \(\alpha(10^{34})=1\), \(\alpha(10^{33})=10\) and \(\alpha(10^{32})=100\). Assuming that the proportionality between \(\tau_{\text{opt}}\) and Ip is valid for all values of \(\tau\), the same formula holds also for Ip.

If \(\tau=10\) ns is chosen to be the optimal shaper time constant at nominal luminosity (\(\mathcal{L}=10^{34}\text{cm}^{-2}\text{s}^{-1}\)), the required pile-up integral at lower luminosities can be deduced (see Table 8). At these new pile-up integrals, the noise from the equivalent shaper can thus be compared to the noise obtained when applying the digital filtering. For example,

Figure 12: _(a) The peaking times obtained for the signal after digital filtering as a function of \(\tau\) for the \(\emptyset\)T with \(C_{d}=1500\) pF with only one sample and after the use of digital filtering. (b) The pile-up integral as a function of the shaper time constant \(\tau\) for a \(\emptyset\)T with \(C_{d}=1500\) pF in the same conditions._

starting from \(\tau=10\) ns, the optimal shaping at \(\mathcal{L}=10^{33}\)cm\({}^{-2}\)s\({}^{-1}\) is almost given by \(\tau=25\) ns with Ip = 89 ns. This value is also similar to the pile-up integral obtained after digital filtering from \(\tau=10\) ns. Nevertheless, the noise is already 30% worse than what would be obtained without using digital filtering with \(\tau=25\) ns. Going again to lower luminosity (\(\mathcal{L}=10^{32}\)cm\({}^{-2}\)s\({}^{-1}\)) would require a larger pile-up integral which could never be reached by the digital filtering starting from \(\tau=\)10 ns : the noise becomes then 2.5 times worse that what could be obtained at the optimal hardware shaping time for this luminosity. The results for \(\tau=15\) ns are also summarized in Table 8

\begin{table}
\begin{tabular}{|c|c c c|c c|} \hline \(\tau\) & \(\mathcal{L}=10^{34}\) & \(\mathcal{L}=10^{33}\) & \(\mathcal{L}=10^{32}\) & noise before D.F. & noise after D.F \\ \hline
10 ns (with D.F) & 52 ns & 92 ns & 164 ns & 4.5 & 2.5 \\
25 ns (hardware) & 89 ns & - & - & 1.9 & - \\ \hline
15 ns (with D.F) & 65 ns & 116 ns & 206 ns & 2.9 & 1.6 \\
35 ns (hardware) & 111 ns & - & - & 1.5 & - \\ \hline \end{tabular}
\end{table}
Table 8: _The effect of the digital filtering on the pile-up integral an d the noise for \(\tau=10\) and \(\tau=15\) ns, compared to the hardware shaping with respectively \(\tau=25\) ns and \(\tau=35\) ns._

Figure 13: _Noise as a function of the peaking time for the \(\emptyset\)T with \(C_{d}=1500\) pF._

## 5 Digital filtering in presence of pile-up in ATLAS

In the previous section the effect of digital filtering was only studied on the electronics noise. In ATLAS conditions the role of digital filtering is to minimize the total noise contribution. For that purpose, the previous data have been used and the pile-up added analytically.

### Method and assumptions

The autocorrelation function for the pile-up noise (\(R_{\mathrm{p}}(t)\)), extracted from the experimental data 13, is displayed in figure 16. As a comparison the experimental electronics noise autocorrelation function (\(R_{el}(t)\)) is also shown for the same shaper time constant.

Figure 14: _Noise as a function of the pile-up integral for the \(\emptyset\)T with \(C_{d}=1500\) pF._The resulting autocorrelation function of the total noise is :

\[R_{t}(t)=R_{eI}(t)+\beta(\mathcal{L})R_{p}(t)\]

where \(\sqrt{\beta(\mathcal{L})}\) is only the ratio of the pile-up noise to the electronics noise at a given luminosity.

Three configurations are studied for the total noise :

* Total noise at optimal hardware shaping In order to evaluate the pile-up, where Ip is the relevant parameter, the total noise has been parametrized as follows : \[\sigma_{tot}^{2}=\frac{B_{s}^{2}}{\mathrm{Ip}^{3}}+\frac{B_{par}^{2}}{\mathrm{ Ip}}+\frac{B_{pil}^{2}\ \mathrm{Ip}}{\alpha(\mathcal{L})}\] where the two first terms represent the electronics noise \({}^{14}\)whereas the last is the pile-up noise. The total noise can thus be minimized leading to an optimal pile-up

Figure 15: _Noise as a function of the pile-up integral for the \(\emptyset\)T with \(C_{d}=4\,00\) pF._

integral (i.e. an optimal shaper time constant) given by 15: Footnote 15: Neglecting the “parallel noise”, one can easily recover that \(\mathrm{I}\mathrm{p}_{opt}^{4}\propto\alpha(\mathcal{L})\) and \(\sigma_{tot}\propto\alpha(\mathcal{L})^{-\frac{n}{2}}\) at optimal shaping. One can then deduce the factor 2.37 (=\(10^{-\frac{n}{2}}\)) used in [2] as noise reduction at low luminosity. A more conservative number would be to use 1.8 \[\mathrm{I}\mathrm{p}_{opt}^{2}=\frac{B_{par}^{2}+\sqrt{B_{par}^{4}+12B_{s}^{2}B_{ pil}^{2}/\alpha(\mathcal{L})}}{2B_{pil}^{2}}\alpha(\mathcal{L})\] \(B_{s}\) and \(B_{par}\) are extracted from a fit to the experimental data. As at fast shaping (\(\tau=15\) ns) the first term of the total noise expression is dominant, the pile-up contribution (\(B_{pil}\)) has been taken to be \(\sqrt{3}\)\(\sigma_{el}\). From the above expressions, the variation of the total noise, \(\sigma_{opt}^{\mathrm{tot}}\), can be calculated as a function of the luminosity. As a reference point, the total noise is normalized to 1 at \(10^{34}\mathrm{cm}^{-2}\mathrm{s}^{-1}\).
* Total noise with one shaping time constant and no digital filtering In that configuration, the electronics noise remains constant whatever is the luminosity. As Ip and B\({}_{pil}\) are known, the pile-up noise is scaled with \(\alpha(\mathcal{L})\). The total noise, \(\sigma_{1}^{\mathrm{tot}}\) is obviously always worse than \(\sigma_{opt}^{\mathrm{tot}}\) and only tangent at \(\mathcal{L}=10^{34}\mathrm{cm}^{-2}\mathrm{s}^{-1}\) for \(\tau=\)15 ns.
* Total noise with one shaping time constant and digital filtering In absence of digital filtering the electronics noise and the pile-up noise have been determined. Thus for each luminosity \(\beta(\mathcal{L})\) can be extracted as well as the total noise

Figure 16: _Experimental electronics noise (solid line) and pile-up noise (dashed line) autocorrelation function for \(\tau=\) 15 ns and \(C_{d}=\) 1500 pF_

autocorrelation matrix. By applying the new coefficients obtained by digital filtering, the reduction of electronics noise can be measured at this luminosity. Moreover the pile-up integral of the convoluted signal gives the pile-up contribution.

### Results

The Figure 17 shows the total noise evolution with the luminosity for \(\tau=15\) ns and \(C_{d}=1500\) pF, typical of the middle sampling of the electromagnetic calorimeter. A few remarks can be drawn from this plot :

* First at \(\mathcal{L}=10^{34}\)cm\({}^{-2}\)s\({}^{-1}\) which was the point corresponding to the optimal hardware, a small gain (10 %) can be anticipated with the digital filtering, mainly coming from a pile-up noise reduction due to the more symmetrical signal shape after digital filtering.
* Going to larger luminosities with digital filtering allows to be better than a suited hardware shaping up to \(5.10^{34}\)cm\({}^{-2}\)s\({}^{-1}\). In Figure 18 is displayed the signal shape after digital filtering for very high luminosity : the minimization leads to negative first and fifth coefficients which give a distorted shape where it is difficult to define the peaking time. Meanwhile for this example the pile-up integral is reduced by 25% with digital filtering (from 65 to 44 ns) almost equivalent to what would have been obtained using \(\tau=10\) ns : thus it can be seen as speeding up of the signal 16.

Figure 17: _Total noise as a function of the luminosity for \(\tau=15\) ns and a \(\emptyset\)T with \(C_{d}=1500\) pF : with optimal hardware shaping (gray solid line), without digital filtering (black solid line) and with digital filtering (dashed line). The dot shows the noise after digital filtering in testbeam conditions with no pile-up._

* Finally it can be observed that the use of digital filtering gives similar or better performances than what could be obtained only by an optimal hardware shaping down to about \(10^{33}\)cm\({}^{-2}\)s\({}^{-1}\). At \(10^{32}\)cm\({}^{-2}\)s\({}^{-1}\), the total noise is almost 1.5 time worse.

Figure 19: _Total noise as a function of the luminosity for \(\tau=25\) ns and a \(\emptyset\)T with \(C_{d}=1500\) pF : with optimal hardware shaping (gray solid line), without digital filtering (black solid line) and with digital filtering (dashed line). The dot shows the noise after digital filtering in testbeam conditions with no pile-up._

Figure 18: _Comparison of signal shape with (dotted) and without (full) digital filtering at very high luminosity_

The previous results show that the use of one shaping time constant equal to about 15 ns can not cover the full luminosity range while keeping good performances. The noise evolution as a function of the luminosity has also been studied for \(\tau=25\) ns (Figure 19).

### Summary

The Table 9 and the Figure 20 gives a summary of the numbers relevant for a comparison. A solution using \(\tau=15\) ns at high luminosity and \(\tau=25\) ns at low luminosity is also displayed.

Keeping only \(\tau=15\) ns is obviously not good enough for low luminosity running. Two approaches can thus be followed to improve this result :

* By using a larger shaper time constant \(\tau=25\) ns, the luminosity range from \(2.10^{32}\) to \(2.10^{34}\)cm\({}^{-2}\)s\({}^{-1}\) can be covered with good noise performances using digital filtering : with this solution, a 25 % improvement in total noise is expected at \(10^{32}\) and a small deterioration of 3 % at \(10^{34}\) with respect with \(\tau=15\) ns. These results rely a lot on the power of the digit al filtering over the full luminosity range : they could be slightly optimistic at low luminosity if the noise floor contribution is not negligible, and at high luminosity if the pile-up contribution is larger than anticipated. Moreover if this solution could be well suited for the barrel calorimeter, it would be more difficult for the endcap where for example the pile-up noise is already 3 times larger than the electronics noise at \(\eta=\)2 [3, 4]. From a hardware point of view, this would result in a very minor change in the shaper layout.
* The second solution consists in having two shaper time constants for low and high luminosity. This solution is obviously more robust with respect to the digital filtering performance as the noise with only one sample is clearly better over the full luminosity range. The noise without digital filtering with \(\tau=25\) ns is indeed almost as good as applying digital filtering to \(\tau=15\) ns. On the hardware point of view this means to add a second shaper time constant on the chip 17, probably only for the high gain, and a programmable way to go from one to another as for the peaking time adjustment [6].

\begin{table}
\begin{tabular}{|c|c|c|c|c|c||} \hline  & \(\mathcal{L}=0\) & \(\mathcal{L}=10^{32}\) & \(\mathcal{L}=10^{33}\) & \(\mathcal{L}=10^{34}\) & \(\mathcal{L}=4.10^{34}\) \\ \hline \(\sigma_{\text{opt}}^{\text{tot}}\) & - & 0.178 & 0.422 & 1.000 & 1.667 \\ \hline \(\tau=15\) _ns, no DF_ & _0.500_ & _0.508_ & _0.569_ & _1.000_ & _1.802_ \\ \hline \(\tau=15\) _ns, DF_ & **0.276** & **0.297** & **0.428** & **0.907** & **1.554** \\ \hline \(\tau=25\) _ns,no DF_ & _0.330_ & _0.345_ & _0.459_ & _1.064_ & _2.050_ \\ \hline \(\tau=25\) _ns, DF_ & **0.204** & **0.236** & **0.409** & **0.937** & **1.658** \\ \hline _two \(\tau\), no DF_ & _0.330_ & _0.345_ & _0.459_ & _1.000_ & _1.800_ \\ \hline
**two \(\tau\), DF** & **0.204** & **0.236** & **0.409** & **0.907** & **1.554** \\ \hline \end{tabular}
\end{table}
Table 9: _Total noise as a function of the luminosity for various configurations : at the optimal hardware shaping (first line), at \(\tau=15\) and 25 ns, or with two shaper time constant, with (bold) or without (italic) digital filtering_

## 6 Conclusion

The use of digital filtering is needed to achieve good noise performances with the electromagnetic calorimeter over the full luminosity range in ATLAS. A theoretical frequency analysis, confirmed with experimental measurements, has revealed some limitations of the digital filtering method : any 40 MHz noise (and harmonics) is not reduced and any noise floor after the shaping stage deteriorates the noise reduction. The various measurements have shown that some improvement can be gained by choosing cleverly the sampling phase. Finally this study shows that using one shaper time constant of 13 ns is not good enough to cover optimally the full luminosity range : if minimum noise at low luminosity is considered important one could either select a slower time constant (20 ns instead of 13 ns, typically), or build shapers with two time constants, typically 13 and 25 ns.

## References

* [1] Presentation at the LARG test beam meeting 06/05/96 E. Auge et al., ATLAS internal note in preparation
* [2] ATLAS calorimeter performance **CERN/LHCC/96-40**
* [3] ATLAS Liquid Argon calorimeter technical design report **CERN/LHCC/96-41**

Figure 20: _Relative comparison of noise with \(\tau=15\) ns (dotted),\(\tau=25\) ns (dashed) or a combination of two shaper time constant, 15 and 25 ns with a switching at \(4.10^{33}\), (solid line) as a function of the luminosity : with no digital filtering (left) and after digital filtering (right)_