**ATLAS DAQ-No-57**

**10 Sept 1996**

Optimising the Grouping of SCT Wafers

into Readout Buffers using Simulated

Annealing Methods

**Victoria A Charlton**

## 1 Introduction

This note describes the latest results from an exercise to use Simulated Annealing methods for improving over the previous results of 'intuitively' placing the 2112 silicon wafers (barrel) and the 988 wafers (endcap) of the ATLAS detector into readout buffers, such that the average number of buffers hit by Regions of Interest is small and the distribution of buffers hit is narrow. This optimisation problem arises in the context of studying the level-2 trigger of ATLAS. The improvement obtained by computer optimisation is remarkable.

## 2 Simulated Annealing

Simulated Annealing [1] is a technique suitable for solving optimisation problems (such as the problem under study) where the number of elements in the configuration space is so factorially large that to exhaustively explore the set of possible configurations would be impossible, even on a large computer. In the barrel optimisation the set of possible configurations would be 1056!/(16! x 1040!), which is of the order of \(10^{48}\).

The technique is based on thermodynamics and the process which occurs when a liquid cools and crystallises or a metal cools and anneals. The molecules of a liquid move freely at high temperatures but as the liquid is slowly cooled this mobility is lost and the liquid eventually becomes a pure crystal with all the atoms perfectly lined up. This state is the minimum energy state for this system.

The Metropolis algorithm has incorporated this principle into numerical calculations. It states that a system is likely to change its configuration from Energy\({}_{1}\) to Energy\({}_{2}\) with the probability \(p=\exp[\)- \((E_{2}\) - \(E_{J})\) / \(kT]\). If Energy\({}_{2}\) is greater than Energy\({}_{1}\) this 'probability' will be greater than one, meaning that the system will take the option. If however Energy\({}_{1}\) is greater than Energy\({}_{2}\) the system will accept the configuration with the probability \(\exp[\)- \((E_{2}\) - \(E_{J})\) / \(kT]\) where the temperature is determined by the annealing schedule. This means that the system always takes the downhill step whilst sometimes taking an uphill step but as the temperature gets lower the likelihood of an uphill step decreases. Therefore the system is able to get out of a local energy minimum in favour of a more global minimum.

For this technique to be applied to an optimisation problem it is necessary to define 4 elements. These are:

1. The possible set of system configurations.
2. A random change in the configuration which presents an option to the system.
3. A function whose minimisation is the objective (the Energy of the system).
4. A control parameter which controls the 'cooling' of the system (the Temperature of the system). This is the annealing schedule which explains how the system moves from high to low values and after how many changes in configuration is each downhill step taken.

## 3 Detector, Barrel

The ATLAS barrel silicon detector considered in this study consists of four layers of silicon wafers at radius 30.0, 37.3, 44.3, and 52.0cm. The physical dimensions of the wafers are 6.4cm x 6.4cm with two wafers bonded together to make the length of the wafer in z 12.8cm. The wafers are arranged in an overlapping tiled structure so that there are no gaps present. The overlapping of the wafers in z and phi also allows for the fact that there is a non sensitive edge of 0.1cm around the perimeter of each wafer. There is also a non sensitive strip of 0.22cm in z at the centre of each wafer where the two silicon edges have been bonded.

The number of wafers along the z axis (12) is constant in all the four silicon layers. The physical length of the detector in z is 149cm where z is defined as being in the range -74.5cm to +74.5cm in this study. The number of wafers in phi varies according to the radius, 32 wafers at radius 30.0cm, 40 wafers at radius 37.3cm, 48 wafers at radius 44.3cm and 56 wafers at radius 52.0cm. The physical overlap in phi varies in each layer. The parameters are shown in Table 1.

This gives a total of 2112 wafers; stereo wafers are ignored in this study and are presumed to accompany normal wafers.

Each wafer can be defined by a set of four co-ordinates. These are the minimum and maximum position of the wafer in eta, which is an angle of 'rapidity' obtained from the position of the wafer in z and the radius, and also the minimum and maximum position of the wafer in the azimuth angle, phi.

In order to obtain a symmetrical layout, only the wafers on one side of the detector (i.e. positive eta) were used in this study. Once the experiment was completed the wafers

\begin{table}
\begin{tabular}{|p{56.9pt}|p{56.9pt}|p{56.9pt}|p{56.9pt}|p{56.9pt}|} \hline
**Layer** & **Radius (cm)** & **Wafer Dimensions (cm x cm)** & **Number of wafers in eta** & **Number of wafers in phi** \\ \hline
1 & 30.0 & 12.8 x 6.4 & 12 & 32 \\ \hline
2 & 37.1 & 12.8 x 6.4 & 12 & 40 \\ \hline
3 & 44.6 & 12.8 x 6.4 & 12 & 48 \\ \hline
4 & 51.8 & 12.8 x 6.4 & 12 & 56 \\ \hline \end{tabular}
\end{table}
Table 1: Parameters of the four silicon layerson the left side of the detector were then buffered so that they mirrored the buffering pattern of the wafers on the right side of the detector

## 4 Regions of Interest, Barrel

For the purposes of this study a Region of Interest (RoI) is defined in a similar manner to the wafers, that is with minimum and maximum co-ordinates in eta and phi. The size of a Region of Interest is approximately 0.3 x 0.3. The minimum value of a Region of Interest in eta is 0 and the maximum value in the barrel is 1.6. Although the Regions of Interest in the context of the level-2 trigger of ATLAS are defined from -1.2 to 1.2 in eta, it is necessary to cover the coordinates of all the wafers in the Regions of Interest, so that wafers from the same Regions of Interest are buffered together. As only wafers on the right hand side of the detector, where eta is positive, are involved in this study, the minimum eta value necessary is 0. The Region of Interest moves in eta in steps of 0.1. The phi values of a Region of Interest are in the range 0 to 2i and the Region of Interest moves in phi in steps of (2i/64). This gives the total possible number of Regions of Interest at 1024 (16 x 64).

## 5 Tuning and Results, Barrel

In this buffer optimisation problem, the system is configured so that each wafer is assigned to a readout buffer (RoB), and there are 16 wafers in each buffer, which means a total of 66 buffers are required for the half detector. (Note: With the inclusion of stereo wafers, this will correspond to the realistic number of 32 wafers to a RoB). At the start of the experiment the wafers are randomly assigned to buffers so the initial layout represents a system with high energy. The random changes made are 2 wafers in different buffers are selected and their buffer associations are inverted. The average number of buffers containing a region of interest is the number to be minimised as the number of accesses to RoBs is a critical parameter in the communication problem of the level-2 trigger. The parameters which control the cooling of the system are obtained by experimentation. The starting value for the temperature is larger than the largest \(\Delta\)Energy expected. Each temperature value is held constant for \(400N\) reconfigurations or \(40N\) successful reconfigurations whichever comes first.

It should be noted that for the reasons explained previously, the results discussed are for half the detector and a larger spread of RoIs than normally considered. Figure 1 shows how the average number of wafers decreases from the initial high average in the random layout to an end result which averages 3.499 buffers accessed per region of interest. The uphill steps occasionally taken by the simulated annealing algorithm are also clearly seen. In the early stages of the experiment, whilst the temperature is high, the probability of an uphill step is more likely, as the temperature decreases these uphill steps become less likely. This is clearly shown on the graph in Figure 1. The graph in Figure 2 shows how many successful reconfigurations take place at each temperature.

Figure 1: Graph to show the value of the mean at each temperature change

Figure 2: Graph to show the number of successful reconfigurations at each temperature

The results shown are as expected. At the high temperatures where the wafers are randomly distributed amongst buffers, the number of successful reconfigurations is at the maximum set for each temperature of 40\(N\). But as the system cools and the distribution of wafers into buffers becomes less random the number of successful reconfigurations decreases.

The graph in Figure 3 shows how many reconfigurations are attempted at each temperature. Again, the results are as expected. With the temperature decreasing the number of attempted reconfigurations will increase to the point where the maximum number of attempted reconfigurations, 400\(N\), is reached.

Figure 3: Graph to show the number of attempted reconfigurations at each temperature

The histograms in figure 4 contrast the number of times a certain number of buffers are accessed for a RoI in the layout obtained with the simulated annealing algorithm compared with the previous best algorithm used. Both the results are from the whole detector and only take into consideration RoIs in the eta region of -1.2 to +1.2. The Simulated Annealing Layout clearly shows an improvement. Both layouts show that the most common occurrence is for 4 buffers to be hit by regions of interest but the simulated annealing algorithm shows a narrower distribution and 94.5% of regions of interest only affect 3, 4, 5 or 6 buffers. The highest number of buffers accessed for a RoI is 8, which occurs 24 times in the 1344 RoIs considered. The average number of buffers accessed over the eta range -1.2 to +1.2 is 4.48.

## 6 Detector, Endcap

The ATLAS endcap silicon detector is arranged in 9 planar disks on each side of the barrel detector. It covers regions in z from 82.5cm to 276.8cm. The inner radii vary from 26.0cm to 43.9cm and the outer radii vary from 33.2cm to 56.0cm. Each wafer consists of two smaller wafers bonded together along r to give a trapezoidal double wafer except in plane 8 where single wafers are used. The physical dimensions of the wafer are 5.6cm x 7.2cm (GaAs) and 7.6cm x 12.4cm (Si). The parameters for the endcap are shown in the following table, table 1. As in the barrel study stereo wafers which are presumed to accompany normal wafers are ignored. This gives a total of 988 wafers.

Figure 4: Graphs to show the results of wafer to buffer mappings

Each wafer can be defined by a set of four co-ordinates. These are the minimum and maximum position of the wafer in eta, which is an angle of 'rapidity' obtained from the position of the wafer in z and the radius, and also the minimum and maximum position of the wafer in the azimuth angle, phi.

## 7 Regions of Interest, Endcap

The size of a Region of Interest is again approximately 0.3 x 0.3. The minimum value of a Region of Interest in eta is 1.2 and the maximum value is 2.4. The Region of Interest moves in eta in steps of 0.1. The phi values of a Region of Interest are in the range 0 to 2i and the Region of Interest moves in phi in steps of (2i7/64). This gives a total possible number of Regions of Interest of 640 (10 x 64).

\begin{table}
\begin{tabular}{|p{56.9pt}|p{56.9pt}|p{56.9pt}|p{56.9pt}|p{56.9pt}|} \hline
**Plane Number** & **z position (cm)** & **Inner Radii (cm)** & **Outer Radii (cm)** & **Number of wafers in phi** & **Technology** \\ \hline
1a & 82.5 & 26.0 & 33.2 & 40 & GaAs \\ \hline

[MISSING_PAGE_POST]

 \end{tabular}
\end{table}
Table 2: **Parameters of the different planes in the endcap**

## 8 Tuning and Results, Endcap

As in the barrel, the system is configured so that each wafer is assigned to a readout buffer (RoB) and there are 16 wafers in each buffer, stereo wafers ignored. This means a total of 62 buffers are required. As in the barrel study, at the start of the experiment, the wafers are randomly assigned to buffers so the initial layout represents a system with high energy. The random changes made are 2 wafers in different buffers are selected and their buffer associations are inverted. The average number of buffers containing a region of interest is the number to be minimised as the number of accesses to RoBs is a critical parameter in the communication problem of the level-2 trigger. The parameters which control the cooling of the system were again obtained by experimentation. The starting value for the temperature is larger than the largest \(\Delta\)Energy expected. In this experiment, each temperature value is held constant for \(400N\) reconfigurations or \(40N\) successful reconfigurations whichever comes first. A total of 180 temperature changes were made.

In order to verify that the results from grouping the endcap wafers into Readout Buffers using the Simulated Annealing algorithm are an improvement on other 'intuitive' methods of grouping wafers into Readout Buffers, the results of the simulated annealing algorithm are compared with a previous algorithm used [2]. The graph in Figure 1 shows how the mean number of buffers accessed per region of interest decreases from the initial high of 12.08 to the end result of 3.73 buffers accessed per region of interest.

Figure 5: Graph to show the value of the mean at each temperature change

Figure 6: Graph to show the number of successful reconfigurations at each temperature

[MISSING_PAGE_FAIL:10]

The histograms above contrast the number of times a certain number of buffers are accessed for a region of interest using the simulated annealing algorithm compared with the previous best algorithm used. The simulated annealing algorithm shows the best results. An average of 3.73 buffers are accessed per region of interest. In the previous best algorithm, an average of 4.92 buffers are accessed per region of interest. 83% of Regions of Interest access 2, 3 or 4 buffers in the simulated annealing algorithm. In the simulated annealing algorithm the most common occurrence if for 4 buffers to be accessed whereas in the previous best algorithm the most common occurrence was for 5 buffers to be accessed per region of interest.

## 9 Post-optimization of Simulated Annealing Results (in the Barrel only)

(paragraph added by M.Islinger)

The results obtained by the SA program for the barrel wafers still contain some aspect of randomness, and do not guarantee a local minimum in all cases. Therefore, we executed a post-processing step which tries to swap every wafer with every other wafer, accepting only changes that improve the result (average number of buffers), or

Figure 8: Graphs to show the results of wafer to buffer mappings

maintain an equal-quality result reducing the maximum number of buffers accessed, another criterion we watched. In this step, the system converges to a local minimum very quickly. In the barrel, the average numer of accessed buffer for the inner part of the detector (eta in the range of -1.2 to 1.2) goes down from 4.481 to 4.405 accessed buffers. Previously 8 buffers had to be accessed in 24 cases which was reduced to only 4 cases by the optimization.

Repeating the simulated annealing study we could find a slighly better solution still. This is just due to "luck" as the SA algorithm largely depends on random numbers. By repeating the SA several times, with post-processing added, it is possible to obtain different solutions of roughly the same quality. The average number of accesses is down to 4.326. The highest number of buffers accessed is now only 7 (17 cases). The distribution of the number of accesses is shown in the histogram below:

It might be possible to achieve further improvements; however, one should keep in mind that the above solution took almost five days to compute (on a very powerful machine). So it is probably worth investigation other optimization techniques like a genetic algorithm. More important, it is not only computer optimisation that is required, but practical problems like finding an easy way of grouping fibres into ROBs. This question has not been touched, so far.

## 10 Availability of Results

The optimal results are available in tabular form, with explanations, via Internet on [http://sunrans.cern.ch/](http://sunrans.cern.ch/)\(\sim\)rkb/SCT_barrel and..../SCT_endcap.

Figure 9: Best solution for barrel, after further optimization

## 11 Conclusions

The results obtained from the simulated annealing algorithm show an improvement over the previous, intuitive methods experimented with. The simulated annealing algorithm is not difficult to implement, although the tuning of several of the parameters requires some experimentation in order to obtain the best possible results.

Nevertheless, there is a disadvantage to the algorithm. Although the majority of buffers contain wafers from the same geometrical space, there are some buffers which contain one or two wafers from another, separated space in the detector. This will occur naturally whenever an uphill step is accepted. However, these occasional uphill steps are required to allow the system to get out of a local minimum energy state in favour of a more global minimum. Increasing the range of RoIs has helped to reduce the scope of this deficiency of the algorithm, but not eliminated it. Without uphill steps, or without the simulated annealing algorithm, the system goes downhill as fast as possible to a local minimum. When the uphill steps were not accepted in the program, the system cooled rapidly to an average of 8.44 buffers contained in a RoI.

## 12 Acknowledgements

I thank J Baines and R Bock for defining the SCT detectors and the problem.

## References

* [1] Press WH, Teukolsky SA, Vetterling WT, Flannery BP, 1995, Numerical Recipes in C, Cambridge University Press, pp 444 -455.
* [2] Charlton VA,1996 "Placing Wafers inside a Silicon Detector into Buffers".
* [3] Rudolf Bock and Patrick LeDu, 1996, "Detector and readout specifications for the level-2 trigger demonstrator program", ATLAS DAQ note 53.