**ATLAS Internal Note**

**LARG-NO-060**

**17 December 1996**

LAPP-TECH-96.03

november 1996

**A FOUR GAIN READOUT INTEGRATED CIRCUT : FRIC 96_1**

J. M. Bussat\({}^{1}\), G. Bohner\({}^{1}\), O. Rossetto\({}^{2}\), D. Dzahini\({}^{2}\), J. Lecoq\({}^{1}\), J. Pouxe\({}^{2}\), J. Colas\({}^{1}\),

\({}^{(1)}\) L. A. P. P. Annecy-le-vieux, France

\({}^{(2)}\) I. S. N. Grenoble, France

**ABSTRACT**

The main difficulty for the readout electronics of the ATLAS LARG calorimeter is to handle the 16 bit dynamic range without spoiling the signal to noise ratio. A possible way out is to split the input signal in four << ranges >> with different gains and to select the most appropriate. Then, each subrange only requires 10 bits, a much more manageable number.

A four gain shaper circuit has been successfully developed at LAL Orsay and we report in the following about the associated << gain selector >> circuit. It is a synchronous design running with the 40MHz LHC clock and using a fully differential architecture to minimize pick-up from digital activity. The AMS 1.2 micron bipolar technology used should provide enough radiation hardness (200Gy are expected over 10 LHC years).

After a description of the content of the four gain selector circuit, some preliminary results from the first prototype will be presented.

Talk presented at the Second Workshop on LHC Electronics, september 23th-28th 1996, Balatonfured, Hungary

# A Four Gain Readout Integrated Circuit : Fric 96_1

J. M. Bussat\({}^{1}\)

 G. Bohner\({}^{1}\)

 O. Rossetto\({}^{2}\)

 D. Dzahini\({}^{2}\)

 J. Lecoq\({}^{1}\)

 J. Pouxe\({}^{2}\)

 J. Colas\({}^{1}\)

\({}^{(1)}\) L. A. P. P. Annecy-le-vieux

 France

\({}^{(2)}\) I. S. N. Grenoble

 France

###### Abstract

The main difficulty for the readout electronics of the ATLAS LARG calorimeter is to handle the 16 bit dynamic range without spoiling the signal to noise ratio. A possible way out is to split the input signal in four \(\times\) ranges \(\times\) with different gains and to select the most appropriate. Then, each subrange only requires 10 bits, a much more manageable number.

A four gain shaper circuit has been successfully developed at LAL Orsay and we report in the following about the associated \(\times\) gain selector \(\times\) circuit. It is a synchronous design running with the 40MHz LHC clock and using a fully differential architecture to minimize pick-up from digital activity. The AMS 1.2 micron bipolar technology used should provide enough radiation hardness (200Gy are expected over 10 LHC years).

After a description of the content of the four gain selector circuit, some preliminary results from the first prototype will be presented.

## 1 Introduction

The following figure shows the general block diagram of the four gains shaper solution.

The chip includes an analog and a digital part. The analog section contains four track and hold (T&H) and a multiplexer. The digital part contains three comparators and some logic to drive the multiplexer and ensure the proper gain selection. It also contains a monostable in order to deal with some possible saturation problems coming from the CR(RC)\({}^{2}\) shaper [1]. A two bit digital output indicates the selected gain.

## 2 Specifications

* Sampling period : 25ns. The multiplexing may be done during one clock period. The selected and sampled signal appears on the output after \(\approx\)25ns.
* precision : at least 0.1%
* unity gain for an analog channel.
* Since there will be 200 000 channels, we must keep power consumption as low as possible. This criteria is the most important one after speed and dynamic range.

To minimize the noise of the following stages, the first stage of the CR(RC)\({}^{2}\) shaper is an amplifier

Figure 1: Overall view of the four gain system.

Figure 2: General block diagram.

which then can saturate. This is followed by differentiation and integration stages. Differentiation of saturated pulse gives a pulse (Fig 3) which is unusable.

To deal with this behaviour, switching from high to low gain occurs immediately while one must wait for 400ns to switch back to high gains.

Analog outputs are loaded by some capacitors from bonding pads, printed-circuit board and oscilloscope's probe. This leads to 30pF load capacitance and call for a buffer.

## 3 3- Analog Solutions

### 3.1- General choices

\(\bullet\) We need a very good noise immunity so, we use synchronous logic cells. In addition, the structure of the track and holds is fully differential.

\(\bullet\) The design use bipolar transistors for better radiation hardness than currently used CMOS processes.

\(\bullet\) A common mode to differential mode adapter has to be added on the inputs because the four gain shaper provides common mode signals and the selector has differential inputs. Signal may be provided to one input while providing DC voltage to the other. On the chip, the two inputs are available so one can use either the first or the second method.

### 3.2- The sample and hold

The basic cell of the analog part is a sample and hold. It must work with a 25ns clock period. It is designed to work with a 50% duty-cycle but it may be modified to deal with other clock requirements. We have a 12ns sample time and 12ns hold time.

Several designs have been studied [2][3][4][5] and the principle described in [4] has been chosen. It is a fully differential design with capacitors enclosed between two followers.

The main reason for the use of a differential structure is the good noise immunity. To stay within the constraints imposed by the AMS technology on the power supply voltages, our current design features a 2.2V dynamic range.

#### 3.2.1- Power supplies and current sources

The sample and hold has differential inputs while the shaper has single ended output. We connect the shaper directly to one input. The other one is connected to a biasing source. As explained in the specification section, low power consumption is needed. The original schematic [4] was thus critically reviewed and modified. The current in the input pair has been reduced and the output stage modified.

#### 3.2.2- Simulation results

To study the acquisition speed, a full dynamic range step is applied to the circuit (\(\Delta\)t=1ns).

Rise time \(\Delta\)t is given for a 0 to 99.9% transition according to the expected precision.

We look at signals at some interesting points and compute gain (A) and rising time (\(\Delta\)t).

\(\bullet\) Differential amplifier (without load) : A=0.983 \(\Delta\)t=3.5ns

\(\bullet\) Signal on hold capacitor : A=0.981 \(\Delta\)t=11ns

\(\bullet\) Output signal : A=0.978 \(\Delta\)t=11.5ns (Fig 4&5)

For static and dynamic input, time between the clock edge (that starts the hold mode) and the time when the output is valid (with 0.1% precision) is always below 4ns.

Track-to-hold step (Fig 6) is a linear function of input voltage with a ratio of 1.2mV/V.

The hold mode gain is 0.977.

Figure 3: Effects of saturation.

Large signal settling time (Fig. 5) is dominated by a slew-rate effect which is directly linked to the value of the hold capacitor and the biasing current of the input differential pair.

Reducing power dissipation implies increasing the full scale settling time. In this design, it is below 12.5ns.

Temperature sensitivity

A 10\({}^{\circ}\)C temperature variation gives an common mode output voltage shift of +50mV. Common mode voltage is about 800mV at 25\({}^{\circ}\)C. This stability is important for cascading two S&H.

### 3.3- The track and hold (T&H)

Two cascaded sample and hold are needed to achieve a 50ns hold time. Their corresponding clock signals have to be correctly defined. The second S&H must be in hold mode before the beginning of track on the first one. The second S&H will see a step (hold to track transition of the first one) on its input near its own track to hold transition. Consequences of this step on the hold signal quality have been studied showing that hold to track transition on the first S&H must occurs at least 0.5ns after hold time on the second.

To insure the right clock phase for each S&H, an inverter was added. It provides the previously described delay needed between the two S&H. For test purposes, this inverter allows the setting of the first S&H in sample mode.

The two cascaded S&H solution seems to be very good. It is suitable for our design and it has a 80mW power consumption (4x2 S&H plus the clock inverter).

The whole system is able to work at 40MHz. It may be the basis of a two stage pipeline. This would gives 50ns for the switching system and allows us to reduce the power consumption.

### 3.4- The analog multiplexer

It's a differential amplifier with an open loop gain of 200 used as a voltage follower with multiple inputs. An unity gain is achieved with a resistive feedback. Since it works in common-mode, we need two of them to get a differential multiplexer. Simulations show a static power consumption of 30mW for the differential version.

Figure 4: Small signal transient response (20mV input step in tracking mode)

Figure 5: Large signal transient response (2V input step tracking mode)

For test purposes, we add a single ended buffer. Its input is differential and comes from the multiplexer. Its static power consumption is about 30mW (without load). It is able to drive a 50\(\Omega\)/30pF impedance, but only under positive voltages.

### Layout considerations

Good relative precision on resistors used in the differential amplifier of the sample-and-hold and in the multiplexer is required. In this way, 5um width resistors and symmetrical drawing with components as close as possible are used.

Current sources were slightly modified after layout extraction to take into account parasitic capacitors.

Track-and-hold are isolated from each other and from other parts (digital ones) of the circuit by double guard-rings

## 4 Logic

### Principle

The purpose of the logic section is to ensure the automatic gain switching. The multiplexer got four selection inputs. The logic has to choose one gain among four and thus needs three comparators. Gain choice is coded with two bits (Fig. 7). This is a combinatorial circuit which use some simple gates.

It is possible to have a very simple logic system because there is only four possible input states. For example, gain 12 comparator output high mean that gain 50 comparator output is also at the high level.

Comparators are only high gain amplifiers so, they are asynchronous devices. Consequently, they are not suitable for this design. Synchronous logic is needed for the following reasons :

* Gain switching should not to take place at random time. With synchronous logic, changes are allowed on clock edges only.
* Digital noise must be reduced. On logic circuits, noise is generated during switching. With synchronous logic, there is a strong correlation between noise and clock signal. This makes easier the signal to noise ratio improvement with some filtering methods.

Synchronisation is done with edge triggered D latches added on each comparator output. Since inputs are synchronized, the outputs of the logic system become synchronized too.

### Shaper's saturation problems

The ATLAS calorimeter use a CR(RC)\({}^{2}\) shaper. In this kind of shaper, amplification takes place before integrating stages. So, when the amplifier come into saturation, its output becomes unusable for all the integrating period.

When a switch from high to low gain occurs, the high gain comes into saturation and its output becomes unusable. Since it stays like that for 400ns (the integrating period), switching back from low gain to high gain is forbidden. The gain selection must take these effects into account.

Enabling gain switching from high to low gain at any time was chosen but switching back to high gain could only occurs after 400ns. This delay can be made with a monostable.

In this design, switching from low to high gain implies always going back to the higher one (50). There is another solution which uses three monostables and allows switching from a low gain to the nearest higher one (e.g. : switching from gain 3 to gain 12 instead of gain 50). For simplicity, the first solution was chosen. Its structure is described on figure 8.

RS flip-flops allow high to low gain switching at any time. Since Reset input isn't activated, return to high gain is disabled. With this design, a flip-flop is set by the output of a comparator and reset at the end of the monostable period.

To deal with pile up, the monostable is started on a falling edge, i.e. only when the high gain comes outside its saturated region. It means that if there is some pile-up, the monostable is started at the end of the last pulse.

Figure 7: Basic logic system location

The monostable is followed by an edge triggered D-latch in order to synchronize its output. Then there is a "falling edge extractor". This device is needed to get the whole system working because RS flip-flops couldn't be reset when the monostable output is low. In this case, reset would be active for ever because the system must use flip-flops that are reset even if set and reset inputs are high. Since all flip-flop are reset at the same time, only switching back to the higher gain is allowed.

### Logic section design

The block diagram is now well defined, and choice between CMOS and ECL gates has to be made. For this circuit, power consumption, noise and rad-hardness are the three main guidelines. Size would be a problem in the future but at this time, the architecture has to be validated with the best configuration.

In ECL, static power consumption is linked to dynamic performances. Very fast logic design isn't really needed and low power cells can be used. According to simulations, the first conclusion was that CMOS would be 20% better than ECL. This last one was chosen to insure the best results with regard to pickup noise.

In march 1996, two chips were sent out to AMS foundry: one containing the whole project and another one with some parts for test purposes. On this last one, some CMOS logic (a 40MHz ring oscillator which may be switched on or off) was added. This will show if noise introduced by CMOS logic is really too high for the four gain selector circuit.

The analog multiplexer is driven by ECL levels. So, decoding logic must be done with ECL gates. Since ECL levels are between -0.85 and -1.75V, it is easier to use cells with 0 and -3V power supplies (it helps to reduce power consumption). There is no problems with simple gates as OR or NOR but it is quite difficult to make D latches with these power supplies. For these ones, we must work between -3 and +5V and levels become PECL levels.

So, there are two parts in the logic section : one is using ECL and the other is using PECL and there is an interface to connect them.

Chip testability was also considered during the design. The automatic gain selection logic can be bypassed and any gain of the four can be forced.

## 5 Preliminary results

5 circuits were received just before the workshop. A special test board containing a four gain shaper and the fast selector chip has been prepared.

However, not enough attention has been paid to the layout of this board and problems of bad shielding and decoupling were found. Not all of them have been solved at the present time and this prevents significative measurement of noise and linearity.

Currently, all circuits were tested and all of them are working (Fig. 10).

Fig. 8: Block diagram of a solution to shaper’s saturation effects.

Fig. 9: Timing diagram of our solution to shaper’s saturation effects.

Figure 10 shows that signal is properly sampled at full frequency. Gain switching occurs when it is necessary. We can see it both on analog and on digital outputs. The monostable is working too and correctly prevents switching back to high gain before the end of the pulse.

The static power dissipation is below 300mW (between 240 and 285mW).

Some other measurements were made in order to have an idea of speed of analog and digital parts (Fig. 11).

In track mode, there is an analog delay of 3ns between input and output of the circuit (signals are measured directly on output pins with high impedance and low capacitance probes).

For the digital part, gain may change since signal is over threshold but only after a clock rising edge (comparators are synchronized by D-latches). So, logic's delay is given by the time between this edge and a change on any digital output. In our case, we have a delay of 5ns.

If we look at the output signals, this give us a 2ns delay between the decision time which occurs between two hold steps and the real gain switching.

Clearly, the logic is very fast and could be slowed down. This would reduce the power consumption of this part. An objective near 150mW is within reach.

## References

* [1] << A fast monolithic shaper for the ATLAS E. M. Calorimeter >> by Jean-Pierre Richer. Paper presented at the second LERB workshop at Balatonfured, Hungary, September 1996.
* [2] << A custom floating point ADC dedicated to LHC calorimetry >> by Valerie Hermel. Paper presented at the second LERB workshop at Balatonfured, Hungary, September 1996.
* [3] R. L. Chase : Private discussions, 1995
* [4] << Fully bipolar, 120-Msamples/s 10-b Track and Hold circuit >> by Pieter Vorekamp and Johan P. M. Verdaasdonk, IEEE journal of solid-state circuits, July 7, 1992.
* [5] << Design of a 100MHz 10mW 3V Sample and Hold amplifier in digital bipolar technology >> by Behzad Razavi, IEEE journal of solid-state circuits July 7, 1995.

Figure 11: A closer look on signals to evaluate speed. This represents the analog output with two inputs. The two different hold levels and the state of a digital output (shown on channel 2) show that gain have changed.

Figure 10: Some interesting signals as they are on the test board.