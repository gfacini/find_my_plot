# A Method for Determining First-Pass Fine Delays for the ATLAS TRT Detector

ATL-COM-INDET-2008-003

Sasa Fratina, Benjamin C. LeGeyt, James Saxon

This note describes the method used to calculate the first-pass clock and trigger delays used for running the ATLAS TRT (Transition Radiation Tracker) during the commissioning period. Before the TRT can take useful data, these timing parameters need to be tuned such that the data for the correct event are read out, and such that that those data are well framed. This method is notable for the TRT in that it does not require iteration based on particle data, but rather is based on measured cable lengths. This method has been shown to align the TRT timing to within 5ns of the optimal timing, based on cosmic ray studies done in December of 2007.

## 1 Introduction

### TRT Basics

The ATLAS TRT detector is a straw tracker which serves as the outermost layer of the ATLAS Inner Detector. It is composed of nearly 300,000 conductive carbon-fiber straws surrounded in scintillating material, each of which has a 30\(\mu\)m gold-plated tungsten wire running through the center. The basic operational principle in the TRT is that of a drift chamber, with the scintillating material additionally generating transition radiation which can be used for particle identification. The straws are all filled with gas (either \(ArCO_{2}\) or \(XeCO_{2}O_{2}\)), and have a large negative potential (nominally 1500V) applied with respect to the wire. When a charged particle passes through the straw (or when a transition radiation photon is absorbed in the gas), it liberates electrons from the molecules in the gas, which are drawn to the wire by thelarge potential. These primary electrons liberate more electrons as they are accelerated towards the wire, producing an avalanche signal which is read out by the ASDBLR chip (Analog Shaper, Discriminator, and Base Line Restorer). The ASDBLR receives and shapes the signal, canceling out the long ion tail, and then compares the signal to a pair of thresholds.

The output of the ASDBLR, which indicates whether the straw signal is above either of the two thresholds, is received and digitized by the DTMROC chip (Digital Time Measurement and Read Out Controller). The information corresponding to the lower of the two thresholds, which is used for tracking, is sampled every 3.125ns, while that corresponding to the higher of the two thresholds, which is used for detecting transition radiation for particle identification, is sampled every 25ns. When an event is requested via receipt of a level-1 accept (variously known as L1A, or level-1 trigger), the DTMROC outputs 3 bunch crossings, or 75ns worth of data - 24 bits of low threshold information and 3 bits of high threshold information1.

Footnote 1: There is also a ‘reduced readout mode’ where the last 4 bits of the third bunch crossing’s data are not sent. This is required to reach the highest readout rates specified for ATLAS, but is not used at the moment and will not be considered for this note.

Figure 1: Here a particle is shown crossing two straws at different radii, with the expected data resulting from these crossings shown. T-zero corresponds to the particle crossing time, while the leading and trailing edges correspond to T-zero plus the time it takes the liberated electrons to drift onto the wire from the radius of closest approach, and from the straw wall, respectively.

### Drift Time

In practice, these data only contain 3 measurable quantities: the time when the signal level went over the low threshold, the time when the signal level fell back below the low threshold, and whether or not the signal crossed the high threshold in any of the 3 bunch crossings. The first quantity, commonly referred to as the 'leading edge', indicates the earliest arrival time of electrons on the wire, and is directly related to the distance of closest approach of the particle to the wire. The second quantity, commonly referred to as the 'trailing edge', indicates the latest arrival time of electrons on the wire. The trailing edge time is more or less fixed with respect to the particle crossing time, as the latest arrivals are electrons which are liberated at the straw wall - a fixed radius of 2mm. These quantities are illustrated in Fig. 1. The third quantity (the crossing of the high threshold) is generally taken to indicate the absorption of a transition radiation photon, and will not be discussed in this note.

The rising and falling edges in the data are both critical to record for a given track. However, there is not a lot of room for error in the data window if this is to be accomplished. The maximum drift time for an electron (liberated near the wall of the straw, with a xenon gas mixture, and in the presence of a magnetic field) is 48ns [2], the minimum time-over-threshold for the ASDBLR is around 7.5ns [3], and there is also an unavoidable chip-to-chip timing spread of up to 5ns inherent to the front-end boards. Add in the need to have at least one time bin empty on either end of the data word to define a leading and trailing edge, and this gives a minimum window of nearly 70ns where useful data can occur. Because of this, the data has to be framed precisely in order to be able to see both the rising and falling edges of all possible signals in the 75ns data window.

### Fine Clock Timing

The precise positions of these rising and falling edges inside of the 75ns data window are determined by the phase between the passage of the particle and the rising edge of the DTMROC's clock, which drives the data sampling/binning. By varying the phase of the DTMROC's clock with respect to the LHC beam clock (and thus with respect to the particle arrival time), the position of the data window with respect to the particle data can be adjusted.2 This phase shifting is accomplished by means of a programmableclock delay, called the BX delay, which can be applied independently to each clock line in the TRT, and can be varied in steps of 0.5ns

Footnote 1: The TRT is the same as the TRT, but the TRT is not the same as the TRT.

### Coarse Trigger Timing

In addition, the coarse timing of the trigger signal has to be precisely tuned such that the proper event is selected for readout. Data are constantly being recorded by the DTMROC and stored in a pipeline, the total length of which can be set to anything from 0 to 255 bunch crossings, or 0 to 6.4\(\mu\)s. The length of this pipeline (commonly called the pipeline \(latency\)), along with the timing of the trigger, determines which event is returned when the DTMROC receives a trigger signal. For example, if the pipeline latency is set to 128 bunch crossings, then when the DTMROC receives a Level-1 Accept (aka Level-1 trigger), it will send out the data from an event which occurred 128 bunch crossings ago (3.2\(\mu\)s). This scheme is used so that the ATLAS trigger system has a window of time in which to decide if any given event is interesting enough to warrant reading out the entire detector. The implication of using this scheme is that, if, for instance, the pipeline latency is set to 128 bunch crossings, the trigger signal needs to be precisely timed such that it is latched at the DTMROC exactly 128 bunch crossings after the event

Figure 2: Diagram showing coarse timing for TRT readout. Only some of the many parts are drawn. The TDM delay must be precisely set such that the Trigger, TDM, and cable latencies are perfectly offset by the DTMROC L1 pipeline latency.

that should be read out has taken place. This chain is illustrated in Fig. 2, which shows the main blocks in the trigger/data chain. This timing alignment could be achieved by varying either the trigger delay or the DTMROC pipeline latency, but as we have no reason to vary the coarse timing chip-to-chip on a front-end board, the DTMROC pipeline latency is generally left at a fixed value for all chips, while the trigger delay is varied line by line to align the timing. That trigger delay, called the TDM delay, can be applied independently to every command (trigger) line in the TRT, and can be set from 0 to 255 bunch crossings (0 to 6.4\(\mu\)s) in steps of 25ns.

### Fine Trigger Timing

There is a third delay which is applied to the system, and that is the DX delay, a fine delay (0.5ns steps) which can also be applied to every command line. The DX delay is required to ensure stable communication with the DTMROC, and should be set such that the commands/triggers arrive at the DTMROC 180 degrees (12.5ns) out of phase with the clock. Since the DTMROC latches the command signals on the rising edge of the clock, the command signals need to be at a stable point for a short period before and after the clock edge is rising to ensure that they are latched correctly. This window is known as the'setup and hold time'. Setting the two signals to be 12.5ns out of phase assures that the setup and hold time is respected. Additionally, the setting of this delay also has a subtle effect on the trigger timing. This will be discussed later, in section 3.2 on choosing fine delay values.

### Delay Implementation and Granularity

The coarse and fine delays which are used to align the timing for the TRT are implemented both on the TRT-TTC and on the TTC patch panel, as

Figure 3: Schematic diagram of the clock and trigger distribution, with the locations of the BX, DX, and TDM delays indicated.

shown in Fig. 3. The granularity of these delays is a single TTC line, which is the name given to one set of clock, command, and reset lines going between the TRT-TTC and the front-end boards. One TTC line generally supplies a single front-end board3, which comprises between 9 and 15 DTMROCs, or 144 to 240 straws, depending on the board type. All straws within a single front-end board can be assumed to have the same timing, save for a small chip-to-chip timing spread totaling 3 to 5ns which is due to the board layout, and is particular to each board type. The BX delay is implemented on the TTC patch panel rather than the TRT-TTC because the clock signal is distributed once for every 10 lines from the TRT-TTC and then fanned out on the patch panel.

Footnote 3: one front-end board type (barrel board 2L) has two TTC lines. All other boards have one.

## 2 Finding Optimal Delays

### Requirements

In the case where the LHC is running at low luminosity and the TRT has a ready supply of clean tracks with a low-jitter trigger, achieving optimal timing would simply be a matter of taking a large enough data set while varying the timing parameters and setting some computer algorithm upon the task of suggesting changes in the timing such that the data would be properly framed. However, for the cosmic ray commissioning runs in the ATLAS cavern, neither a ready supply of clean tracks, nor a low jitter trigger for those tracks is generally forthcoming, so a track-independent method for determining the correct fine timing parameters is needed. This method needs to determine a set of delay values (BX, DX, and TDM delays) which will result in the clock and trigger/command signals for the whole detector being mutually aligned. After the detector's many clock and command signals are aligned with each other, it is relatively easy to add another BX and TDM delay globally (and hopefully only slightly) to achieve the ideal timing. This will provide a stable starting point from which refinements can be made as data accumulate. As will be described presently, the approach that was taken was to measure the electrical length of all the clock lines in the detector and to use this information to set up the relative delays such that they offset any differences in cable length, thereby aligning the signals at the front-end.

### Practical Concerns

As a practical matter, measuring all of the cable lengths for the whole TRT would be a daunting task. There are 1856 TTC lines in the whole TRT, each with its own clock and command line, resulting in 7424 individual lines which would need to be measured (counting type 3 and type 2 cables separately). While it would be possible to do this, it is not very practical, so certain shortcuts have been taken. First, the measurement was confined to the type 3 cables, which run between the TRT-TTC and the TTC patch panel (see Fig 3 for a reminder of the locations of the Type 3 and Type 2 cables). The type 2 harnesses - which run between patch panel 2 and the front-end boards for the barrel, and between patch panel 2 and patch panel 1 for the endcap - were supposed to have been cut to exact lengths, using individual twisted pair wire, so these lengths can be calculated based on the specifications for the cables.4 The endcap type 1 harnesses, which go between patch panel 1 and the front-end boards, were built on a jig, rather than being cut to a specific length, so their lengths would have to be measured. There are 64 type 1 harnesses for the whole endcap (32 each for endcaps A and C), each carrying 20 clock and trigger lines. However, these harnesses should be identical, so a single set of length measurements could be used for all 64 endcap type-1 harnesses. Further, as the clock line that supplies a given group of front-end boards is fanned out on the TTC patch panel, there is only 1 clock line in each type 3 TTC cable, which carries 10 TTC lines in total (9 for the barrel). If we go even further, and assume that no line in any single type 3 cable will be significantly different in length from any other line in that cable (\(i.e.\) more than about 12.5ns), then we are safe in assuming that all pairs in one type 3 cable effectively have the same length, and we only need to measure one line in each type 3 TTC cable to achieve our goal (the importance of this assumption will be discussed in more detail in section 3.3). These assumptions bring the number of lengths to be measured down from 7424 to 212, a much more reasonable number.

Footnote 4: Measuring the lengths of these cables was also a practical impossibility, as they were all installed and thus inaccessible before the measurement work was started

## 3 Procedure

### Measurement Procedure

The electrical length of the clock line in every type 3 cable was measured, and the electrical length of the type 2 cables was calculated from a tableof physical lengths which was used for their construction, along with the known propagation time for the wire that was used (5.3ns/m). In addition, a sample of endcap type-1 harness lengths was measured, with the lengths of the different harnesses averaged to arrive at a single set of electrical lengths which was used for all 64 harnesses. The technique used for the type 3 cables was a simple one: a square pulse was sent differentially through the clock line of the cable in question, and the time between the rising edge of the sent pulse and the rising edge of the reflected pulse was measured using an oscilloscope. This time was divided by 2 to arrive at the electrical length of the cable. The electrical lengths of the type 3 cables were between 283 and 442ns, while the lengths of the Type 2/Type 1 cables were between 40 and 75ns. The measurement accuracy for this method was estimated to be \(\pm\)3ns for the total cable delay. It should be noted that the propagation time through the TTC patch panel was not included in this calculation as it was observed to be near enough to identical for all lines.

### Choosing Fine Delays

#### 3.2.1 BX delay

Using this method, the differences in the BX clock phases are easily determined by taking the total length in nanoseconds (type 3 + type 2) modulo 25. The proper BX delay is then obtained by taking 24 minus this number (the range of allowed BX values 0 to 24). This will line up the rising clock edges for the whole detector (without particle propagation differences), and has been shown to do so based on the cosmic ray data from the ATLAS M4 commissioning run and the TRT-specific 'MTRT' commissioning run. The rest of the delays require a bit of finesse.

#### 3.2.2 DX delay

First, the DX (data) delay has to be chosen, based on the results of a TTC fine delay scan, so that stable communication between the TRT-TTC and DTMROCs is achieved. The TTC fine delay scan (an example scan is shown in Fig. 4) varies the BX and DX delays over their full ranges, and tests communication between the TRT-TTC and DTMROCs for each combination of the two parameters. Blue boxes indicate a failed write-read communication cycle, with the shading indicating the fraction of chips which failed to communicate properly. These scans typically take the form of a diagonal dead band, where BX minus DX is constant, and a vertical dead band, where BX is constant.

The diagonal dead band results from delay combinations where the clock and command signals have rising edges which coincide at the front end and the DTMROC cannot latch the commands. The vertical dead band results from delay combinations where the rising edge of the returning data coincides with the rising edge of the TRT-TTC's internal clock, and thus cannot be latched by the TRT-TTC. Using the results of this scan, the value for the DX delay is generally chosen such that the operating point with the given BX delay is as far from the diagonal dead band as possible, providing the most stable communication.

#### 3.2.3 TDM delay

The TDM delay is chosen, in a rough sense, by rounding the cable length up to the nearest multiple of 25ns, and adding a constant value which depends on the latency of the L1A pipeline on the DTMROC, as well as the latency in the trigger system. In the idealized case, this is all that is necessary to align the timing for the detector. However, there is an ambiguity which is introduced by the choice of DX delay which can cause the TDM delay to be off by 1 count. This ambiguity can be resolved by introducing a TDM offset based on the BX/DX operating region that is chosen.

### TDM Ambiguity from DX Choice

The simplest way to understand this ambiguity is to look at Fig. 5. Since the diagonal dead band in the fine delay scan represents the phasing where the clock and command rising edges are aligned in time, picking a point in phase space above or below the diagonal band means placing the rising edge of the command signal either before (P2, from Fig. 5), or after the rising edge of the clock (P3, from same). Since the command is latched on the clock tick directly after its last bit is received, moving the DX delay from above to below the diagonal line (or vice versa) has the same effect as changing the TDM delay by 1 count.

In order to account for this, it is necessary to define regions that are 'above' and 'below' the diagonal line and keep track of which region is chosen for the BX/DX operating point in order to make the proper \(\pm 1\) correction to the chosen TDM delay. In the case where the clock and command lines have the same electrical length, the diagonal band will be centered around \(BX-DX=0\) and the 'above' and 'below' regions are clearly defined (see Fig. 6, scan A). However, when the command lines are not the same length and the diagonal band starts somewhere else along the BX axis, it becomes less and less clear what is 'above' and what 'below' (Fig. 6, scans B and C). The worst case is when the diagonal band is centered around BX = 12.5ns (Fig. 6, scan D). Here we are lost and without the benefit of other forms of measurement, we can only guess which region corresponds to 'above' and which 'below'.

The zeroth order way to get around this problem is to ignore it, and to assume that no command-in line is different in length from the clock line in its cable by more than 12.5ns. Based on this assumption, the algorithm that would be used for determining whether a given point in BX/DX phase space is above or below the diagonal line would be the following:

Determine the center of the portion of the diagonal dead band that touches the BX axis in terms of \(BX-DX\). Call this value \(C\). If \(C\) is less than 12.5, define the 'above' region as all points having \(BX-DX\) less than \(C\), with the 'below' region defined by all points having \(BX-DX\) greater than \(C\). If the center of the diagonal dead band touches the BX axis at a value of \(BX-DX\) which is greater than 12.5 (\(C>12.5\)), define the 'above' region as all points where \(BX-DX+25\) is less than \(C\), with the 'below'

Figure 5: P1, P2, and P3 represent 3 different regions in fine delay phase space. P1 will result in unstable readout. P2 will result in stable readout with events latched at BC4 (the trigger command is 3 bits long), and P3 will result in stable readout with events latched at BC5.

region being defined by all points where \(BX-DX+25\) is greater than \(C\).

This method was tried for the ATLAS M4 commissioning run, and while it did choose most of the delays correctly, it left a small percentage (around 5%) which needed to be adjusted by 1 TDM. This showed that the previous assumption (that no command-in line is more than 12.5ns different from its respective clock line) does not hold for the whole detector.

In an attempt to understand this, a systematic study of the diagonal dead band positions in the fine delay scans of many TTC lines was made, and it was found that there is a systematic shift away from \(BX-DX=0\) particular to each TTC line. This was eventually determined to be due to systematic variations in the length of the individual twisted pairs inherent in the production process for the 25-pair type 3 TTC cables that were used. Some pairs are always longer than others, and by studying the position of the

Figure 6: Four possible TTC fine delay scan results are shown. For the first three (A-C), the regions that fall above and below the diagonal dead band are clear (and are marked as such), while for scan ‘D’ the ‘above’ and ‘below’ classification is impossible due to the position of the dead band.

diagonal dead band for many fine delay scans, it was possible to quantify this shift for each of the 10 TTC lines carried in a single type 3 cable. Once these systematic shifts were factored in, the variation in command-in line lengths with respect to the clock line length became less than 12.5ns for the entire M4 sample, and the above algorithm could be used reliably to determine the proper TDM shift.

## 4 Results

The coarse and fine delays for the TRT-specific MTRT Commissioning run, which took place in December of 2007, were chosen using the measurements and methods described above. The total number of TTC lines used (i.e. delay values that needed to be set) for this run was 454, of which 234 were serving the TRT barrel and 220 were serving the TRT endcap. Track reconstruction for the endcap was not available for this run, so the evaluation of results is limited to the barrel. The MTRT run looked at data from cosmic rays, using both a scintillator trigger and a trigger supplied from the ATLAS Tile Calorimeter. The most straightforward metric for measuring the timing alignment is the average trailing edge time. The position in time of the trailing edge should be relatively constant for any given straw, and the average trailing edge time is a good indication of where in the data window the data are occurring. As the MTRT run was looking at cosmic rays, the particle arrival phase must be corrected for. Also, in order to gain more statistics, all straws on a given TTC line can be grouped together.

Figure 7 shows the distribution of average trailing edge times for the TRT Barrel in the MTRT Commissioning run. Only data from front-end boards that had at least 5 hits on track during this particular run have been included. There were 3 boards excluded based on that cut, 2 of which were at the edge of the active region, with the other having known readout problems unrelated to the timing. The time on the X axis has been shifted so that the distribution falls around zero. The important thing to note here is that the distribution is regular and nearly all average trailing edge times fall within a range of \(\pm 5ns\) from the average. This is even without particle flight time factored in, which should itself account for roughly 5ns of difference between the top and bottom portions of the detector. There are no outliers among the boards/TTC lines which have been included, which shows that all cable length measurements were correct, and that all TDM shifts from DX choice have been correctly accounted for. This result is taken as a good indication of success for this method in its stated goal of achieving mutual timing alignment for the entire detector.

## 5 Conclusions

A Method for determining TRT clock and trigger delays based on cable length measurements has been described. This method was used to choose the delays for the TRT-specific MTRT commissioning run with good success, aligning particle data for all boards to within \(\pm 5\)ns. This method will continue to be used as a basis for choosing first-pass delays in the future until a sufficient data volume is accumulated to suggest more fine grained corrections to the timing, as well as corrections for particle time-of-flight.

## References

* [1] Mike Hance, ATLAS TRT timing note, [https://twiki.cern.ch/twiki/pub/Atlas/TrtDAQ/timing.pdf](https://twiki.cern.ch/twiki/pub/Atlas/TrtDAQ/timing.pdf).

Figure 7: This is the distribution of the average trailing edge time for all barrel front-end boards in the MTRT commissioning run with at least 5 hits on track. Particle arrival phase has been corrected for, but particle time-of-flight has not.