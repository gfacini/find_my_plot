**ATLAS Internal Note**

**LArG-No-92**

**Date 11 MAR 98**

**THE LAr TRI-GAIN SHAPER**

_J. Collot, D. Dzahini Institut des Sciences Nucleaires de Grenoble, IN2P3-CNRS et Universite Joseph Fourier 38000 Grenoble Cx, France C. de La Taille, J.P. Richer Laboratoire de l'Accelerateur Lineaire, IN2P3-CNRS et Universite Paris-Sud 91405 Orsay Cx, France F. Lugiez, J. Pascual, J. Teiger CEA,DSM/DAPNIA, Centre d'Etudes de Saclay 91191 Gif-sur-Yvette, France_

This note reviews the characteristics of the monolithic tri-gainshaper chosen by ATLAS to equip the LAr calorimeters. It describes the requirements and circuit architecture and specifies the pinout and inputs/outputs for both Backup (V1) and Mod 0 (V2) versions. The measurements of speed, noise, linearity, crosstalk and preliminary radiation tolerance are given for both versions.

Introduction

As desribed in the ATLAS calorimeter Technical Design Report (TDR) [1], the shaper is located between the preamplifier and the analog pipeline. Its function is to optimize the signal to noise ratio, which is the quadratic sum of the electronic noise (decreasing with slower shaping) and pileup noise (increasing with slower shaping). Its architecture (CRRC\({}^{2}\)) consists of one differentiation to remove the long trailing edge of the liquid argon signal and several (here two) integrations to limit the useful bandwidth and reduce the electronic noise. This architecture is a good compromise between the number of stages and thus the power dissipation and the filtering performance, as it is only 10% worse than an ideal filter. Further downstream digital filtering [2, 3] achieves optimal filtering and also allows one to choose slower shaping when running at low luminosity.

The shaper also provides additional amplification, so that the preamplifier noise be dominant compared to that of further stages. However, due to the very large dynamic range of the input (16 bits) and the typical dynamic range of the readout (12 bits), this requires three different outputs with gains in a ratio of typically 1-10-100. The limited space available requires the use of monolithic circuits housing four channels each with three gains, as well as an additional summing stage (or linear mixer) for the Level 1 trigger. Two chips are now available as prototypes in BiC MOS 1.2\(\mu\)m from AMS [4] :

\(\bullet\) a "backup" (V1 and V1bis) version intended for Module -1 tests (oct 97) with analog Front End Boards (FEB-1)

\(\bullet\) a "Mod0" (V2 and V2 bis) version for the tests of modules 0 and the first Front End Boards (FEB0).

These 2 versions, housed in a QFP100, are pin to pin compatible and 2000 chips of the latter will be produced in 1998 to equip the 48 FEBs0 necessary to scan Barrel and End-Cap modules in Test-beam. They have passed a Design Review at CERN in march 97 [5].

Described in this note are the requirements for the shaper as they have slightly evolved from the TDR [1], a brief description of the architecture, comparing the two versions and a detailed description of the pinout. Then the performance of both versions is given with respect to speed, noise, gain, saturation behaviour, linearity and crosstalk, including the linear mixer.

### Theoretical expressions [6]

The CRRC\({}^{2}\) filter is a bandpass filter, whose transfer function is given by :

\[H(s)=\frac{\tau s}{(1+\tau s)^{3}}\]

in which \(\tau\) is the shaper time constant (\(\tau=\)RC), chosen to minimize the total noise ; it is typically about 15 ns (_cf._ 1.4). The central frequency of the filter is \(f_{c}=1/2\pi\surd 2\tau\), corresponding to approximately 8 MHz.

The step response of such a filter is simply :

\[h_{\tau}(t)=\frac{1}{2}\Big{(}\frac{t}{\tau}\Big{)}^{2}e^{-t/\tau}\]It reaches its maximum at \(t_{m}=2\tau\) and the peaking time (5-100%) is \(t_{p}=1.82\tau\).

When the shaper is preceded by a preamplifier whose risetime \(\tau_{pa}\) is not negligible, this affects both the amplitude after shaping and the peaking time. Analytical expressions for signal shapes are given in Ref.[6]. This is the case in the ATLAS calorimeters, as indicated in the following section, which renders the specification of gain and peaking time somewhat misleading. Therefore, in the following the shaper gains will be defined for a step input (\(\tau_{pa}=0\)) and the Figure 1 can be used to evaluate the actual gain and peaking time for various preamp risetimes.

### Input signal

The signal from the preamplifiers is described in a separate note [7]. In the E.M. calorimeters, it is a negative going triangular voltage, with a duration \(t_{dr}\approx 450\) ns in the Barrel and \(200\) ns \(<t_{dr}<500\) ns in the E.M. End-Cap. This signal has a maximum amplitude which varies with the pseudorapidity and the preamp gain1 but never exceeds -4 V into any impedance load. The preamp risetime \(\tau_{pa}=R_{0}C_{d}\) is given by the cable impedance

Figure 1: Shaper output amplitude and peaking time as a function of the preamp risetime \(\tau_{pa}\)(for a triangular current input decaying in 450 ns). With \(\emptyset\)T preamps, \(\tau_{pa}=R_{0}C_{d}\) in which \(R_{0}\) is the cable characteristic impedance and \(C_{d}\) the detector capacitance (_cf._ Fig. 2).

\(R_{0}\) (25 or 50 \(\Omega\)) and the detector capacitance \(C_{d}\) which is a widely varying function of sampling depth and pseudo rapidity. Both parameters \(V_{max}\) and \(\tau_{pa}\) are shown in Fig. 2.

In the hadronic End-Cap (HEC), a pole-zero unit plugs-in in place of the \(\emptyset T\) hybrids and delivers a similar signal, with a maximum amplitude of -3V and a constant rise time \(\tau_{pa}\) = 20 ns.

In the forward calorimeter (FCAL), the same preamps are used as in the E.M. above, but with a transformer in the cold to perform a ganging by four. The signal is similar, _except for its shorter duration_\(t_{dr}\) = 50 _ns_ which leads to a larger undershoot after shaping. It is dealt with using a preamp type such that the maximum amplitude does not exceed -2 V. Besides, the risetime is constant at each calorimeter sampling : \(\tau_{pa}\) = 35 ns.

Figure 2: Preamplifier maximum output voltage and risetime versus pseudorapidity in the E.M. calorimeter. The maximum energy in one cell is 1.5 TeV at \(\eta=0\), corresponding to 4 mA. Taking into account the kinematic limits, the overall maximum current is 10 mA (at \(\eta=1.4\)) [7].

### Output signals

The shaper has two different outputs : one for precise energy measurement goes to analog memories with different sets of gain ; the other is used immediately to form Trigger sums for Level 1. Both signals exhibit similar shapes, described in Ref. [6] and sections 3 & 4.

1) **Signal into Pipelines** : it has been shown [8, 1] that in order to ensure negligible contribution from the readout (pipelines + ADC), two gains in the shaper are mandatory and that using three gains provides a welcome safety margin against any unanticipated coherent noise in the readout. The optimum gains are in that case in a ratio of typically

Figure 3: Calculated shaper outputs versus pseudorapidity. Top left : Amplitude on High gain for 1 GeV in the calorimeter. Top right : _rms_ noise at the High gain output. Bottom left : Peaking time (5-100 %) to the triangular detector current. Bottom right : Peak position. The shaper assumed here is the Mod0 version (V2) with a high gain of 100 and a time constant \(\tau\)=13 ns.

\(1/10/100\), thus each shaper has 3 outputs : Low Medium and High.

The output voltage swing is chosen in order to match the pipeline input range, nominally -0.9/+3 V. _It should not exceed the pipeline power supplies : +3.3 V, -1.7 V._ The output impedance is set to approximately 50 \(\Omega\) in order to handle capacitive load or output lines without risk of oscillation. The load should be larger than 1 k\(\Omega\) in order to permit the full output swing. The DC level is typically2 0 \(\pm 10\) mV.

Footnote 2: Setting the baseline to any chosen DC level is in principle possible by shifting all the power supplies, but would need a dedicated study as any noise on this level would be amplified and coherent over a board.

2) **Signal into layer sums** : The 4 channels of a shaper chip must be summed together in order to form trigger towers. It has been shown that they should be summed before shaping in order to achieve acceptable noise performance [5]. A switch in series with each input has been deemed necessary in order to remove bad or noisy cells from a trigger tower. This sum is then shaped with a CR RC structure and the output signal swing is similar to the regular shaper outputs. No gain or timing adjustment is provided here : it will be done in the Tower Builder Board [9].

### Shaping time

The shaping time has been chosen to optimize the signal to noise ratio at maximum luminosity (\(L=10^{34}\)) over a wide range of rapidities (Barrel and End-cap) as shown in Fig. 4.

The shaping function can be further optimized by combining several (5) samples on the waveform, usually referred to as Digital Filtering or Multiple Sampling [2, 3]. As can be seen from Fig. 5, the shaping can be optimized over one decade of luminosity in each direction around \(L=10^{34}\). However, a time constant smaller than \(\tau=15\) ns jeopardizes the digital filtering because of spectral aliasing around the sampling frequency of 40 MHz. **Therefore, the shaper time constant for the V2 will be trimmed to \(\tau=15\) ns.** In ATLAS, it is envisaged to be able to download the time constant via the bus, to optimize the shaping time in various regions.

Figure 4: Optimum shaper time constant \(\tau\) at various rapidities : barrel center (\(\eta\)=0.1), barrel edge (\(\eta\)=1.2) and End-cap center (\(\eta\)=2) (from [10]).

## 2 Shaper design

### Architecture

The shaper is made of three sections in parallel (\(cf.\) Fig 7) to provide the three different gains. A first input stage provides some gain, around -15, to minimize subsequent noise contributions in the high gain sections. Then a first integration is done by a passive RC filter followed by a second amplification stage. The three output stages are identical and consist of a Sallen-Key structure to form the last CRRC with a gain of 5 to compensate for the signal attenuation due to the differentiation. The differentiation is performed in the last stage in order to maintain almost3 zero net area even for overload signals, thus avoiding baseline shifts at high rates with AC coupling. It also minimizes all the variations of offset and drift of the previous amplifying stages.

Footnote 3: In practice the area is not perfectly zero (_cf._ Fig. 22) as the output stage has a gain slightly too large for its output swing. Ensuring zero area would necessitate to lower the gain in the output stage to \(\sim\)3. This would reduce the dynamic range in the low gain by the same factor.

Each stage uses a similar operationnal amplifier design, described in Ref. [11] which features an open loop gain of 500 and a gain-bandwidth product of 500 MHz. The input

Figure 5: Noise after multiple sampling with \(\tau=15\) ns. The gray solid line is the noise with optimal hardware shaping time, the black solid curve _without_ digital filtering and the dashed line _with_ digital filtering (from [3])stage of the high gain section uses large input transistors to achieve noise as low as 1.3 nV/\(\surd\)Hz.

One concern with the AMS 1.2 \(\mu\)m BiCMOS technology is the 7 V maximum power rating, whereas to deliver a 5 V output swing, a 7.5 V power supply is necessary. However, these ratings are most stringent for short MOS transistors whereas the design is based mostly on bipolar transistors, all of them operated far from the breakdown region (\(BV_{CE0}\) = 6-8 V) under all circumstances. The MOS current mirrors and switches are made with long transistors which again never experience more than 5 V. Nevertheless, aging tests are being conducted at elevated temperature4 to gain confidence in this operation mode.

Footnote 4: 168 hours at 125°C equivalent to 6000 hours at 50°C.

### Backup version V1

The Backup version (Fig. 7) is directly derived from a former quad-gain shaper [11] as a very conservative modification of a fully functional circuit : one gain has been removed, their values have been slightly modified to 1, 5 and 50. The shaping time constant has been kept to its original value of \(\tau\) = 13 ns \(\pm\) 5 ns and there is no adjustment network. A dummy output stage is also available for DC tracking, but without any filtering. The linear mixer is also the copy of a preceeding version which summed the low gain outputs, at the expense of a sizeable noise contribution.

84 chips have been produced for testing purposes5 only and are labelled 96-004. Most of them have been used on the FEBs-1 in nov 97 testbeam. They are now replaced by the V1bis described below.

Figure 6: Schematic of the operationnal amplifiers used

### Backup version V1bis

The original backup version has been slightly modified before low volume production for module-1 and FCAL testbeam. The high gain and low gain inverting inputs have been tied together internally and the input protection diodes have been included on-chip. All the rest is strictly identical and this version is now 100% pin to pin compatible with the Mod0 version, although some settings differ6. 182 chips have been produced in April 97 and are labelled 8308-005.

Footnote 6: \(\bullet\) The backup is powered with \(V_{DD}\) = 6 V although the standard \(V_{DD}\) = + 4.5 V can also be used, with only a small degradation in linearity and a useful output swing limited to 2.5 V (_cf._ Fig. 3.2).

\(\bullet\) The backup linear mixer is supplied with a particular positive supply : \(V_{DDS}\) = + 3 V.

\(\bullet\) The backup linear mixer requires a reference voltage \(REF_{AMP}\) = 0.7 V on pin 65.

\(\bullet\) If an external resistor is used on \(V_{REF}\) to set the bias current to its nominal value without being sensitive to the internal resistors accuracy (_cf._ Fig. 12) this resistor should be changed (see pinout).

Figure 7: Schematic Diagram of the Backupshaper V1

### Mod0 version (V2)

The version for module 0 (V2) incorporates several modifications, as can be seen from Fig. 8.

i) A bank of capacitors and switches to tune the peaking time to its nominal value has been implemented. This function had already been tested in a former bi-gain prototype. It allows a variation of \(\pm\) 33% around the nominal value of 15 ns, mostly to compensate for process variations as high as \(\pm\) 15% on resistors and \(\pm\) 10% on capacitors7.

Footnote 7: Simulations with the minimum resistor and capacitor values yield 7.7 ns \(<\tau<\) 15.1 ns and with the maximum values 14.3 ns \(<\tau<\) 28.6 ns.

ii) The high gain input amplifier has a transistor across its feedback path, in order to keep constant the input impedance even in saturation. The transistor turns "on" for input pulses larger than 0.2V and provides the large return current for the \(\emptyset\)T. The input impedance becomes : \(Z_{in}\) = 50 + (250/500)/\(\beta_{NPN}\)\(\approx\) 52 \(\Omega\).

iii) The medium gain does not share its input amplifier with the low gain in order to lower its noise figure to 350 \(\mu\)V \(rms\).

iv) The low gain has been reduced by a factor close to two in order to accomodate the full dynamic range and deliver 3 V for the maximum input voltage (\(\approx\) 4 V)

v) The power dissipation has been brought down to 100mW/ch by reducing the static current and supply voltages, leading to a total dissipation of 500mW per chip. The impact on noise and linearity has been shown acceptable [5].

vi) The linear mixer has been thoroughly changed to reduce its noise. The circuit sums the output of 4 preamplifiers with an additionnal gain of 3.5 in the Barrel and part of the End-cap, or unity gain in the rest of the End-cap [1]. These gain values are selectable through an external pin on the chip. The last stage of the linear mixer is a CRRC shaping section, identical to the output stage of the shaper.

vii) The linear mixer is also equiped with enabling switches, which permit the exclusion of any preamp from the trigger sum. A control logic has been implemented (_cf._ Fig. 9) which allows activation of these switches from a 4 bit data bus and encoded addresses8.

Footnote 8: An RC network followed by an inverter has been added to set all the switches “on” at power on. Unfortunately, this RC time constant seems too small to be effective and the switches will have to be loaded from the data bus.

viii) The dummy output stage is identical to the other output stages, with a full Sallen-Key structure to reduce its white noise and improve matching.

**Failure modes** : some attention has been devoted to failure mode analysis. Series resistors are inserted at the output to protect against short circuits and to handle capacitive loading. The inputs are protected with diodes to \(V_{DD}\) and \(V_{SS}\). Also series resistors (2 k\(\Omega\)) have been added on each bus input in order not to bring down a whole bus in case of a short-circuited input. Further studies are needed to ensure that a damaged circuit cannot overload power supplies9.

Figure 8: Schematic Diagram of the Mod 0 shaper V2

### Pinout

The chip has been housed in a 25-mil pitch flat package QFP100, in order to match nicely the following pipelines. The pinout has been carefully arranged in order to be compatible between the 2 versions.

**1) Input signals :**

* INM : inverting input. Directly connected to the preamp, DC coupled. The input bias current is less than 100 \(\mu\)A and the input impedance is 50 \(\Omega\pm\) 15%. The input swing is limited to \(V_{DD}\) and \(V_{SS}\) by internal protection diodes10.

Footnote 10: The first backup chip V1 (now obsolete) had 2 separate inputs for high gain and low gain, which must be tied together externally. It also needs protection diodes to \(V_{DD}\) and \(V_{SS}\)

* V_REF : static current adjustment, tied to GND. If a current adjustment is needed, connect to \(V_{DD}\) through a resistor such that \(I_{REF}\) = 4.9 mA (4 mA in V1), which defines the current in all opamps. This resistor is typically 1150 \(\Omega\) for the V1 and 900 \(\Omega\) for the V2.

**2) Output signals :**

Figure 9: Control logic of the Mod0 shaper V2* OUT_HG : High Gain output. Directly connected to the pipeline. The output offset voltage is below \(\pm\) 5 mV and the maximum output swing is -2V\(/+\) 3.5V. An internal 50 \(\Omega\) resistor allows some capacitive loading (\(<\) 50 pF). The output can also drive a 50 \(\Omega\) load, but with only a limited output swing (typ 1V), particularly in the negative direction.
* OUT_MG : Medium Gain output. _id_.
* OUT_LG : Low Gain output._id_.
* OUT_REF : Dummy stage output. Directly connected to the pipeline reference input. Exhibits similar offset and low frequency noise as the regular outputs, as all the output stages are identical.
* OUT_SOM : Mixer positive output. Directly connected to the layer sums input.
* REF_SOM (V1) : Internal 50 ohms to ground (not used).

**3) Power supplies :**

* \(V_{DD}\) : +4.5 V, 35 mA (+6V 100 mA for the backup12).
* \(V_{DDS}\) : +4.5V, 3.6 mA (+3V for the backup) Mixer.
* \(V_{DDIN}\) : +4.5V, 18 mA Shaper input stages.
* \(V_{DT}\) : +4.5V. High Gain feed-back transistor (saturation suppression). Should be brought and decoupled very close to the inputs as it provides the large return current of the \(\emptyset\)T.

Footnote 12: The backup can also be used with \(V_{DD}\)=4.5V see footnote 6

* \(V_{DDD}\) : 0V. Digital block
* \(V_{SS}\) : -3V (65mA).
* \(V_{SSS}\) : -3V. Mixer.
* \(V_{SSD}\) : -3V. Digital block.
* G ND : 0V.
* G NDS : 0V. Mixer.
* REF_AMP (V1) : DC Reference input voltage for the mixer (-0.7 V). This value should be tuned in order to obtain 0 V at the linear mixer output.

**4) Control pins :** Logic levels are "0"= -3 V; "1"= 0 V.
* GAIN (V2) : Connected to GND to multiply the gain of the mixer by a factor \(\thicksim\)3. Left open, the linear mixer has unity gain. The unity gain is used in the middle section of the End-Cap. The parasitic capacitance between this pin and the neighbouring OUT_SOM should be minimized to avoid ringing in unity gain.

* CS (V2) : Chip Select, active "LOW". Individual input.
* M0/M1 (V2) : Bus inputs. Used to select one of the four modes : Read, Write, Broadcast 0 or Broadcast 1 (_cf._ Fig. 9).
* STROBE (V2) : Bus input, active "HIGH".
* UP/DOWN (V2) : One bus input per side of the Front-End Board, active "LOW".
* FORSW0\(\thicksim\)3 (V2) : Four bus inputs. Force the mixer input switches \(V_{SS}\)\(\thicksim\)", GND \(\thicksim\)" 0FF For the backup (V1) these inputs are :
* A0\(\thicksim\)3 with opposite logic levels (!) : \(V_{DD}\)\(\thicksim\)" 0N", \(V_{SS}\)\(\thicksim\)"
* D0\(\thicksim\)3 : Data bus to activate the linear mixer switches.
* CS0\(\thicksim\)3 / PROG : Programming inputs for peaking-time adjustment : \(V_{DD}\)\(\thicksim\)"0N", \(V_{SS}\)\(\thicksim\)"OFF". These inputs will not be accessible after trimming, as internal fuses will have been blown to obtain the specified time constant.

Figure 10: Pinout of the shaper V1 (top) and V2 (bottom) in QFP100

### Recommended PCB layout

The recommended shaper implantation is shown in Fig. 11. As the power supply rejection is not very high at high frequency, it is important to provide good decoupling of \(V_{DD}\) and \(V_{SS}\), using power supply planes for example with 100 nF surface mount capacitors. This is particularly stringent for the \(V_{DD}\) on the input side, which supplies the return current for the \(\emptyset\)T, up to 100 mA. The parasitic capacitance between the linear mixer output and the gain setting pin should be minimized in order to avoid ringing on the sum output.

### Test setup

Most measurements have been performed on a dedicated 4 layer test circuit, keeping a layout as close as possible to what would be used on the front-end boards. The schematic diagram is shown in Fig. 12 and uses switchable opamps to select the desired output channel. For most measurements, a socket13 has been used, except for crosstalk measurements, for which the circuit is soldered directly on the PCB.

Figure 11: Schematic diagram of the recommended implantation for the V2 chip

## 3 Measurement results on Backup V1 and V1bis

60 prototypes have been received beginning 97, which were all working according to specifications. The main problem encountered has been the destruction of the input stage when switching off the preamp power supplies, attributed to a 10V transient on the 1 \(\mu\)F coupling capacitor. Protection diodes have thus been added on the test circuit and directly on the chip for the V1bis, 182 of which have been received in january 98. The yield was measured to be 90%.

### Gain, speed and noise values

As explained in the introduction, the gain is measured for a step input in order not to be restricted to a given preamp risetime. The actual gain and speed with the preamp in front can be obtained from Fig. 1 and the shaper time constant \(\tau=15\) ns, extracted from the table below14.

Footnote 14: For example, the usual values for the middle \(C_{d}=1.5\)nF equiped with a #T 25 \(\Omega\) gives \(\tau_{p\,a}=37.5\) ns and \(\lambda=2.5\) with the shaper V1. The gains are then multiplied by 0.56 and the peaking time goes from 27 ns to 46 ns.

\begin{table}
\begin{tabular}{|c||c|c|c|} \hline V1bis & Gain & Noise (\(\mu\)V) & \(t_{p}\) \\ \hline High Gain & 69 & 730 & 30.3 \\ Medium Gain & 6.9 & 480 & 30.2 \\ Low Gain & 1.4 & 260 & 29.5 \\ \hline Mixer & 2.5 & 1150 & 29.8 \\ \hline \end{tabular}
\end{table}
Table 1: Gain, speed and noise measured on the V1bis shaper, for a stepinput. The mixer is measured with no preamp. The V1 version gives almost identical results, but the peaking time is 3 ns shorter.

Figure 12: Schematic diagram of the test setup

### Saturation behaviour

The saturation behaviour is measured with a \(\emptyset\)T 'B' preamp in front of the shaper and a triangular signal to emulate the liquid argon pulse. It is in good agreement with Spice simulations and more details are given for the V2 version.

Figure 13: Dispersion on gain (top row) and time constant \(\tau\) (bottom row) over 100 channels of V1bis. The gain ratios exhibit a slightly smaller dispersion : HG/MG=9.87 \(\pm\) 0.11 and MG/LG=4.88 \(\pm\) 0.057.

### Linearity

The linearity is measured with a \(\emptyset\)T preamp in front of the shaper. The calibration pulse is sent through a 500 \(\Omega\) injection resistor to a detector capacitance of 1.3 nF connected to the preamp input via a 3 meter long 25 \(\Omega\) coaxial cable. The signal from the shaper is sampled at the time of the peak with a very fast Track and Hold and digitized with a 12 bit ADC. The input signal goes through an attenuator (14 and 34 dB) to cover the three gains. The maximum input current corresponds respectively to 80 \(\mu\)A, 0.8 mA and 4 mA, which give 2.5V at the shaper output. Two sets of measurements have been performed, changing only the positive power supply \(V_{DD}\) from the nominal 6 V to 4.5 V, compatible with the V2 version. On the Medium gain, two slopes can be observed which can be attributed to the change of input impedance at 0.3mA, when the High gain saturates15.

Figure 14: Saturated signals on the shaper V1bis, with \(V_{DD}\)=4.5V and 6 V. The preamp is ’B’ type (25 \(\Omega\)) with \(C_{d}\)=1.3nF and \(I_{in}\)=4 mA. More details on the saturation behaviour are given on the V2

### Crosstalk

The crosstalk is measured with the setup shown in Fig. 11. A signal is applied to channel 4 of the preamp in order to get 1 V at the high gain output of the shaper. The signals on the three other channels are shown, for each of the three gains, directly in permil16. The operation is repeated, with the input signal increased in order to obtain 1 V on the medium, then low gain. Of course, the worst case is obtained with a large signal in the low gain and looking at the high gain output of the neighbour (30 mV). In practice, these channels would be neighbours in the detector and the lateral width of the E.M. shower is likely to dominate largely the contribution from the shaper.

Figure 15: Linearity of the shaper V1. Measurement with a \(\emptyset\)T B (25 \(\Omega\)) in front with \(C_{d}=1.3\)nF. The full scale on each gain gives 2.5 V at the shaper output and corresponds to 0.08, 0.8 and 4 mA (30, 300 and 1500 GeV)Figure 16: Crosstalk measurements of the shaper V1. The signal is sent to Channel 4 (solid line) and observed at in channel 3 (dashed line), 2 (dots) and 1 (dash-dot). The top row corresponds to 1 V at the high gain output, the middle row corresponds to 1 V at the medium gain output, and the bottom row to 1 V at the low gain output. All the other channels are shown in mV.

### Linear Mixer

The linear mixer exhibits a saturation behaviour very similar to that depicted in the TDR [1] of a clamped waveform at 2.7 V. The gain and noise are shown in Table 1.

### Preliminary irradiation results

By design, the shaper should have sufficient radiation tolerance : it uses only fast NPN transitors (\(f_{T}=8\) GHz) in the signal path, operated at a relatively large current (\(\sim\)0.3 mA), which usually ensures inherent radiation hardness. Morevover, as in any well-designed bipolar transistor circuit, operation is insensitive to beta values, and hence to beta drop with radiation. The MOS transistors are also used in a configuration insensitive to their threshold voltage \(V_{T}\) (known to shift with gamma irradiation) : they are used in the current mirror in the opamps and as static switches, where the gate drive is more than adequate.

A former bi-gain prototype has been submitted to Neutron and Gamma irradiation as it incorporated the switches for peaking time adjustment. The Neutron irradiation was performed at SARA Grenoble in May 97 and the Gamma with a \({}^{60}\)_Co_ source at Saclay in october 97, with a dose rate of 2 krad/hr.

The chip shows satisfactory radiation tolerance, especially for gammas up to 10 times the expected dose at LHC. Measurements will be redone on a larger number of channels with the V2 chip.

Figure 17: Normal and saturated signals at the linear mixer outputFigure 18: Neutron and Gammairradiation results with a former bigain prototype. The large dispersion on peaking times between 0 and 50 krad is due to a temporary error in signal averaging.

Measurement results on Mod0 shaper V2

15 prototypes have been received17 in the middle of november 97, 7 of which were not working and are currently under investigation.

Footnote 17: 120 more have been received in february 98 to equip the prototypes of FEB0 and perform lab tests. The yield is around 90 %.

The main problems encountered have been :

i) a 10 mV offset at the \(\emptyset\)T output is amplified in the high gain section by -90 and deprives the second opamp of its polarization current, inducing distorted waveforms. This effect has been compensated for in the following measurements by adding a 15 k\(\Omega\) resistor to \(V_{SS}\).

ii) The control logic does not activate the switches. The logic and the switches work (data can be written and read back), but are not connected, due to a layout error.

### Peaking time adjustment

As explained in the introduction, the peaking time is measured for a step input into the shaper, using a pulse generator connected to the shaper input, replacing the preamp. The switches are selected manually, as shown in Fig. 11, and the peaking time 5-100% is measured on a digital oscilloscope for each bit setting. The results are shown in the table below and in Fig. 20. It can be seen that the shaper time constant \(\tau\) can be varied from 13 to 24 ns. _In the following measurements, the bit 4 will always be "on" to set \(\tau\) = 15 ns_.

Figure 19: Waveforms with \(I_{in}\)=1 mA at the \(\emptyset\)T ’B’ output (\(C_{d}\)=1.3nF) and shaper output with minimum and maximum peaking time settings.

### Gain and noise values

As with the peaking time measurement, the gain was first measured for a step input, without preamp. The input impedance has been measured to be 60 \(\Omega\), in good agreement with expectations and the parameter extraction from the foundry18. The output load

\begin{table}
\begin{tabular}{|c||c|c|c|c|c|c|} \hline  & \(l_{p}min\) (ns) & \(rms\) & \(l_{p}max\) (ns) & \(rms\) & \(\Delta t_{p}\)/bit (ns) & \(\chi^{2}\)/ndf \\ \hline High Gain & 23.5 & 0.23 & 44.0 & 0.23 & 1.38 & 0.6 \\ Medium Gain & 21.7 & 0.21 & 42.9 & 0.30 & 1.42 & 0.23 \\ Low Gain & 24.1 & 0.18 & 46.8 & 0.31 & 1.52 & 1.1 \\ \hline Mixer G3 & 20.5 & 0.16 & 31.1 & 0.17 & 0.71 & 0.5 \\ Mixer G1 & 17.7 & 0.22 & 29 & 0.19 & 0.71 & 1.1 \\ \hline \end{tabular}
\end{table}
Table 2: Minimum and maximum peaking time to a step input for the three gains. The \(rms\) columns reflect the dispersion over 9 channels. The two right columns give the result of the linear fit shown in the figure below. The time constant is given by : \(\tau=t_{p}/1.82\)

Figure 20: Peaking time for the 16 switch settings. Measured with a step input.

was very high and the output impedance has been measured to be 1 00 \(\Omega\) whereas a 50 \(\Omega\) value was expected. The noise is in good agreement with the simulated values, taking into account the peaking time of 30 ns.

The signal and noise values were then measured with a preamp in front in order to compare with the calculated values from Fig. 3. A 27.5 \(\mu\)A signal was applied to a \(\emptyset\)T 'B' with \(C_{d}=1.33\) nF and a 3 meter 25 \(\Omega\) cable, corresponding to 10 GeV at \(\eta=0\) in the middle compartment. Similarly, a 5 GeV signal was applied to a \(\emptyset\)T 'A' with \(C_{d}=330\) pF to simulate the Front. In both cases, the noise was also measured. The results, referred to 1 GeV are shown in the Table below. They are lower than the expected values by \(\sim\)30%, due to lower preamp transimpedance19 (by \(\sim\)15%) and lower shaper gain20 (also by \(\sim\)15%).

Footnote 19: Actual \(R_{f}=2800\)\(\Omega\) for ‘A’ type and 850 \(\Omega\) for ‘B’ type

Footnote 20: The calculated [6] high gain is 0.271 x 15 x 5 x 5 = 101 but the Spice simulations, which include second order effects (such as finite open loop gain, opamp input and output impedance) give 90. The lower noise in the FRT is also due to the slower preamp risetime.

### Saturation behaviour

The saturation behaviour is measured with a \(\emptyset\)T 'B' preamp in front of the shaper and a triangular signal to simulate the liquid argon pulse.

\begin{table}
\begin{tabular}{|c||c|c|c|c|c|c|} \hline
1 GeV (2.75 \(\mu\)A) & \(C_{d}\) & \(V_{out}(\emptyset\)T) & \(V_{out}(\mathit{H}\mathit{G})\) & \(t_{p}\) & \(V_{n}\) (rms) & ENE \\ \hline FRT \(\emptyset\)T ‘A’ & 330 pF & 6.40 mV & 428 mV & 42.8 ns & 6.5 mV & 15 MeV \\ MID \(\emptyset\)T ‘B’ & 1.33 nF & 1.76 mV & 104 mV & 44.1 ns & 5.2 mV & 50 MeV \\ \hline \end{tabular}
\end{table}
Table 4: Signal measurement for 1 GeV (2.75 \(\mu\)A) input at the \(\emptyset\)T and High gain shaper output with \(\tau=15\) ns.

\begin{table}
\begin{tabular}{|c|c|c|} \hline V2 (\(t_{p}\)=30n s) & Gain & Noise (\(\mu\)V) \\ \hline High Gain & 81 \(\pm\) 0.68 & 854 \(\pm\) 7.7 \\ Medium Gain & 8.4 \(\pm\) 0.065 & 387 \(\pm\) 2.5 \\ Low Gain & 0.83 \(\pm\) 0.0054 & 248 \(\pm\) 3 \\ \hline Mixer G3 & 3.84 & 423 \\ Mixer G1 & 1.2 \(\pm\) 0.014 & 208 \\ \hline \end{tabular}
\end{table}
Table 3: Gain (for a step input) and Noise measured on the V2shaper with \(\tau=\)15 ns setting. Dispersions are \(rms\) values measured on 100 channels for the gain and 16 channels for the noise. The noise from the output driver (120 \(\mu\)V) has been substracted quadratically.

With saturated signals, the area is no longer zero. The net integral has been measured on the high gain output as a function of the input current and is shown in Fig. 22. The first dip (at 0.1 mA) corresponds to the saturation of the positive lobe in the output stage. The positive plateau reflects the limitation to -1.5 V of the negative undershoot21.

Footnote 21: This limitation is given by the 0.5 mA bias current in the output stage across the feedback load of 1.2 k\(\Omega\). This load could easily be increased by a factor of 2 to allow a larger negative output swing and recover zero area. However, this would violate the requirement from the pipeline not to pass its negative power supply.

Figure 21: Waveforms on the shaper V2 with saturated signals. The preamp is ty pe ’B’ (25 \(\Omega\)) with \(C_{d}\)=1.33nF. For the High gain, the input current steps are 0.05, 0.1, 0.2, 0.5, 1, 2 and 4 mA. The medium gain is shown with 0.5, 1, 2 and 4 mA input current.

### Frequency response

The frequency response has been measured in good agreement with simulated values. The low frequency cut-off is limited to -60 dB due to the finite output impedance of the output opamp.

The power supply rejection ratio has also been measured by superimposing a sinusoidal signal on top of the positive supply22. This ratio is not very large and as such a

Figure 23: Frequency response of the High gain shaper output.

Figure 22: Area of the saturated high gain output.

noise would be coherent over a whole crate, care should be taken to minimize it by following the ATLAS grounding rules [12]. The pseudo-differential connection to the pipeline using the _out_ref_ output can also further improve the low frequency noise rejection.

It is comparable to the figures obtained by simulation :

Figure 24: Positive power supply rejection at the high gain output.

Figure 25: Simulated rejection ratios for \(V_{DD}\) and \(V_{SS}\) (in dB)

### Linearity

The linearity is measured with a procedure similar to that used for the V1. The improvement on the medium gain due to the feedback transistor is very visible, comparing Fig. 15 and Fig. 26. Indeed, separate measurements have shown that the input impedance remains constant within \(\pm\) 2% over the full dynamic range.

### Crosstalk

The crosstalk is measured exactly as for the backup (_cf._3.4) The results are very similar, although better for the Medium gain.

Figure 26: Linearity of the shaper V2. Measurement with a \(\emptyset\)T B (25 \(\Omega\)) in front with \(C_{d}\) = 1.3 nF. The full scale on each gain gives 3 V at the shaper output and corresponds to 0.08, 0.8 and 8 mA (30, 300 and 3000 GeV)Figure 27: Crosstalk measurements of the shaper V2. The signal is applied to Channel 4 (solid line) and observed in channel 3 (dashed line), 2 (dots) and 1 (dash-dot). The top row corresponds to 1 V at the high gain output, the middle row corresponds to 1 V at the medium gain output, and the bottom row to 1 V at the low gain output. All the other channels are shown in mV.

### Linear Mixer

The linear mixer has also been measured as shown below. As the control logic was not connected to the switches, the FORSW inputs have been used. The typical feedthrough when a switch is OFF is around 0.2% (_cf._ Fig. 28). The uniformity between the four channels has been measured to be 1.2 % _rms_. The gains are 1.2-3.8 and the noise 0.2-0.4 mV, as shown in Table 3, in fair agreement with simulated values23. The linearity has been measured to be within \(\pm\) 1% over the full dynamic range.

Footnote 23: The gains in simulation are 1.45 and 4.85, close to calculations when the resistance of the switches (\(\thicksim\)200 \(\Omega\)) is taken into account. The noise in simulation is \(\thicksim\)300 \(\mu\)V for G1 and \(\thicksim\)500 \(\mu\)V for G3 in a 1 k\(\Omega\) load. The conversion into MeV is not straightforward, as the mixer output signal does not include the final RC shaping stage and pole-zero cancellation [1, 9]. It cannot be compared directly to the preamp noise in the same table.

Figure 28: Normal and saturated signals at the G3 linear mixer output, corresponding to \(I_{in}\) = 1 mA and 4 mA (360 and 1500 GeV). The dashed lines shows the signal (magnified by 1000) when the switch is OFF.

Figure 29: Linearity of the linear mixer V2 for the 2 gain settings.

Conclusion

The Mod0 shaper (V2) prototype has satisfied the requirements to equip the LAr calorimeter of ATLAS. 2000 chips will be produced at the beginning of 1998 (V2bis) to equip the 5000 channels necessary to scan Module 0 in testbeam.

### Summary

The characteristics of the various shapers produced so far are summarized in the table below. The versions V1bis, V2 and the forth coming V2bis are 100% pin-to-pin compatible24. The yield has been so far around 90% for both versions. The chip area is 18 mm 2.

Footnote 24: See footnote 6: The \(\emptyset\)T offset has been compensated for in the preamp hybrid. It could also have been performed by a resistor (\(\sim\)15 k\(\Omega\)) to Vss either in the shaper or on the Front-End board but may have not applied to all preamp types.

### Modifications for V2 bis. Schedule. Testing procedure.

The modifications accepted for the production of module 0 chips have been limited to the _strict minimum25_ :

Footnote 25: The \(\emptyset\)T offset has been compensated for in the preamp hybrid. It could also have been performed by a resistor (\(\sim\)15 k\(\Omega\)) to Vss either in the shaper or on the Front-End board but may have not applied to all preamp types.

* Connect the missing lines on the logic bus.
* Include the fuses on each switch for peaking time tuning, which will be burnt at testing phase to set \(\tau=15\) ns.

The circuit was submitted to AMS at the end of january and is expected back, packaged, for the beginning of may 98. The testing phase is expecting to last no more than one month.

The chips will be tested as follows26:

Footnote 26: The testing equipment is designed in lab around a digital oscilloscope and dedicated software. The tests themselves should be subcontracted to industry. The testing time is estimated to 10-30 sec/chip.

i) DC parameters : supply current, output offset voltages.

ii) Dynamic measurements : gain and peaking time on each gain for a step input and maximum output voltage.

iii) Peaking time adjustment : measure min and max peaking time on one channel and set the bits to achieve correct value. Check the peaking time obtained and blow the corresponding fuses.

iv) Linear mixer : peaking time and gain for the two gain settings with all the switches on. Functionnal test of the logic block.

\begin{table}
\begin{tabular}{|c||c|c|c|c|c|c|c|c|} \hline  & Marking & \# pieces & \(\tau\) (ns) & LG & MG & HG & MXR & \(P_{d}\) (mW) \\ \hline V1 & 96-004 & 70 & 15 & 1.4 & 6.9 & 69 & 2.5 & 850 \\ V1 bis & 8308-005 & 182 & 16 & 1.4 & 6.9 & 69 & 2.5 & 850 \\ V2 & 8308-006 & 7 + 120 & 12.7-24.5 & 0.8 & 8.4 & 81 & 1.2-3.8 & 500 \\ \hline \end{tabular}
\end{table}
Table 5: Main characteristics of the V1 and V2shapers

### Evolution towards ATLAS : V3

It may be necessary to perform a final iteration for ATLAS, after Module 0 results. It could include final gain values, a possibility to load the peaking time from the data bus27. It is also foreseen to perform irradation tests with larger statistics and ageing tests to ensure good reliability.

Footnote 27: This would allow a better hardware shaping time over the full rapidity coverage and could even include one more bit to extend the span.

## References

* [1] ATLAS Liquid Argon Calorimeter : Technical Design Report CERN/LHCC/96-41
* [2] W.E. Cleland, E.G. Stern "Signal processing considerations for liquid ionization calorimeters in high rate environment". NIM A338 (1994) 467-497
* [3] Y. Jacquier et al. ATLAS internal note **LArG-080**.
* [4] Austria Mikro System, Schloss Premstatten, A-8141 Unterpremstatten
* [5] LArG collaboration : Minutes of the first shaper design review. CERN 10/03/97. Available from the LAr Electronics convenors.
* [6] R.L. Chase, C. de La Taille, J.P. Richer, N. Seguin "A fast monolithic shaper for the ATLAS E.M. Calorimeter. ATLAS internal Note **LArG-010**
* [7] G. Battistoni et al. "Preamp Specifications" **LArG** note to appear.
* [8] S. Nicoleau " Desintegration du boson de Higgs en electrons et photons..." These de Doctorat Universite de Savoie. LAPP-T 97/02.
* [9] J. Teigeret al. "The LAr Tower Builder" **LArG** note to appear.
* [10] V. Tisserand "Optimisation du detecteur ATLAS pour la recherche du boson de Higgs se des integrant en deux photons" These de Doctorat. Univ Paris XI. LAL 97-01.
* [11] R.L. Chase et al. "A quad-gain monolithic shaper for fast LAr calorimetry. Balatonfured 1996
* [12] P. Farthouat, B. Williams "ATLAS grounding rules"